<?xml version="1.0" encoding="utf-8"?>
<abapGit version="v1.0.0" serializer="LCL_OBJECT_SFPI" serializer_version="v1.0.0">
 <asx:abap version="1.0" xmlns:asx="http://www.sap.com/abapxml">
  <asx:values>
   <VERSION>1</VERSION>
   <TYPE/>
   <INTERFACE href="#o1"/>
   <INTERFACET>
    <FPINTERFACET>
     <NAME/>
     <STATE/>
     <LANGUAGE>E</LANGUAGE>
     <ID/>
     <TEXT>Customer Invoice Form (Billing) Interface</TEXT>
    </FPINTERFACET>
   </INTERFACET>
  </asx:values>
  <asx:heap xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:abap="http://www.sap.com/abapxml/types/built-in" xmlns:cls="http://www.sap.com/abapxml/classes/global" xmlns:dic="http://www.sap.com/abapxml/types/dictionary">
   <cls:CL_FP_INTERFACE_DATA id="o1">
    <CL_FP_INTERFACE_DATA classVersion="1">
     <CODING href="#o5"/>
     <PARAMETERS href="#o4"/>
     <GLOBAL_DEFINITIONS href="#o3"/>
     <REFERENCE_FIELDS href="#o2"/>
     <XSD_DEFINITIONS/>
    </CL_FP_INTERFACE_DATA>
   </cls:CL_FP_INTERFACE_DATA>
   <cls:CL_FP_REFERENCE_FIELDS id="o2">
    <CL_FP_INTERFACE_DATA_CHANGED classVersion="1">
     <INTERFACE_DATA href="#o1"/>
    </CL_FP_INTERFACE_DATA_CHANGED>
    <CL_FP_REFERENCE_FIELDS classVersion="1">
     <REFERENCE_FIELDS/>
    </CL_FP_REFERENCE_FIELDS>
   </cls:CL_FP_REFERENCE_FIELDS>
   <cls:CL_FP_GLOBAL_DEFINITIONS id="o3">
    <CL_FP_INTERFACE_DATA_CHANGED classVersion="1">
     <INTERFACE_DATA href="#o1"/>
    </CL_FP_INTERFACE_DATA_CHANGED>
    <CL_FP_GLOBAL_DEFINITIONS classVersion="1">
     <GLOBAL_DATA>
      <SFPGDATA>
       <NAME>GV_EXCHG_RATE</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>UKURS_CURR</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>C_BMP</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>STRING</TYPENAME>
       <DEFAULTVAL>&apos;images/bmp&apos;</DEFAULTVAL>
       <CONSTANT>X</CONSTANT>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_DATE_FORMAT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR15</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_FORM_LANG</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>SPRAS</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_LOGO</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>XSTRING</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>X_SORG_ADD</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_ADDRESS</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_SALES_ORG_TEL_NUM</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>AD_TLNMBR</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BILLING_DOC_NAME</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR30</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_VBELN</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>VBELN</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_DUPLICATE_FLAG</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>XFELD</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BILLING_DATE</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR15</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_SALES_ORDER_INFO</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_T_SALES_ORDER_INFO</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CS_PHONE_IMAGE_FLAG</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>XFELD</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CS_PHONE_IMAGE</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>XSTRING</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CS_PHONE_STD_TXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TDOBNAME</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CS_EMAIL_STD_TXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TDOBNAME</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_INVOICE_HEADER</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_T_INVOICE_HEADER</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_INV_ITEMS</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_T_INV_ITEMS</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_ORIGINAL_INVOICE</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>VBELN</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_BILL_HEADER_TEXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME> TY_T_BILL_HEADER_TEXT</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_SUB_TOTAL</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_FREIGHT_CHARGES</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_HANDLING_CHARGES</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_INSURANCE_CHARGES</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_DOCUMENT_CHARGES</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BILL_DOC_CURRENCY</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>WAERK</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_NET_AMT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_TAX_AMT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_TOTAL_AMT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_DOWN_PAYMENT_FLAG</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME> CHAR1</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CURRENCY_DOWN_PAYMENT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>WAERK</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_DOWN_PAYMENT_AMT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_OUTSTANDING_AMT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_DOWN_PAYMENTS</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME> TY_T_DOWN_PAYMENTS</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_TAX_LEGAL_MENTION</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME> TY_T_STD_TEXTS</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BANK_NAME</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME> BANKA</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BANK_ADDRESS</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>STRAS_GP</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BANK_CITY</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>ORT01_GP</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BANK_ACCOUNT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR100</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BANK_BIC</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>SWIFT</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BANK_IBAN</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR45</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_VAT_SUMMARY</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_T_VAT_SUMMARY</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_PAYMENT_TERM_1</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR80</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_PAYMENT_TERM_2</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR80</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_PAYMENT_MODE</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR30</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>WA_GENERAL_PAY_TEXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_GENERAL_PAY_TEXT</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_LTEXT_SALES_STD_TXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TDOBNAME</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_ZVATNSF</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR25</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_TCSALES_STD_TXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TDOBNAME</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_VBRK</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_T_VBRK</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_BILL_HEADER_TXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_T_LINES</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_BANKADDR_FIRMA_CH</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>STRING</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CLEARING_ACC</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>STRING</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_PAYMENT_TERM_3</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR80</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_FREP_TEXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR70</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_HDATUM</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR15</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>I_PAYMENT_TERMS_1</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TY_T_LINES</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_ENVT_FEE</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR20</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_WATERMARK</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>XSTRING</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CUU_RA_FLAG</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>FLAG</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_INV_TEXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>FLAG</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_VAT_TEXT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>TEXT1_007S</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_SAP_REL</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>SIPT_PROD_VERSION</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CERT_ID</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>SIPT_CERT_ID</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_LIC_NO</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>LICNO</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_LIC_DATE</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR15</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_LIC</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR30</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_PRNUM</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>PRNUM_NR</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_VATAMT</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>MWSBP</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_CUR</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>WAERS</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
      <SFPGDATA>
       <NAME>GV_SERV_REND_FLAG</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>CHAR1</TYPENAME>
       <DEFAULTVAL/>
       <CONSTANT/>
      </SFPGDATA>
     </GLOBAL_DATA>
     <TYPES>
      <FPCLINE>************************************************************************</FPCLINE>
      <FPCLINE>* PROGRAM    :  ZOTC0014_CUST_INVOICE_FORM_INT                         *</FPCLINE>
      <FPCLINE>* TITLE      :  Customer Invoice Form (Billing) Interface              *</FPCLINE>
      <FPCLINE>* DEVELOPER  :  MUHAMMED SYED                                          *</FPCLINE>
      <FPCLINE>* OBJECT TYPE:  Interface (Form)                                       *</FPCLINE>
      <FPCLINE>* SAP RELEASE:  SAP ECC 6.0                                            *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* WRICEF ID:  D3_OTC_FDD_0014_Customer Invoice Form - (Billing)</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* DESCRIPTION: SHORT DESCRIPTION OF FUNCTIONALITY                      *</FPCLINE>
      <FPCLINE>* Invoice Form Billing Via T-COdes VF31/VF01/VF02/VF03                 *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* MODIFICATION HISTORY:                                                *</FPCLINE>
      <FPCLINE>*======================================================================*</FPCLINE>
      <FPCLINE>* DATE        USER      TRANSPORT  DESCRIPTION                         *</FPCLINE>
      <FPCLINE>* =========== ========  ========== ====================================*</FPCLINE>
      <FPCLINE>* 16-Sep-2016 KMISHRA   E1DK921455 INITIAL DEVELOPMENT                 *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 01-Dec-2016 SGHOSH    E1DK921455 Defect#6829(CR)- I.Logic Changed for*</FPCLINE>
      <FPCLINE>*                                  Ship To Address only for Plant      *</FPCLINE>
      <FPCLINE>*                                  Abroad Billing document(ZWIA Billing*</FPCLINE>
      <FPCLINE>*                                  type).                              *</FPCLINE>
      <FPCLINE>*                                  II. Logic Changed for Tax Rate, Tax *</FPCLINE>
      <FPCLINE>*                                  Legal Mention &amp; Tax Reporting Country</FPCLINE>
      <FPCLINE>*                                  III. 2 EMI Criteria&apos;s created for new</FPCLINE>
      <FPCLINE>*                                  Tax logic                           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 12-Oct-2017 U034334   E1DK931103 D3R2 Changes                        *</FPCLINE>
      <FPCLINE>* 1. Fetch and print GLN for Bill-to, Sold-to &amp; Ship-to party.         *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 05-Feb-2018 U034334   E1DK931103 D3R3 Changes                        *</FPCLINE>
      <FPCLINE>* 1. Print Contact name from AP/ZA partner, whichever is maintained    *</FPCLINE>
      <FPCLINE>************************************************************************</FPCLINE>
      <FPCLINE>* 08-Mar-2018 U024694   E1DK931103 D3R3.04 Changes (Tag: D3R3.04)      *</FPCLINE>
      <FPCLINE>* 1. Print text when billing item is FOC                               *</FPCLINE>
      <FPCLINE>* 2. Print Stamp Duty for certain tax codes                            *</FPCLINE>
      <FPCLINE>* Note: Both these requirements are for Italy only                     *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 17-May-2018 U033876   E1DK936750 D3R3.08 Changes                     *</FPCLINE>
      <FPCLINE>* Print the license number and license granted date                    *</FPCLINE>
      <FPCLINE>* Note: this requirements are for Italy only                           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 01-AUG-2018 U033632  E1DK938034 D3R3 Def#6737 Changes               *</FPCLINE>
      <FPCLINE>* 1. Update Portuguese footer with VAT variable                        *</FPCLINE>
      <FPCLINE>* 2. Add 3rd position of GLN                                           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*29-AUG-2018 U033632/DDWIVEDI E1DK938541 D3R3 Incident#INC0432585      *</FPCLINE>
      <FPCLINE>* Added new column Service rendered date in VAT Summary Table based    *</FPCLINE>
      <FPCLINE>* on EMI check                                                         *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 26-Feb-2019  amangal E2DK922026  R.1 Various Updates                 *</FPCLINE>
      <FPCLINE>*                                                                      *</FPCLINE>
      <FPCLINE>*                    GE – Approved 28-Jan-2019                         *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0781062: AB Serotec WRICEF - Customer    *</FPCLINE>
      <FPCLINE>*                        Invoice                                       *</FPCLINE>
      <FPCLINE>*                    PE – Pending approval PCR 517                     *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0787285                                  *</FPCLINE>
      <FPCLINE>*                    -  Out of country invoices, country name in       *</FPCLINE>
      <FPCLINE>*                       English r6.1(Esker correction)                 *</FPCLINE>
      <FPCLINE>*                    PE – PCR 515                                      *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0762126                                  *</FPCLINE>
      <FPCLINE>*                    -  Italy SO10 Text Update Tax codes               *</FPCLINE>
      <FPCLINE>*                    PE – 516                                          *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0736194 : Spain “Special text” for       *</FPCLINE>
      <FPCLINE>*                        Canary Islands                                *</FPCLINE>
      <FPCLINE>************************************************************************</FPCLINE>
      <FPCLINE/>
      <FPCLINE>TYPES:</FPCLINE>
      <FPCLINE>  BEGIN OF ty_doc_num,</FPCLINE>
      <FPCLINE>    vbeln TYPE vbeln,                &quot; Sales and Distribution Document Number</FPCLINE>
      <FPCLINE>  END OF ty_doc_num,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_vbpa,</FPCLINE>
      <FPCLINE>    vbeln	TYPE vbeln,</FPCLINE>
      <FPCLINE>    posnr TYPE posnr,                &quot; Item number of the SD document</FPCLINE>
      <FPCLINE>    parvw	TYPE parvw,</FPCLINE>
      <FPCLINE>    kunnr TYPE kunnr,                &quot; Customer Number</FPCLINE>
      <FPCLINE>    adrnr	TYPE adrnr,</FPCLINE>
      <FPCLINE>    land1	TYPE land1,                &quot; Country Key</FPCLINE>
      <FPCLINE>  END OF ty_vbpa,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_konv,</FPCLINE>
      <FPCLINE>    kschl TYPE kscha,                &quot; Condition type</FPCLINE>
      <FPCLINE>    kposn	TYPE kposn,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>    kdatu type kdatu,&quot;Condition pricing date</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>    kawrt	TYPE kawrt,</FPCLINE>
      <FPCLINE>    kbetr	TYPE kbetr,</FPCLINE>
      <FPCLINE>    kwert	TYPE kwert,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>    knumh TYPE knumh,</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>    mwsk1	TYPE mwskz,</FPCLINE>
      <FPCLINE>    kinak	TYPE kinak,</FPCLINE>
      <FPCLINE>    koaid	TYPE koaid,</FPCLINE>
      <FPCLINE>  END OF ty_konv,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_vbrp,</FPCLINE>
      <FPCLINE>    vbeln	TYPE vbeln_vf,</FPCLINE>
      <FPCLINE>    posnr TYPE posnr_vf,             &quot; Billing item</FPCLINE>
      <FPCLINE>    netwr	TYPE netwr_fp,</FPCLINE>
      <FPCLINE>    vgbel	TYPE vgbel,</FPCLINE>
      <FPCLINE>    abrbg	TYPE abrbg,</FPCLINE>
      <FPCLINE>    fplnr	TYPE fplnr,</FPCLINE>
      <FPCLINE>    fpltr	TYPE fpltr,</FPCLINE>
      <FPCLINE>    mwsbp	TYPE mwsbp,</FPCLINE>
      <FPCLINE>    fareg TYPE fareg,                &quot; Rule in billing plan/invoice plan</FPCLINE>
      <FPCLINE>  END OF ty_vbrp,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_address,</FPCLINE>
      <FPCLINE>    line1 TYPE lines,                &quot; Address line</FPCLINE>
      <FPCLINE>    line2 TYPE lines,                &quot; Address line</FPCLINE>
      <FPCLINE>    line3 TYPE lines,                &quot; Address line</FPCLINE>
      <FPCLINE>    line4 TYPE lines,                &quot; Address line</FPCLINE>
      <FPCLINE>    line5 TYPE lines,                &quot; Address line</FPCLINE>
      <FPCLINE>  END OF ty_address,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_sales_order_info,</FPCLINE>
      <FPCLINE>    aubel	TYPE vbeln_va,</FPCLINE>
      <FPCLINE>    bstkd TYPE bstkd,                &quot; Customer purchase order number</FPCLINE>
      <FPCLINE>  END OF ty_sales_order_info,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_invoice_header,</FPCLINE>
      <FPCLINE>    aubel	            TYPE vbeln_va, &quot; Sales Document</FPCLINE>
      <FPCLINE>    bill_to_kunnr     TYPE kunnr,    &quot; Customer Number</FPCLINE>
      <FPCLINE>    bill_to_add       TYPE fsbp_address_printf_line_tty,</FPCLINE>
      <FPCLINE>    sold_to_kunnr     TYPE kunnr,    &quot; Customer Number</FPCLINE>
      <FPCLINE>    sold_to_add       TYPE fsbp_address_printf_line_tty,</FPCLINE>
      <FPCLINE>    ship_to_kunnr     TYPE kunnr,    &quot; Customer Number</FPCLINE>
      <FPCLINE>    ship_to_add       TYPE fsbp_address_printf_line_tty,</FPCLINE>
      <FPCLINE>    stceg             TYPE stceg,    &quot; VAT Registration Number</FPCLINE>
      <FPCLINE>    other_tax_numbers TYPE string,</FPCLINE>
      <FPCLINE>    inco1             TYPE inco1,    &quot; Incoterms (Part 1)</FPCLINE>
      <FPCLINE>    inco2             TYPE inco2,    &quot; Incoterms (Part 2)</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>*    bill_to_gln       TYPE char12, &quot; GLN for Bill-to</FPCLINE>
      <FPCLINE>* ---&gt; End of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>* ---&gt; Begin of insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>     bill_to_gln       TYPE char13, &quot; GLN for Bill-to</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>    sold_to_gln       TYPE char12, &quot; GLN for Sold-to</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>*    ship_to_gln       TYPE char12, &quot; GLN for Ship-to</FPCLINE>
      <FPCLINE>* ---&gt; End of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>* ---&gt; Begin of insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>    ship_to_gln       TYPE char13, &quot; GLN for Ship-to</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>    contact_name      TYPE ad_name1, &quot; Name 1</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>  END OF ty_invoice_header,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_inv_items,</FPCLINE>
      <FPCLINE>    aubel              TYPE vbeln_va,                  &quot; Sales Document</FPCLINE>
      <FPCLINE>    bstkd              TYPE bstkd,                     &quot; Customer purchase order number</FPCLINE>
      <FPCLINE>    posnr              TYPE char08,                    &quot; Billing item</FPCLINE>
      <FPCLINE>    matnr              TYPE matnr,                     &quot; Material Number</FPCLINE>
      <FPCLINE>    fkimg              TYPE char15,                    &quot; Actual Invoiced Quantity</FPCLINE>
      <FPCLINE>    fkimg_tmp          TYPE fkimg,                     &quot; Actual Invoiced Quantity</FPCLINE>
      <FPCLINE>    vrkme              TYPE vrkme,                     &quot; Sales unit</FPCLINE>
      <FPCLINE>    arktx              TYPE arktx,                     &quot; Short text for sales order item</FPCLINE>
      <FPCLINE>    unit_price         TYPE char20,                    &quot; Unit Price</FPCLINE>
      <FPCLINE>    amount             TYPE char20,                    &quot; Amount</FPCLINE>
      <FPCLINE>    amount_tmp         TYPE kzwi1,                     &quot; Amount</FPCLINE>
      <FPCLINE>    kbetr	             TYPE char10,                    &quot; Tax Rate</FPCLINE>
      <FPCLINE>    batch_numbers      TYPE zotc_0014_t_inv_items_batch,</FPCLINE>
      <FPCLINE>    serial_numbers     TYPE zotc_0014_t_sernr,         &quot; Serial Number</FPCLINE>
      <FPCLINE>    kdmat	             TYPE matnr_ku,                  &quot; Customer Material Number</FPCLINE>
      <FPCLINE>    del_info           TYPE string,                    &quot; Delivery Info</FPCLINE>
      <FPCLINE>    bill_dates         TYPE string,</FPCLINE>
      <FPCLINE>    bill_item_std_text TYPE tdobname,                  &quot; Text Lines</FPCLINE>
      <FPCLINE>    bom_components     TYPE zotc_0014_t_inv_bom_items, &quot; BOM Components for Invoice Items</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>    foc_flag           TYPE flag,                      &quot; Free of Cost flag</FPCLINE>
      <FPCLINE>    item_txt           TYPE flag,                      &quot; Free of Cost flag</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>  END OF ty_inv_items,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_bill_header_text,</FPCLINE>
      <FPCLINE>    tdobject TYPE tdobject,                            &quot; Texts: Application Object</FPCLINE>
      <FPCLINE>    tdname   TYPE tdobname,                            &quot; Name</FPCLINE>
      <FPCLINE>    tdid     TYPE tdid,                                &quot; Text ID</FPCLINE>
      <FPCLINE>  END OF ty_bill_header_text,</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_down_payments,</FPCLINE>
      <FPCLINE>    document_date TYPE string,</FPCLINE>
      <FPCLINE>    amount        TYPE char20,                         &quot; Net Value in Document Currency</FPCLINE>
      <FPCLINE>  END OF ty_down_payments,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_std_texts,</FPCLINE>
      <FPCLINE>    std_text TYPE tdobname,                            &quot; Name</FPCLINE>
      <FPCLINE>  END OF ty_std_texts,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_vat_summary,</FPCLINE>
      <FPCLINE>    text1 TYPE text1_007s,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>    kdatu type kdatu, &quot;Condition pricing date</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>    kbetr	TYPE char10,</FPCLINE>
      <FPCLINE>    kawrt  TYPE char20,</FPCLINE>
      <FPCLINE>    kwert  TYPE char20,</FPCLINE>
      <FPCLINE>  END OF ty_vat_summary,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF ty_general_pay_text,</FPCLINE>
      <FPCLINE>    spras    TYPE spras,                               &quot; Language Key</FPCLINE>
      <FPCLINE>    std_text TYPE tdobname,                            &quot; Name</FPCLINE>
      <FPCLINE>  END OF ty_general_pay_text,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    BEGIN OF ty_vbrk,</FPCLINE>
      <FPCLINE>      vbeln TYPE vbeln_vf,  &quot; Billing Document</FPCLINE>
      <FPCLINE>      fkart TYPE fkart,     &quot; Billing Type</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>      knumv TYPE knumv,</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>      zzrland TYPE zzrland, &quot; Tax Reporting Country</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>      zzvatnsf type stceg, &quot;VAT Registration Number</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>** Begin of R.1</FPCLINE>
      <FPCLINE>      vkorg type vkorg,</FPCLINE>
      <FPCLINE>** End of R.1</FPCLINE>
      <FPCLINE>    END OF ty_vbrk,</FPCLINE>
      <FPCLINE>    ty_t_vbrk TYPE STANDARD TABLE OF ty_vbrk,</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>    BEGIN OF ty_kna1,</FPCLINE>
      <FPCLINE>      kunnr TYPE kunnr, &quot; Customer Number</FPCLINE>
      <FPCLINE>      bbbnr TYPE bbbnr, &quot; International location number  (part 1)</FPCLINE>
      <FPCLINE>      bbsnr TYPE bbsnr, &quot; International location number (Part 2)</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 Def# 6737 by U033632</FPCLINE>
      <FPCLINE>      bubkz type bubkz, &quot;Check unit</FPCLINE>
      <FPCLINE>* ---&gt; end of Insert for D3_OTC_FDD_0014 Def# 6737 by U033632</FPCLINE>
      <FPCLINE>    END OF ty_kna1,</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>    BEGIN OF ty_tvap,</FPCLINE>
      <FPCLINE>      pstyv TYPE pstyv, &quot; Sales document item category</FPCLINE>
      <FPCLINE>      prsfd TYPE prsfd, &quot; Carry out pricing</FPCLINE>
      <FPCLINE>    END OF ty_tvap,</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ty_t_emi_constants    type standard table of zdev_enh_status, &quot; Enhancement Status</FPCLINE>
      <FPCLINE>ty_t_doc_num          type standard table of ty_doc_num,</FPCLINE>
      <FPCLINE>ty_t_vbpa             type standard table of ty_vbpa,</FPCLINE>
      <FPCLINE>ty_t_konv             type standard table of ty_konv,</FPCLINE>
      <FPCLINE>ty_t_vbrp             type standard table of ty_vbrp,</FPCLINE>
      <FPCLINE>ty_t_sales_order_info type standard table of ty_sales_order_info,</FPCLINE>
      <FPCLINE>ty_t_invoice_header   type standard table of ty_invoice_header,</FPCLINE>
      <FPCLINE>ty_t_inv_items        type standard table of ty_inv_items,</FPCLINE>
      <FPCLINE>ty_t_bill_header_text type standard table of ty_bill_header_text,</FPCLINE>
      <FPCLINE>ty_t_down_payments    type standard table of ty_down_payments,</FPCLINE>
      <FPCLINE>ty_t_std_texts        type standard table of ty_std_texts,</FPCLINE>
      <FPCLINE>ty_t_vat_summary      type standard table of ty_vat_summary,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>ty_t_lines            type standard table of tline, &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>ty_t_kna1             type standard table of ty_kna1.</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
     </TYPES>
     <FIELDSYMBOLS/>
    </CL_FP_GLOBAL_DEFINITIONS>
   </cls:CL_FP_GLOBAL_DEFINITIONS>
   <cls:CL_FP_PARAMETERS id="o4">
    <CL_FP_INTERFACE_DATA_CHANGED classVersion="1">
     <INTERFACE_DATA href="#o1"/>
    </CL_FP_INTERFACE_DATA_CHANGED>
    <CL_FP_PARAMETERS classVersion="1">
     <IMPORT_PARAMETERS>
      <SFPIOPAR>
       <NAME>IM_BIL_PRT_COM</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>INVOICE_S_PRT_INTERFACE</TYPENAME>
       <OPTIONAL/>
       <BYVALUE/>
       <DEFAULTVAL/>
       <STANDARD/>
       <CONSTANT/>
      </SFPIOPAR>
      <SFPIOPAR>
       <NAME>IM_NAST</NAME>
       <TYPING>TYPE</TYPING>
       <TYPENAME>NAST</TYPENAME>
       <OPTIONAL/>
       <BYVALUE/>
       <DEFAULTVAL/>
       <STANDARD/>
       <CONSTANT/>
      </SFPIOPAR>
     </IMPORT_PARAMETERS>
     <EXPORT_PARAMETERS/>
     <TABLE_PARAMETERS/>
     <EXCEPTIONS/>
    </CL_FP_PARAMETERS>
   </cls:CL_FP_PARAMETERS>
   <cls:CL_FP_CODING id="o5">
    <CL_FP_INTERFACE_DATA_CHANGED classVersion="1">
     <INTERFACE_DATA href="#o1"/>
    </CL_FP_INTERFACE_DATA_CHANGED>
    <CL_FP_CODING classVersion="1">
     <INPUT_PARAMETERS>
      <FPPARAMETER>GV_INV_TEXT</FPPARAMETER>
      <FPPARAMETER>GV_VATAMT</FPPARAMETER>
      <FPPARAMETER>GV_CUR</FPPARAMETER>
      <FPPARAMETER>GV_EXCHG_RATE</FPPARAMETER>
     </INPUT_PARAMETERS>
     <OUTPUT_PARAMETERS>
      <FPPARAMETER>R.1</FPPARAMETER>
      <FPPARAMETER>GV_CUR</FPPARAMETER>
      <FPPARAMETER>GV_EXCHG_RATE</FPPARAMETER>
     </OUTPUT_PARAMETERS>
     <INITIALIZATION>
      <FPCLINE>************************************************************************</FPCLINE>
      <FPCLINE>* PROGRAM    :  ZOTC0014_CUST_INVOICE_FORM_INT                         *</FPCLINE>
      <FPCLINE>* TITLE      :  Customer Invoice Form (Billing) Interface              *</FPCLINE>
      <FPCLINE>* DEVELOPER  :  MUHAMMED SYED                                          *lv_spras</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* OBJECT TYPE:  FORM (Interface)                                       *</FPCLINE>
      <FPCLINE>* SAP RELEASE:  SAP ECC 6.0                                            *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* WRICEF ID:  D3_OTC_FDD_0014_Customer Invoice Form - (Billing)</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* DESCRIPTION: Interface for Invoice Form Billing                      *</FPCLINE>
      <FPCLINE>*               Via T-COdes VF31/VF01/VF02/VF03                        *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* MODIFICATION HISTORY:                                                *</FPCLINE>
      <FPCLINE>*======================================================================*</FPCLINE>
      <FPCLINE>* DATE        USER      TRANSPORT  DESCRIPTION                         *</FPCLINE>
      <FPCLINE>* =========== ========  ========== ====================================*</FPCLINE>
      <FPCLINE>* 16-Sep-2016 KMISHRA/  E1DK921455 INITIAL DEVELOPMENT                 *</FPCLINE>
      <FPCLINE>*            Muhammed Syed                                             *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 27-Oct-2016 Muhammed  E1DK921455 Defect 5678                         *</FPCLINE>
      <FPCLINE>*              Syed                                                    *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 01-Dec-2016 SGHOSH    E1DK921455 Defect#6829(CR)- I.Logic Changed for*</FPCLINE>
      <FPCLINE>*                                  Ship To Address only for Plant      *</FPCLINE>
      <FPCLINE>*                                  Abroad Billing document(ZWIA Billing*</FPCLINE>
      <FPCLINE>*                                  type).                              *</FPCLINE>
      <FPCLINE>*                                  II. Logic Changed for Tax Rate, Tax *</FPCLINE>
      <FPCLINE>*                                  Legal Mention &amp; Tax Reporting Country</FPCLINE>
      <FPCLINE>*                                  III. 2 EMI Criteria&apos;s created for new</FPCLINE>
      <FPCLINE>*                                  Tax logic                           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 04-Jan-2017 NALI      E1DK921455 Defect 7129 – CR 301                *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 08-May-2017 SMUKHER4  E1DK927655 Defect# 2720 - APAC Subsidiaries    *</FPCLINE>
      <FPCLINE>*                                  outputs do not print the correct    *</FPCLINE>
      <FPCLINE>*                                  amounts even though in the system is*</FPCLINE>
      <FPCLINE>*                                  correct due to the decimal          *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 12-Oct-2017 U034334   E1DK931103 D3R2 Changes (For Nordic Sales Orgs)*</FPCLINE>
      <FPCLINE>* 1. Print GLN for Bill-to, Sold-to &amp; Ship-to party.                   *</FPCLINE>
      <FPCLINE>* 2. Print Environmental Fee value for pricing condition ZENV.         *</FPCLINE>
      <FPCLINE>* 3. For Company Code 1024 and 2000 if Bio-Rad VAT No. starts with &apos;CH&apos;*</FPCLINE>
      <FPCLINE>*    print the suffix &quot;MWST&quot; with this VAT no.                         *</FPCLINE>
      <FPCLINE>* 4. Print the watermark &apos;Draft&apos; on the form in all systems except PROD*</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 05-Feb-2018 U034334   E1DK931103 D3R3 Changes                        *</FPCLINE>
      <FPCLINE>* 1. GLN not required for Sold-To party                                *</FPCLINE>
      <FPCLINE>* 2. Print contact name from AP/ZA partner, whichever is maintained    *</FPCLINE>
      <FPCLINE>* 3. Print Certification Details in invoice footer                     *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 08-Mar-2018 U024694   E1DK931103 D3R3.04 Changes (Tag: D3R3.04)      *</FPCLINE>
      <FPCLINE>* 1. Print text when billing item is FOC                               *</FPCLINE>
      <FPCLINE>* 2. Print Stamp Duty for certain tax codes                            *</FPCLINE>
      <FPCLINE>* Note: Both these requirements are for Italy only                     *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 12-Mar-2018 U024694   E1DK931103 D3R3.05 Def#5144 Changes (Tag: D3R3.05)*</FPCLINE>
      <FPCLINE>* Do not print Print Legal Mention for Tax codes when when the condition*</FPCLINE>
      <FPCLINE>* base   value = 0.00  This requirement is for Italy only              *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 01-AUG-2018 U033632  E1DK938034 D3R3 Def#6736 Changes                *</FPCLINE>
      <FPCLINE>* 1. Do not print VAT Summary Text                                     *</FPCLINE>
      <FPCLINE>* 2. Print VAT Line</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 26-Feb-2019  amangal E2DK922026  R.1 Various Updates                 *</FPCLINE>
      <FPCLINE>*                                                                      *</FPCLINE>
      <FPCLINE>*                    GE – Approved 28-Jan-2019                         *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0781062: AB Serotec WRICEF - Customer    *</FPCLINE>
      <FPCLINE>*                        Invoice                                       *</FPCLINE>
      <FPCLINE>*                    PE – Pending approval PCR 517                     *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0787285                                  *</FPCLINE>
      <FPCLINE>*                    -  Out of country invoices, country name in       *</FPCLINE>
      <FPCLINE>*                       English r6.1(Esker correction)                 *</FPCLINE>
      <FPCLINE>*                    PE – PCR 515                                      *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0762126                                  *</FPCLINE>
      <FPCLINE>*                    -  Italy SO10 Text Update Tax codes               *</FPCLINE>
      <FPCLINE>*                    PE – 516                                          *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0736194 : Spain “Special text” for       *</FPCLINE>
      <FPCLINE>*                        Canary Islands</FPCLINE>
      <FPCLINE>*                    Appdev task SCTASK0793196                              *</FPCLINE>
      <FPCLINE>************************************************************************</FPCLINE>
      <FPCLINE/>
      <FPCLINE>CONSTANTS:</FPCLINE>
      <FPCLINE>  lc_enh_criteria_date TYPE z_criteria VALUE &apos;DATE&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE>  lc_enh_criteria_canarias   TYPE z_criteria VALUE &apos;CANARIAS &apos;,</FPCLINE>
      <FPCLINE>  lc_tdid          TYPE tdid       VALUE &apos;ST&apos;,                          &quot; Text ID</FPCLINE>
      <FPCLINE>  lc_tdspras       TYPE spras      VALUE &apos;EN&apos;,                          &quot; Language Key</FPCLINE>
      <FPCLINE>  lc_tdobject      TYPE tdobject   VALUE &apos;TEXT&apos;,</FPCLINE>
      <FPCLINE>  lc_text_canarias TYPE tdobname   VALUE &apos;ZOTC_0014_CANARIAS&apos;,</FPCLINE>
      <FPCLINE>** End of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>  lc_prod_name   TYPE rvari_vnam VALUE &apos;ZPRODUCTION&apos;, &quot; ABAP: Name of Variant Variable</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>  lc_koaid_taxes        TYPE koaid    VALUE &apos;D&apos;,          &quot; Condition class</FPCLINE>
      <FPCLINE>  lc_enh_criteria_vkorg TYPE z_criteria VALUE &apos;VKORG_D3&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>  lc_enh_criteria_mwskz TYPE z_criteria VALUE &apos;MWSKZ&apos;,    &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>  lc_enh_criteria_kbetr TYPE z_criteria VALUE &apos;KBETR&apos;,    &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>   lc_enh_crit_vkorg    TYPE z_criteria VALUE &apos;VKORG_LIC&apos;. &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE/>
      <FPCLINE>DATA:</FPCLINE>
      <FPCLINE>  lv_zlsch        TYPE schzw_bseg, &quot; Payment Method</FPCLINE>
      <FPCLINE>  lv_comp_land1   TYPE land1,      &quot; Country Key</FPCLINE>
      <FPCLINE>  lv_billto_land1 TYPE land1,      &quot; Country Key</FPCLINE>
      <FPCLINE>  lv_zzrland      TYPE land1,      &quot; Country Key</FPCLINE>
      <FPCLINE>  lv_total_amt    TYPE netwr,      &quot; Net Value in Document Currency</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>  lv_zvatnsf      TYPE stceg,   &quot; VAT Registration Number</FPCLINE>
      <FPCLINE>  lv_prod         TYPE sysysid, &quot; Name of the SAP System</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>   lv_lic_dat     TYPE licdt, &quot; Date license granted</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>  lv_comp_waers TYPE waers,     &quot; SD Document Currency</FPCLINE>
      <FPCLINE>  lv_waerk TYPE waerk,          &quot; SD Document Currency</FPCLINE>
      <FPCLINE>  lv_mwsbk TYPE mwsbp,          &quot; Tax amount in document currency</FPCLINE>
      <FPCLINE>  lv_fkdat TYPE fkdat,          &quot; Billing date for billing index and printout</FPCLINE>
      <FPCLINE>  lv_cont_kurst TYPE kurst_005, &quot; Exchange Rate Type for Translation into Country Currency</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE>  lv_adrnr TYPE ad_addrnum,</FPCLINE>
      <FPCLINE>  lv_region TYPE regio,</FPCLINE>
      <FPCLINE>  lwa_line   TYPE tline,</FPCLINE>
      <FPCLINE>  li_lines   TYPE tline_t,</FPCLINE>
      <FPCLINE>  lv_country TYPE land,</FPCLINE>
      <FPCLINE>  lv_vkorg TYPE vkorg,</FPCLINE>
      <FPCLINE>  lv_land1 TYPE land1,</FPCLINE>
      <FPCLINE>  lv_spras TYPE spras,</FPCLINE>
      <FPCLINE>  lv_spras_salesorg TYPE spras,</FPCLINE>
      <FPCLINE>  lv_spras_billto TYPE spras,</FPCLINE>
      <FPCLINE>  lv_country_billto TYPE land1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>** End of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE/>
      <FPCLINE>DATA:</FPCLINE>
      <FPCLINE>  lwa_emi_constants    TYPE zdev_enh_status,           &quot; Enhancement Status</FPCLINE>
      <FPCLINE>  lwa_bill_item_detail TYPE invoice_s_prt_item_detail, &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE>  lwa_invoice_header   TYPE ty_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>DATA:</FPCLINE>
      <FPCLINE>  li_emi_constants TYPE ty_t_emi_constants, &quot; Enhancement Status</FPCLINE>
      <FPCLINE>  li_item_detail   TYPE invoice_t_prt_item_detail,</FPCLINE>
      <FPCLINE>  li_doc_num       TYPE ty_t_doc_num,</FPCLINE>
      <FPCLINE>  li_vbpa          TYPE ty_t_vbpa,</FPCLINE>
      <FPCLINE>  li_konv          TYPE ty_t_konv,</FPCLINE>
      <FPCLINE>  li_vbrp          TYPE ty_t_vbrp,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>  li_header_cond   TYPE komvd_t, &quot;Internal table for Price Determination Communication-Cond.Record</FPCLINE>
      <FPCLINE>  lwa_header_cond  TYPE komvd.   &quot; Workarea for Price Determination Communication-Cond.Record</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE>FIELD-SYMBOLS: &lt;fs_vbpa&gt; TYPE ty_vbpa,</FPCLINE>
      <FPCLINE>               &lt;fs_vbrk&gt; TYPE ty_vbrk.</FPCLINE>
      <FPCLINE>** End of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get EMI Values</FPCLINE>
      <FPCLINE>PERFORM f_get_emi_values CHANGING li_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Determine Form Language</FPCLINE>
      <FPCLINE>PERFORM f_form_language USING /1bcdwb/docparams-langu.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Date format from EMI</FPCLINE>
      <FPCLINE>READ TABLE li_emi_constants INTO lwa_emi_constants</FPCLINE>
      <FPCLINE>                           WITH KEY criteria = lc_enh_criteria_date.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>  gv_date_format = lwa_emi_constants-sel_low.</FPCLINE>
      <FPCLINE>ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*&amp;--Assigning the korean currency to the european currency globally through the form</FPCLINE>
      <FPCLINE>* as per the requirement.</FPCLINE>
      <FPCLINE>gv_bill_doc_currency = im_bil_prt_com-head_detail-vbdkr-waerk.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* Check if Production Client</FPCLINE>
      <FPCLINE>SELECT low    &quot; ABAP/4: Selection value (LOW or HIGH value, external format)</FPCLINE>
      <FPCLINE>  FROM tvarvc &quot; Table of Variant Variables (Client-Specific)</FPCLINE>
      <FPCLINE>    UP TO 1 ROWS</FPCLINE>
      <FPCLINE>  INTO lv_prod</FPCLINE>
      <FPCLINE> WHERE name = lc_prod_name.</FPCLINE>
      <FPCLINE>ENDSELECT.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>IF sy-subrc EQ 0 AND</FPCLINE>
      <FPCLINE>   sy-sysid NE lv_prod.</FPCLINE>
      <FPCLINE>* For non-prod systems, get the Draft Watermark Image</FPCLINE>
      <FPCLINE>  PERFORM f_get_draft_image CHANGING gv_watermark.</FPCLINE>
      <FPCLINE>ENDIF. &quot; IF sy-subrc EQ 0 AND</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* New logic for VAT number for company code 2000 (CH)in D3R2</FPCLINE>
      <FPCLINE>** Get Invoice Header Data</FPCLINE>
      <FPCLINE>*SELECT SINGLE zlsch    &quot; Payment Method</FPCLINE>
      <FPCLINE>*              zzvatnsf &quot; VAT Registration Number</FPCLINE>
      <FPCLINE>*  FROM vbrk            &quot; Billing Document: Header Data</FPCLINE>
      <FPCLINE>*  INTO (lv_zlsch,gv_zvatnsf)</FPCLINE>
      <FPCLINE>*  WHERE vbeln EQ im_bil_prt_com-head_detail-vbdkr-vbeln.</FPCLINE>
      <FPCLINE>* ---&gt; End   of Delete for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>*Below query is commented as new query is written with new fields like Document currency, Billing date</FPCLINE>
      <FPCLINE>* Get Payment Method, Tax Reporting Country, Bio-Rad VAT</FPCLINE>
      <FPCLINE>*SELECT SINGLE zlsch    &quot; Payment Method</FPCLINE>
      <FPCLINE>*              zzrland  &quot; Tax Reporting Country</FPCLINE>
      <FPCLINE>*              zzvatnsf &quot; VAT Registration Number</FPCLINE>
      <FPCLINE>*         FROM vbrk     &quot; Billing Document: Header Data</FPCLINE>
      <FPCLINE>*         INTO (lv_zlsch, lv_zzrland, lv_zvatnsf)</FPCLINE>
      <FPCLINE>*        WHERE vbeln = im_bil_prt_com-head_detail-vbdkr-vbeln.</FPCLINE>
      <FPCLINE>* ---&gt; End of delete for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>* Get SD Document Currency, Billing date, Payment Method, Tax Reporting Country, Bio-Rad VAT</FPCLINE>
      <FPCLINE>SELECT SINGLE waerk  &quot; SD Document Currency</FPCLINE>
      <FPCLINE>              fkdat  &quot; Billing date for billing index and printout</FPCLINE>
      <FPCLINE>              zlsch  &quot; Payment Method</FPCLINE>
      <FPCLINE>              mwsbk  &quot; Tax amount in document currency</FPCLINE>
      <FPCLINE>            zzrland  &quot; Tax Reporting Country</FPCLINE>
      <FPCLINE>            zzvatnsf &quot; VAT Registration Number</FPCLINE>
      <FPCLINE>       FROM vbrk     &quot; Billing Document: Header Data</FPCLINE>
      <FPCLINE>       INTO (lv_waerk,lv_fkdat,lv_zlsch,lv_mwsbk, lv_zzrland, lv_zvatnsf)</FPCLINE>
      <FPCLINE>       WHERE vbeln = im_bil_prt_com-head_detail-vbdkr-vbeln.</FPCLINE>
      <FPCLINE>IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get Bio-Rad VAT Number</FPCLINE>
      <FPCLINE>IF NOT lv_zvatnsf IS INITIAL.</FPCLINE>
      <FPCLINE>  PERFORM f_get_brvat USING im_bil_prt_com-head_detail-vbdkr-bukrs</FPCLINE>
      <FPCLINE>                            li_emi_constants</FPCLINE>
      <FPCLINE>                            lv_zvatnsf.</FPCLINE>
      <FPCLINE>ENDIF. &quot; IF NOT lv_zvatnsf IS INITIAL</FPCLINE>
      <FPCLINE>CLEAR lv_zvatnsf.</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get First Sales Document after Sorting</FPCLINE>
      <FPCLINE>li_item_detail = im_bil_prt_com-item_detail.</FPCLINE>
      <FPCLINE>SORT li_item_detail BY vbdpr-vbeln_vauf.</FPCLINE>
      <FPCLINE>READ TABLE li_item_detail INTO lwa_bill_item_detail INDEX 1.</FPCLINE>
      <FPCLINE>IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>  APPEND lwa_bill_item_detail-vbdpr-vbeln_vauf TO li_doc_num.</FPCLINE>
      <FPCLINE>  lwa_invoice_header-aubel = lwa_bill_item_detail-vbdpr-vbeln_vauf.</FPCLINE>
      <FPCLINE>ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Billing Document Number</FPCLINE>
      <FPCLINE>APPEND im_bil_prt_com-head_detail-vbdkr-vbeln TO li_doc_num.</FPCLINE>
      <FPCLINE>SORT li_doc_num BY vbeln.</FPCLINE>
      <FPCLINE>DELETE ADJACENT DUPLICATES FROM li_doc_num COMPARING vbeln.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get All Partner Data</FPCLINE>
      <FPCLINE>PERFORM f_get_vbpa USING li_doc_num</FPCLINE>
      <FPCLINE>                CHANGING li_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get Conditions (Transaction Data)</FPCLINE>
      <FPCLINE>PERFORM f_get_konv USING im_bil_prt_com-head_detail-vbdkr-knumv</FPCLINE>
      <FPCLINE>                CHANGING li_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>* Get License date and License no from KONH if emi has entry(for sales org)</FPCLINE>
      <FPCLINE>* Sales Org for Italy from EMI</FPCLINE>
      <FPCLINE>CLEAR: gv_lic_no, lv_lic_dat, gv_lic_date.</FPCLINE>
      <FPCLINE>READ TABLE li_emi_constants INTO lwa_emi_constants</FPCLINE>
      <FPCLINE>        WITH KEY criteria = lc_enh_crit_vkorg</FPCLINE>
      <FPCLINE>                  sel_low = im_bil_prt_com-head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  PERFORM f_get_license USING    li_konv</FPCLINE>
      <FPCLINE>                                 im_bil_prt_com-head_detail-vbdkr-kunwe</FPCLINE>
      <FPCLINE>                                 lwa_emi_constants-sel_high</FPCLINE>
      <FPCLINE>                        CHANGING gv_lic_no lv_lic_dat gv_prnum.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  PERFORM f_format_date USING lv_lic_dat</FPCLINE>
      <FPCLINE>                   CHANGING gv_lic_date.</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* Billing Document Header Data</FPCLINE>
      <FPCLINE>PERFORM f_get_vbrk USING im_bil_prt_com-head_detail-vbdkr-vbeln</FPCLINE>
      <FPCLINE>                   CHANGING i_vbrk.</FPCLINE>
      <FPCLINE>* &lt;--- End    of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get Item Details</FPCLINE>
      <FPCLINE>PERFORM f_get_vbrp USING im_bil_prt_com-head_detail-vbdkr-vbeln</FPCLINE>
      <FPCLINE>                CHANGING li_vbrp.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>*Below query is commented as new query is written with  new field Currency key</FPCLINE>
      <FPCLINE>** Get Comapany Country Code</FPCLINE>
      <FPCLINE>*SELECT SINGLE land1 &quot; Country Key</FPCLINE>
      <FPCLINE>*  FROM t001         &quot; Company Codes</FPCLINE>
      <FPCLINE>*  INTO lv_comp_land1</FPCLINE>
      <FPCLINE>* WHERE bukrs EQ im_bil_prt_com-head_detail-vbdkr-bukrs.</FPCLINE>
      <FPCLINE>* ---&gt; End of delete for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of insert for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>** Get Company Country Code and currency key</FPCLINE>
      <FPCLINE>SELECT SINGLE land1 &quot; Country Key</FPCLINE>
      <FPCLINE>              waers &quot;Currency key</FPCLINE>
      <FPCLINE>  FROM t001         &quot; Company Codes</FPCLINE>
      <FPCLINE>  INTO (lv_comp_land1, gv_cur)</FPCLINE>
      <FPCLINE>  WHERE bukrs EQ im_bil_prt_com-head_detail-vbdkr-bukrs.</FPCLINE>
      <FPCLINE>IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*Get rate type from T005 based on country key</FPCLINE>
      <FPCLINE>  SELECT SINGLE kurst &quot; Exchange Rate Type for Translation into Country Currency</FPCLINE>
      <FPCLINE>  FROM t005           &quot; Countries</FPCLINE>
      <FPCLINE>  INTO lv_cont_kurst</FPCLINE>
      <FPCLINE>  WHERE land1 EQ lv_comp_land1.</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*Check if company code currency is not equal to invoice currency</FPCLINE>
      <FPCLINE>  IF gv_cur NE lv_waerk.</FPCLINE>
      <FPCLINE>*If vat amount is not 0</FPCLINE>
      <FPCLINE>    IF lv_mwsbk NE 0.</FPCLINE>
      <FPCLINE>*Convert invoice currency to company code currency</FPCLINE>
      <FPCLINE>      CALL FUNCTION &apos;CONVERT_TO_LOCAL_CURRENCY&apos;</FPCLINE>
      <FPCLINE>        EXPORTING</FPCLINE>
      <FPCLINE>          date             = lv_fkdat</FPCLINE>
      <FPCLINE>          foreign_amount   = lv_mwsbk</FPCLINE>
      <FPCLINE>          foreign_currency = lv_waerk</FPCLINE>
      <FPCLINE>          local_currency   = gv_cur</FPCLINE>
      <FPCLINE>          type_of_rate     = lv_cont_kurst</FPCLINE>
      <FPCLINE>        IMPORTING</FPCLINE>
      <FPCLINE>          exchange_rate    = gv_exchg_rate</FPCLINE>
      <FPCLINE>          local_amount     = gv_vatamt</FPCLINE>
      <FPCLINE>        EXCEPTIONS</FPCLINE>
      <FPCLINE>          no_rate_found    = 1</FPCLINE>
      <FPCLINE>          overflow         = 2</FPCLINE>
      <FPCLINE>          no_factors_found = 3</FPCLINE>
      <FPCLINE>          no_spread_found  = 4</FPCLINE>
      <FPCLINE>          derived_2_times  = 5</FPCLINE>
      <FPCLINE>          OTHERS           = 6.</FPCLINE>
      <FPCLINE>      IF sy-subrc &lt;&gt; 0.</FPCLINE>
      <FPCLINE>* Implement suitable error handling here</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc &lt;&gt; 0</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF lv_mwsbk NE 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF gv_cur NE lv_waerk</FPCLINE>
      <FPCLINE>ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>CLEAR: lv_fkdat,lv_waerk,lv_mwsbk,lv_cont_kurst.</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for D3_OTC_FDD_0014 Def#6736  by U033632</FPCLINE>
      <FPCLINE>*Get header line</FPCLINE>
      <FPCLINE>** Page Header Section (Section A):</FPCLINE>
      <FPCLINE>* Get Bio-Rad Logo</FPCLINE>
      <FPCLINE>PERFORM f_get_logo.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Sales Organisation Postal Address</FPCLINE>
      <FPCLINE>PERFORM f_read_sorg_post_add USING im_bil_prt_com-head_detail-tvko-adrnr</FPCLINE>
      <FPCLINE>                                   im_bil_prt_com-head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>* Sales Organisation Telephone Number</FPCLINE>
      <FPCLINE>SELECT SINGLE tel_number &quot; Telephone no.: dialling code+number</FPCLINE>
      <FPCLINE>  FROM adr2              &quot; Telephone Numbers (Business Address Services)</FPCLINE>
      <FPCLINE>  INTO gv_sales_org_tel_num</FPCLINE>
      <FPCLINE> WHERE addrnumber EQ im_bil_prt_com-head_detail-tvko-adrnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Billing document type name</FPCLINE>
      <FPCLINE>SELECT SINGLE bill_desc &quot; 30 Characters</FPCLINE>
      <FPCLINE>  FROM zotc_billname    &quot; Billing type description for printing purpose</FPCLINE>
      <FPCLINE>  INTO gv_billing_doc_name</FPCLINE>
      <FPCLINE>  WHERE spras EQ gv_form_lang</FPCLINE>
      <FPCLINE>  AND   fkart EQ im_bil_prt_com-head_detail-vbdkr-fkart.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Billing Document Number</FPCLINE>
      <FPCLINE>gv_vbeln = im_bil_prt_com-head_detail-vbdkr-vbeln.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Duplicate Print indicator</FPCLINE>
      <FPCLINE>* Begin of Delete for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>*IF NOT invoice_s_prt_head_detail-repeat IS INITIAL.</FPCLINE>
      <FPCLINE>*  gv_duplicate_flag = abap_true.</FPCLINE>
      <FPCLINE>*ENDIF. &quot; IF NOT invoice_s_prt_head_detail-repeat IS INITIAL</FPCLINE>
      <FPCLINE>* End of Delete for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>PERFORM f_check_duplicate_print USING im_nast.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Billing Date</FPCLINE>
      <FPCLINE>PERFORM f_format_date USING im_bil_prt_com-head_detail-vbdkr-fkdat</FPCLINE>
      <FPCLINE>                   CHANGING gv_billing_date.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Sales Order Information</FPCLINE>
      <FPCLINE>PERFORM f_sales_order_info USING li_item_detail.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Bio-Rad Customer Service Logo / Telephone number</FPCLINE>
      <FPCLINE>PERFORM f_get_cust_service_phone USING im_bil_prt_com-head_detail-vbdkr-vkorg</FPCLINE>
      <FPCLINE>                                       li_item_detail</FPCLINE>
      <FPCLINE>                                       li_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Bio-Rad Customer Service E-mail</FPCLINE>
      <FPCLINE>PERFORM f_get_cust_service_email USING im_bil_prt_com-head_detail-vbdkr-vkorg</FPCLINE>
      <FPCLINE>                                       li_item_detail</FPCLINE>
      <FPCLINE>                                       li_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>** Invoice Header section (Section B):</FPCLINE>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE>  READ TABLE li_vbpa ASSIGNING &lt;fs_vbpa&gt;</FPCLINE>
      <FPCLINE>    WITH KEY vbeln = gv_vbeln parvw = &apos;RE&apos;.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    lv_adrnr = &lt;fs_vbpa&gt;-adrnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    SELECT SINGLE region</FPCLINE>
      <FPCLINE>      INTO lv_region</FPCLINE>
      <FPCLINE>      FROM adrc</FPCLINE>
      <FPCLINE>      WHERE addrnumber = lv_adrnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      READ TABLE i_vbrk ASSIGNING &lt;fs_vbrk&gt;</FPCLINE>
      <FPCLINE>        INDEX 1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>        lv_vkorg = &lt;fs_vbrk&gt;-vkorg.</FPCLINE>
      <FPCLINE>        READ TABLE li_emi_constants INTO lwa_emi_constants</FPCLINE>
      <FPCLINE>                             WITH KEY criteria = lc_enh_criteria_canarias</FPCLINE>
      <FPCLINE>                             sel_low  = lv_region</FPCLINE>
      <FPCLINE>                             sel_high = &lt;fs_vbrk&gt;-vkorg.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>               EXPORTING</FPCLINE>
      <FPCLINE>                 id                      = lc_tdid</FPCLINE>
      <FPCLINE>                 language                = gv_form_lang</FPCLINE>
      <FPCLINE>                 name                    = lc_text_canarias</FPCLINE>
      <FPCLINE>                 object                  = lc_tdobject</FPCLINE>
      <FPCLINE>               TABLES</FPCLINE>
      <FPCLINE>                 lines                   = li_lines</FPCLINE>
      <FPCLINE>               EXCEPTIONS</FPCLINE>
      <FPCLINE>                 id                      = 1</FPCLINE>
      <FPCLINE>                 language                = 1</FPCLINE>
      <FPCLINE>                 name                    = 1</FPCLINE>
      <FPCLINE>                 not_found               = 1</FPCLINE>
      <FPCLINE>                 object                  = 1</FPCLINE>
      <FPCLINE>                 reference_check         = 1</FPCLINE>
      <FPCLINE>                 wrong_access_to_archive = 1</FPCLINE>
      <FPCLINE>                 OTHERS                  = 1.</FPCLINE>
      <FPCLINE>             IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>               READ TABLE li_lines INTO lwa_line INDEX 1.</FPCLINE>
      <FPCLINE>               IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                   APPEND LINES OF li_lines[] TO i_bill_header_txt[].</FPCLINE>
      <FPCLINE>               ENDIF.</FPCLINE>
      <FPCLINE>             ENDIF.</FPCLINE>
      <FPCLINE>        ENDIF.</FPCLINE>
      <FPCLINE>    ENDIF.</FPCLINE>
      <FPCLINE>  ENDIF.</FPCLINE>
      <FPCLINE>  ENDIF.</FPCLINE>
      <FPCLINE>** End of SCTASK0793196/SCTASK0736194 R.1</FPCLINE>
      <FPCLINE>* Bill-To Address</FPCLINE>
      <FPCLINE>PERFORM f_get_bill_to_address USING li_vbpa</FPCLINE>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE>                                    im_bil_prt_com</FPCLINE>
      <FPCLINE>                                    im_nast</FPCLINE>
      <FPCLINE>                                    lv_adrnr</FPCLINE>
      <FPCLINE>** End of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE>                           CHANGING lv_billto_land1</FPCLINE>
      <FPCLINE>                                    lwa_invoice_header.</FPCLINE>
      <FPCLINE>* Sold-To Address</FPCLINE>
      <FPCLINE>PERFORM f_get_sold_to_address USING li_vbpa</FPCLINE>
      <FPCLINE>                           CHANGING lwa_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Ship-To Address</FPCLINE>
      <FPCLINE>PERFORM f_get_ship_to_address USING li_vbpa</FPCLINE>
      <FPCLINE>                                    li_item_detail</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                                    li_vbrp</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                           CHANGING lwa_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Customer VAT Registration Number</FPCLINE>
      <FPCLINE>lwa_invoice_header-stceg = im_bil_prt_com-head_detail-vbdkr-stceg.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Other Tax Numbers</FPCLINE>
      <FPCLINE>PERFORM f_get_other_tax_numbers USING im_bil_prt_com-head_detail-vbdkr-kunag</FPCLINE>
      <FPCLINE>                             CHANGING lwa_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Incoterm Part 1</FPCLINE>
      <FPCLINE>lwa_invoice_header-inco1 = im_bil_prt_com-head_detail-vbdkr-inco1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Incoterm Part 2</FPCLINE>
      <FPCLINE>lwa_invoice_header-inco2 = im_bil_prt_com-head_detail-vbdkr-inco2.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* GLN for Bill-to party, Sold-To party and Ship-to party</FPCLINE>
      <FPCLINE>PERFORM f_get_gln USING li_vbpa</FPCLINE>
      <FPCLINE>               CHANGING lwa_invoice_header.</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>* Contact Name</FPCLINE>
      <FPCLINE>PERFORM f_get_contact USING li_vbpa</FPCLINE>
      <FPCLINE>                   CHANGING lwa_invoice_header.</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Invoice Header required only once</FPCLINE>
      <FPCLINE>APPEND lwa_invoice_header TO i_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Decimal formatting as per bill to country</FPCLINE>
      <FPCLINE>SET COUNTRY lv_billto_land1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>** Items section (Section C):</FPCLINE>
      <FPCLINE>* Build Invoice Items Table</FPCLINE>
      <FPCLINE>PERFORM f_inv_items_table USING im_bil_prt_com-head_detail</FPCLINE>
      <FPCLINE>                                im_bil_prt_com-item_detail</FPCLINE>
      <FPCLINE>                                li_emi_constants</FPCLINE>
      <FPCLINE>                                li_konv</FPCLINE>
      <FPCLINE>                                li_vbrp</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                                i_vbrk</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 16-APR-2018</FPCLINE>
      <FPCLINE>                                im_bil_prt_com-head_detail-vbdkr-vbeln.</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 16-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>* End of Items section (Section C.1):</FPCLINE>
      <FPCLINE>* Build end of Invoice table</FPCLINE>
      <FPCLINE>PERFORM f_end_of_items.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>** Invoice Footer Section (Section D):</FPCLINE>
      <FPCLINE>* Billing document currency</FPCLINE>
      <FPCLINE>gv_bill_doc_currency = im_bil_prt_com-head_detail-vbdkr-waerk.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Sub-total</FPCLINE>
      <FPCLINE>PERFORM f_get_sub_total.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Freight Charges, Handling Charges, Insurance Charges, Document Charges</FPCLINE>
      <FPCLINE>PERFORM f_get_charges USING li_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Net amount in Doc Currency</FPCLINE>
      <FPCLINE>WRITE im_bil_prt_com-head_detail-vbdkr-netwr TO gv_net_amt CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Tax amount</FPCLINE>
      <FPCLINE>WRITE im_bil_prt_com-head_detail-vbdkr-mwsbk TO gv_tax_amt CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Total Amount</FPCLINE>
      <FPCLINE>lv_total_amt = im_bil_prt_com-head_detail-vbdkr-netwr + im_bil_prt_com-head_detail-vbdkr-mwsbk.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>WRITE lv_total_amt TO gv_total_amt CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Down Payment Amounts / Outstanding amounts / List of Down payments</FPCLINE>
      <FPCLINE>PERFORM f_get_down_payment USING lv_total_amt</FPCLINE>
      <FPCLINE>                                 li_vbrp.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* To avoid multiple selects on VBRK, this value fetched already</FPCLINE>
      <FPCLINE>*PERFORM f_get_tax_reporting_country USING im_bil_prt_com-head_detail-vbdkr-vbeln</FPCLINE>
      <FPCLINE>*                                    CHANGING lv_zzrland.</FPCLINE>
      <FPCLINE>* ---&gt; End   of Delete for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* Tax Legal Mention</FPCLINE>
      <FPCLINE>PERFORM f_get_tax_legal_mentions USING lv_comp_land1</FPCLINE>
      <FPCLINE>                                       li_konv</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                                       li_emi_constants</FPCLINE>
      <FPCLINE>                                       i_vbrk</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>                                       lv_zzrland</FPCLINE>
      <FPCLINE>* &lt;--- End of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.05 by U034334</FPCLINE>
      <FPCLINE>                                       im_bil_prt_com-head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.05 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Bio-Rad Bank Details (Bio-Rad Bank Name / Bio-Rad Bank Adress / Bio-Rad Bank City</FPCLINE>
      <FPCLINE>*             Bio-Rad Bank Account number / Bio-Rad Bank BIC / Bio-Rad IBAN )</FPCLINE>
      <FPCLINE>PERFORM f_bank_details USING im_bil_prt_com-head_detail-vbdkr-bukrs</FPCLINE>
      <FPCLINE>                             im_bil_prt_com-head_detail-vbdkr-waerk</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129_CR301 by NALI</FPCLINE>
      <FPCLINE>                             im_bil_prt_com-head_detail-vbdkr-vkorg</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129_CR301 by NALI</FPCLINE>
      <FPCLINE>                             li_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* VAT Summary (Tax rate / Tax base amount / Tax amount)</FPCLINE>
      <FPCLINE>PERFORM f_vat_summary USING li_konv</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                            li_emi_constants</FPCLINE>
      <FPCLINE>                            i_vbrk.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Payment Terms</FPCLINE>
      <FPCLINE>PERFORM f_payment_terms USING im_bil_prt_com-head_detail-vbdkr-zterm</FPCLINE>
      <FPCLINE>                              im_bil_prt_com-head_detail-vbdkr-fkdat</FPCLINE>
      <FPCLINE>                              im_bil_prt_com-head_detail-vbdkr-zterm_tx1</FPCLINE>
      <FPCLINE>                              im_bil_prt_com-head_detail-vbdkr-zterm_tx2</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>                              im_bil_prt_com-head_detail-vbdkr-zterm_tx3</FPCLINE>
      <FPCLINE>                              im_bil_prt_com-head_detail-vbdkr-vbtyp</FPCLINE>
      <FPCLINE>                              im_bil_prt_com-head_detail-vbdkr-vkorg</FPCLINE>
      <FPCLINE>                              li_emi_constants.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>* Payment Mode</FPCLINE>
      <FPCLINE>PERFORM f_get_payment_mode USING lv_zlsch</FPCLINE>
      <FPCLINE>                                 lv_comp_land1</FPCLINE>
      <FPCLINE>                                 im_bil_prt_com-head_detail-vbdkr-bukrs</FPCLINE>
      <FPCLINE>                                 li_emi_constants</FPCLINE>
      <FPCLINE>                                 li_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* General payment text</FPCLINE>
      <FPCLINE>PERFORM f_get_general_payment_std_text USING im_bil_prt_com-head_detail-vbdkr-bukrs</FPCLINE>
      <FPCLINE>                                             im_bil_prt_com-head_detail-vbdkr-rplnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>** Page Footer Section (Section E):</FPCLINE>
      <FPCLINE>* Footer Legal Text (Sales Org. Informations)</FPCLINE>
      <FPCLINE>PERFORM f_get_ltext_sales USING im_bil_prt_com-head_detail-vbdkr-bukrs.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Footer Legal Text (Terms and Conditions)</FPCLINE>
      <FPCLINE>PERFORM f_get_tcsales USING im_bil_prt_com-head_detail-vbdkr-bukrs.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>* Get Tax Representive</FPCLINE>
      <FPCLINE>PERFORM f_get_fiscal_rep  USING im_bil_prt_com-head_detail-vbdkr-vbeln</FPCLINE>
      <FPCLINE>                                im_bil_prt_com-head_detail-vbdkr-vkorg</FPCLINE>
      <FPCLINE>                                lv_zzrland</FPCLINE>
      <FPCLINE>                                li_emi_constants.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>* Determine if sales org is valid for printing CUU/AR</FPCLINE>
      <FPCLINE>PERFORM f_get_cuu_ra USING li_emi_constants</FPCLINE>
      <FPCLINE>                           im_bil_prt_com-head_detail-vbdkr-vkorg</FPCLINE>
      <FPCLINE>                  CHANGING gv_cuu_ra_flag.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get System Certification Details</FPCLINE>
      <FPCLINE>PERFORM f_get_cert_det CHANGING gv_sap_rel</FPCLINE>
      <FPCLINE>                                gv_cert_id.</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>* Sales Org for Italy from EMI</FPCLINE>
      <FPCLINE>READ TABLE li_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>WITH KEY criteria = lc_enh_criteria_vkorg</FPCLINE>
      <FPCLINE>          sel_low = im_bil_prt_com-head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>* Get header cond</FPCLINE>
      <FPCLINE>  li_header_cond = im_bil_prt_com-head_detail-conditions.</FPCLINE>
      <FPCLINE>* Remove those conditions, which don&apos;t have tax records</FPCLINE>
      <FPCLINE>  DELETE li_header_cond WHERE koaid NE lc_koaid_taxes.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  LOOP AT li_header_cond INTO lwa_header_cond.</FPCLINE>
      <FPCLINE>*  Check for valid Tax code from EMI</FPCLINE>
      <FPCLINE>    READ TABLE li_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>    WITH KEY criteria = lc_enh_criteria_mwskz</FPCLINE>
      <FPCLINE>              sel_low = lwa_header_cond-mwskz.</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*     Check for EUR Currency</FPCLINE>
      <FPCLINE>      READ TABLE li_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>      WITH KEY criteria = lc_enh_criteria_kbetr</FPCLINE>
      <FPCLINE>               sel_high = im_bil_prt_com-head_detail-doc_currency.</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*       Check for threshold value</FPCLINE>
      <FPCLINE>        READ TABLE li_emi_constants INTO lwa_emi_constants</FPCLINE>
      <FPCLINE>        WITH KEY criteria = lc_enh_criteria_kbetr.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          IF lwa_emi_constants-sel_low &lt; lwa_header_cond-kawrt.</FPCLINE>
      <FPCLINE>            gv_inv_text = abap_true.</FPCLINE>
      <FPCLINE>            CLEAR lwa_emi_constants.</FPCLINE>
      <FPCLINE>            EXIT.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF lwa_emi_constants-sel_low &lt; lwa_header_cond-kawrt</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*     Currency is not EUR, convert the values to EUR and then compare</FPCLINE>
      <FPCLINE>        IF lwa_header_cond-kawrt GT &apos;0.00&apos;.</FPCLINE>
      <FPCLINE>          CALL FUNCTION &apos;CONVERT_TO_LOCAL_CURRENCY&apos;</FPCLINE>
      <FPCLINE>            EXPORTING</FPCLINE>
      <FPCLINE>              date             = sy-datum</FPCLINE>
      <FPCLINE>              foreign_amount   = lwa_header_cond-kawrt</FPCLINE>
      <FPCLINE>              foreign_currency = im_bil_prt_com-head_detail-doc_currency</FPCLINE>
      <FPCLINE>              local_currency   = im_bil_prt_com-head_detail-vbdkr-waers</FPCLINE>
      <FPCLINE>            IMPORTING</FPCLINE>
      <FPCLINE>              local_amount     = lwa_header_cond-kawrt</FPCLINE>
      <FPCLINE>            EXCEPTIONS</FPCLINE>
      <FPCLINE>              no_rate_found    = 1</FPCLINE>
      <FPCLINE>              overflow         = 2</FPCLINE>
      <FPCLINE>              no_factors_found = 3</FPCLINE>
      <FPCLINE>              no_spread_found  = 4</FPCLINE>
      <FPCLINE>              derived_2_times  = 5</FPCLINE>
      <FPCLINE>              OTHERS           = 6.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*       Check for threshold value</FPCLINE>
      <FPCLINE>            READ TABLE li_emi_constants INTO lwa_emi_constants</FPCLINE>
      <FPCLINE>            WITH KEY criteria = lc_enh_criteria_kbetr.</FPCLINE>
      <FPCLINE>            IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>              IF lwa_emi_constants-sel_low &lt; lwa_header_cond-kawrt.</FPCLINE>
      <FPCLINE>                gv_inv_text = abap_true.</FPCLINE>
      <FPCLINE>                CLEAR lwa_emi_constants.</FPCLINE>
      <FPCLINE>                EXIT.</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF lwa_emi_constants-sel_low &lt; lwa_header_cond-kawrt</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF lwa_header_cond-kawrt GT &apos;0 00&apos;</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    CLEAR lwa_header_cond.</FPCLINE>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT li_header_cond INTO lwa_header_cond</FPCLINE>
      <FPCLINE>ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
     </INITIALIZATION>
     <FORMS>
      <FPCLINE>************************************************************************</FPCLINE>
      <FPCLINE>* PROGRAM    :  ZOTC0014_CUST_INVOICE_FORM_INT                         *</FPCLINE>
      <FPCLINE>* TITLE      :  Customer Invoice Form (Billing) Interface              *</FPCLINE>
      <FPCLINE>* DEVELOPER  :  MUHAMMED SYED                                          *</FPCLINE>
      <FPCLINE>* OBJECT TYPE:  Sub-routines                                           *</FPCLINE>
      <FPCLINE>* SAP RELEASE:  SAP ECC 6.0                                            *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* WRICEF ID:  D3_OTC_FDD_0014_Customer Invoice Form - (Billing)        *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* DESCRIPTION: Sub-routines                                            *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* MODIFICATION HISTORY:                                                *</FPCLINE>
      <FPCLINE>*======================================================================*</FPCLINE>
      <FPCLINE>* DATE        USER      TRANSPORT  DESCRIPTION                         *</FPCLINE>
      <FPCLINE>* =========== ========  ========== ====================================*</FPCLINE>
      <FPCLINE>* 16-Sep-2016 KMISHRA/  E1DK921455 INITIAL DEVELOPMENT                 *</FPCLINE>
      <FPCLINE>*            Muhammed Syed                                             *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 27-Oct-2016 Muhammed  E1DK921455 Defect 5678                         *</FPCLINE>
      <FPCLINE>*              Syed                                                    *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 27-Oct-2016 Muhammed  E1DK921455 Defect 5688                         *</FPCLINE>
      <FPCLINE>*              Syed                                                    *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 08-Nov-2016 Muhammed  E1DK921455 Defect 6075                         *</FPCLINE>
      <FPCLINE>*              Syed                                                    *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 15-Nov-2016 SGHOSH    E1DK921455 Defect#6294:If the document type is *</FPCLINE>
      <FPCLINE>*                                  delivery (J) then only delivery     *</FPCLINE>
      <FPCLINE>*                                  information will be populated.      *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 01-Dec-2016 SGHOSH    E1DK921455 Defect#6829(CR)- I.Logic Changed for*</FPCLINE>
      <FPCLINE>*                                  Ship To Address only for Plant      *</FPCLINE>
      <FPCLINE>*                                  Abroad Billing document(ZWIA Billing*</FPCLINE>
      <FPCLINE>*                                  type).                              *</FPCLINE>
      <FPCLINE>*                                  II. Logic Changed for Tax Rate, Tax *</FPCLINE>
      <FPCLINE>*                                  Legal Mention &amp; Tax Reporting Country</FPCLINE>
      <FPCLINE>*                                  III. 2 EMI Criteria&apos;s created for new</FPCLINE>
      <FPCLINE>*                                  Tax logic                           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 08-Dec-2016 SGHOSH    E1DK921455 Defect#7302 - For Batch Managed     *</FPCLINE>
      <FPCLINE>*                                  material code changes done to print *</FPCLINE>
      <FPCLINE>*                                  Qty, Unit Price &amp; Amount.           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*14-Dec-2016 rbanerj1  E1DK921455 Defect#7558 - code changes done, to  *</FPCLINE>
      <FPCLINE>*                                 display correct Qty. for batch split *</FPCLINE>
      <FPCLINE>*                                 scenario.                            *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 03-Jan-2017 NALI      E1DK921455 Defect 8134                         *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 04-Jan-2017 NALI      E1DK921455 Defect 7129 – CR 301                *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 20-Feb-2017 U033867   E1DK925886 CR#356 :Changes on bank details     *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 30-Mar-2017 DMOIRAN              D3 Defect 11704.                    *</FPCLINE>
      <FPCLINE>*In scenario of an invoice having multiple deliveries with batch split *</FPCLINE>
      <FPCLINE>* from a sales order line item, the line item from first delivery is   *</FPCLINE>
      <FPCLINE>*only displayed.                                                       *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 20-April-2017 U033867  E1DK925886 Defect#2619:SH/SP Addresses are    *</FPCLINE>
      <FPCLINE>*                       truncated at the Financial Invoice Header level*</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 08-May-2017 SMUKHER4  E1DK927655 Defect# 2720 - APAC Subsidiaries    *</FPCLINE>
      <FPCLINE>*                                  outputs do not print the correct    *</FPCLINE>
      <FPCLINE>*                                  amounts even though in the system is*</FPCLINE>
      <FPCLINE>*                                  correct due to the decimal          *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 12-Oct-2017 U034334   E1DK931103 D3R2 Changes                        *</FPCLINE>
      <FPCLINE>* 1. Print GLN for Bill-to, Sold-to &amp; Ship-to party.                   *</FPCLINE>
      <FPCLINE>* 2. Print Environmental Fee value for pricing condition ZENV.         *</FPCLINE>
      <FPCLINE>* 3. For Company Code 1024 and 2000 if Bio-Rad VAT No. starts with &apos;CH&apos;*</FPCLINE>
      <FPCLINE>*    print suffix &quot;MWST&quot;.                                              *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 05-Feb-2018 U034334   E1DK931103 D3R3 Changes                        *</FPCLINE>
      <FPCLINE>* 1. GLN not required for Sold-To party                                *</FPCLINE>
      <FPCLINE>* 2. Print contact name from AP/ZA partner, whichever is maintained    *</FPCLINE>
      <FPCLINE>* 3. Print Certification Details in invoice footer                     *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 08-Mar-2018 U024694   E1DK931103 D3R3.04 Changes (Tag: D3R3.04)      *</FPCLINE>
      <FPCLINE>* 1. Print text when billing item is FOC                               *</FPCLINE>
      <FPCLINE>* 2. Print Stamp Duty for certain tax codes                            *</FPCLINE>
      <FPCLINE>* Note: Both these requirements are for Italy only                     *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 12-Mar-2018 U024694   E1DK931103 D3R3.05 Changes (Tag: D3R3.05)      *</FPCLINE>
      <FPCLINE>* Do not print Print Legal Mention for Tax codes when when the condition*</FPCLINE>
      <FPCLINE>* base   value = 0.00  This requirement is for Italy only              *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 17-APR-2018 U100018   E1DK931103  Defect# 5683: Update of Header     *</FPCLINE>
      <FPCLINE>*                                   Address for Italian language       *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 17-May-2018 U033876   E1DK936750 D3R3.08 Changes                     *</FPCLINE>
      <FPCLINE>* Print the license number and license granted date                    *</FPCLINE>
      <FPCLINE>* Note: this requirements are for Italy only                           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 01-AUG-2018 U033632  E1DK938034 D3R3 Def#6737 Changes                *</FPCLINE>
      <FPCLINE>* 1. Update Portuguese footer with VAT variable                        *</FPCLINE>
      <FPCLINE>* 2. Add 3rd position of GLN                                           *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 29-AUG-2018 U033632/DDWIVEDI E1DK938541 D3R3 Incident#INC0432585     *</FPCLINE>
      <FPCLINE>* Added new column Service rendered date in VAT Summary Table based    *</FPCLINE>
      <FPCLINE>* on EMI check                                                         *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>* 26-Feb-2019  amangal E2DK922026  R.1 Various Updates                 *</FPCLINE>
      <FPCLINE>*                                                                      *</FPCLINE>
      <FPCLINE>*                    GE – Approved 28-Jan-2019                         *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0781062: AB Serotec WRICEF - Customer    *</FPCLINE>
      <FPCLINE>*                        Invoice                                       *</FPCLINE>
      <FPCLINE>*                    PE – Pending approval PCR 517                     *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0787285                                  *</FPCLINE>
      <FPCLINE>*                    -  Out of country invoices, country name in       *</FPCLINE>
      <FPCLINE>*                       English r6.1(Esker correction)                 *</FPCLINE>
      <FPCLINE>*                    PE – PCR 515                                      *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0762126                                  *</FPCLINE>
      <FPCLINE>*                    -  Italy SO10 Text Update Tax codes               *</FPCLINE>
      <FPCLINE>*                    PE – 516                                          *</FPCLINE>
      <FPCLINE>*                    -  SCTASK0736194 : Spain “Special text” for       *</FPCLINE>
      <FPCLINE>*                        Canary Islands                                *</FPCLINE>
      <FPCLINE>*                     Appdev task SCTASK0793196                        *</FPCLINE>
      <FPCLINE>************************************************************************</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_emi_values</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get EMI Constant Values</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      &lt;--FP_I_EMI_CONSTANTS  Enhancement Status</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_emi_values CHANGING fp_i_emi_constants TYPE ty_t_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_enhancement_no	TYPE z_enhancement VALUE &apos;D2_OTC_FDD_0014&apos;.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CALL FUNCTION &apos;ZDEV_ENHANCEMENT_STATUS_CHECK&apos;</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      iv_enhancement_no = lc_enhancement_no</FPCLINE>
      <FPCLINE>    TABLES</FPCLINE>
      <FPCLINE>      tt_enh_status     = fp_i_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF fp_i_emi_constants  IS NOT INITIAL.</FPCLINE>
      <FPCLINE>*  Select only the active entries.</FPCLINE>
      <FPCLINE>    DELETE fp_i_emi_constants WHERE active = abap_false.</FPCLINE>
      <FPCLINE>    SORT fp_i_emi_constants BY criteria sel_low.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF fp_i_emi_constants IS NOT INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_emi_values</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_form_language</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Determine Form Language</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_LANGU   Language Key</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_form_language USING fp_langu TYPE spras. &quot; Language Key</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    BEGIN OF lc_lang,</FPCLINE>
      <FPCLINE>      english TYPE spras VALUE &apos;E&apos;, &quot; Language Key</FPCLINE>
      <FPCLINE>      french  TYPE spras VALUE &apos;F&apos;, &quot; Language Key</FPCLINE>
      <FPCLINE>      spanish TYPE spras VALUE &apos;S&apos;, &quot; Language Key</FPCLINE>
      <FPCLINE>      german  TYPE spras VALUE &apos;D&apos;, &quot; Language Key</FPCLINE>
      <FPCLINE>      default TYPE spras VALUE &apos;E&apos;, &quot; Language Key</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>      danish    TYPE spras VALUE &apos;K&apos;, &quot;Danish</FPCLINE>
      <FPCLINE>      finnish   TYPE spras VALUE &apos;U&apos;, &quot;Finnish</FPCLINE>
      <FPCLINE>      swedish   TYPE spras VALUE &apos;V&apos;, &quot;Swedish</FPCLINE>
      <FPCLINE>      norwegian TYPE spras VALUE &apos;O&apos;, &quot;Norwegian</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>      italian   TYPE spras VALUE &apos;I&apos;, &quot; Language Key</FPCLINE>
      <FPCLINE>      portugese TYPE spras VALUE &apos;P&apos;, &quot; Language Key</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>    END OF lc_lang.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF NOT ( fp_langu EQ lc_lang-english OR</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-french  OR</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-spanish OR</FPCLINE>
      <FPCLINE>* &lt;--- Begin of Change for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>*           fp_langu EQ lc_lang-german ).</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-german  OR</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-danish  OR</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-finnish OR</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-swedish OR</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-norwegian OR</FPCLINE>
      <FPCLINE>* &lt;--- End   of Change for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* &lt;--- Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-italian OR</FPCLINE>
      <FPCLINE>           fp_langu EQ lc_lang-portugese ).</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  If Language not maintained then print in English</FPCLINE>
      <FPCLINE>    gv_form_lang = lc_lang-default.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF NOT ( fp_langu EQ lc_lang-english OR</FPCLINE>
      <FPCLINE>    gv_form_lang = fp_langu.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF NOT ( fp_langu EQ lc_lang-english OR</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_form_language</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_vbpa</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get All Partner Data</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_DOC_NUM  All Document VBELNS</FPCLINE>
      <FPCLINE>*      &lt;--FP_I_VBPA     Partner Data</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_vbpa USING fp_i_doc_num TYPE ty_t_doc_num</FPCLINE>
      <FPCLINE>             CHANGING fp_i_vbpa    TYPE ty_t_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    BEGIN OF lc_parvw,</FPCLINE>
      <FPCLINE>      bill_to TYPE parvw VALUE &apos;RE&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>      ship_to TYPE parvw VALUE &apos;WE&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>      sold_to TYPE parvw VALUE &apos;AG&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>      payer   TYPE parvw VALUE &apos;RG&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>    END OF lc_parvw.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>     lc_contact1 TYPE parvw VALUE &apos;AP&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>     lc_contact2 TYPE parvw VALUE &apos;ZA&apos;. &quot; Partner Function</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_doc_num_temp TYPE ty_t_doc_num.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_doc_num_temp[] = fp_i_doc_num[].</FPCLINE>
      <FPCLINE>  SORT li_doc_num_temp BY vbeln.</FPCLINE>
      <FPCLINE>  DELETE ADJACENT DUPLICATES FROM li_doc_num_temp COMPARING vbeln.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF NOT li_doc_num_temp[] IS INITIAL.</FPCLINE>
      <FPCLINE>    SELECT vbeln &quot; Sales and Distribution Document Number</FPCLINE>
      <FPCLINE>           posnr &quot; Item number of the SD document</FPCLINE>
      <FPCLINE>           parvw &quot; Partner Function</FPCLINE>
      <FPCLINE>           kunnr &quot; Customer Number</FPCLINE>
      <FPCLINE>           adrnr &quot; Address</FPCLINE>
      <FPCLINE>           land1 &quot; Country Key</FPCLINE>
      <FPCLINE>      FROM vbpa  &quot; Sales Document: Partner</FPCLINE>
      <FPCLINE>      INTO TABLE fp_i_vbpa</FPCLINE>
      <FPCLINE>       FOR ALL ENTRIES IN li_doc_num_temp</FPCLINE>
      <FPCLINE>     WHERE vbeln EQ li_doc_num_temp-vbeln</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>*       AND  parvw IN (lc_parvw-bill_to, lc_parvw-ship_to, lc_parvw-sold_to, lc_parvw-payer ).</FPCLINE>
      <FPCLINE>       AND  parvw IN (lc_parvw-bill_to, lc_parvw-ship_to, lc_parvw-sold_to,</FPCLINE>
      <FPCLINE>                      lc_parvw-payer, lc_contact1, lc_contact2 ).</FPCLINE>
      <FPCLINE>* &lt;--- End   of Change for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      SORT fp_i_vbpa BY vbeln parvw.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF NOT li_doc_num_temp[] IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_vbpa</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_konv</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get All Conditions</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_KNUMV   Condition Doc Num</FPCLINE>
      <FPCLINE>*      &lt;--FP_I_KONV  Condition Types</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_konv USING fp_knumv  TYPE knumv &quot; Number of the document condition</FPCLINE>
      <FPCLINE>             CHANGING fp_i_konv TYPE ty_t_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  SELECT kschl &quot; Condition type</FPCLINE>
      <FPCLINE>         kposn &quot; Condition item number</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>         kdatu &quot;Condition pricing date</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>         kawrt &quot; Condition base value</FPCLINE>
      <FPCLINE>         kbetr &quot; Rate (condition amount or percentage)</FPCLINE>
      <FPCLINE>         kwert &quot; Condition value</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>         knumh</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>         mwsk1 &quot; Tax on sales/purchases code</FPCLINE>
      <FPCLINE>         kinak &quot; Condition is inactive</FPCLINE>
      <FPCLINE>         koaid &quot; Condition class</FPCLINE>
      <FPCLINE>    FROM konv  &quot; Conditions (Transaction Data)</FPCLINE>
      <FPCLINE>    INTO TABLE fp_i_konv</FPCLINE>
      <FPCLINE>    WHERE knumv EQ fp_knumv</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>* Only consider active conditions</FPCLINE>
      <FPCLINE>    AND   kinak EQ space.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    SORT fp_i_konv BY kschl kinak koaid.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_konv</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_license</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       text</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_license USING fp_i_konv     TYPE ty_t_konv</FPCLINE>
      <FPCLINE>                         fp_kunwe      TYPE kunnr      &quot; Customer Number</FPCLINE>
      <FPCLINE>                         fp_kschl      TYPE fpb_high   &quot; To Value</FPCLINE>
      <FPCLINE>                   CHANGING fp_lic_no   TYPE licno     &quot; Tax exemption license number</FPCLINE>
      <FPCLINE>                            fp_lic_date TYPE licdt     &quot; Date license granted</FPCLINE>
      <FPCLINE>                            fp_prnum    TYPE prnum_nr. &quot; Log number for tax exemption licenses</FPCLINE>
      <FPCLINE>  DATA: li_konh  TYPE STANDARD TABLE OF konh, &quot; Conditions (Header)</FPCLINE>
      <FPCLINE>        lwa_konh TYPE konh.                   &quot; Conditions (Header)</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF fp_i_konv[] IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    SELECT * FROM konh &quot; Conditions (Header)</FPCLINE>
      <FPCLINE>           INTO TABLE li_konh</FPCLINE>
      <FPCLINE>           FOR ALL ENTRIES IN  fp_i_konv</FPCLINE>
      <FPCLINE>           WHERE  knumh = fp_i_konv-knumh</FPCLINE>
      <FPCLINE>           AND    kschl = fp_kschl.</FPCLINE>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      READ TABLE li_konh INTO lwa_konh INDEX 1.</FPCLINE>
      <FPCLINE>      IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>        fp_lic_no   = lwa_konh-licno.</FPCLINE>
      <FPCLINE>        fp_lic_date = lwa_konh-licdt.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      IF fp_lic_no IS NOT INITIAL AND fp_kunwe IS NOT INITIAL.</FPCLINE>
      <FPCLINE>        SELECT SINGLE prnum_nr  &quot; Log number for tax exemption licenses</FPCLINE>
      <FPCLINE>                      INTO fp_prnum</FPCLINE>
      <FPCLINE>                      FROM tlic &quot; Tax Exemption License</FPCLINE>
      <FPCLINE>                      WHERE licno = fp_lic_no</FPCLINE>
      <FPCLINE>                      AND   kunnr = fp_kunwe.</FPCLINE>
      <FPCLINE>        IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>          CLEAR: fp_prnum.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      ENDIF. &quot; IF fp_lic_no IS NOT INITIAL AND fp_kunwe IS NOT INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF fp_i_konv[] IS NOT INITIAL</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_license</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_vbrp</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get Item Details</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_VBELN     Billing Document</FPCLINE>
      <FPCLINE>*      &lt;--FP_I_VBRP    Item Details</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_vbrp USING fp_vbeln  TYPE vbeln_vf &quot; Billing Document</FPCLINE>
      <FPCLINE>             CHANGING fp_i_vbrp TYPE ty_t_vbrp.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  SELECT vbeln &quot; Billing Document</FPCLINE>
      <FPCLINE>         posnr &quot; Billing item</FPCLINE>
      <FPCLINE>         netwr &quot; Net value of the billing item in document currency</FPCLINE>
      <FPCLINE>         vgbel &quot; Document number of the reference document</FPCLINE>
      <FPCLINE>         abrbg &quot; Start of accounting settlement period</FPCLINE>
      <FPCLINE>         fplnr &quot; Billing plan number / invoicing plan number</FPCLINE>
      <FPCLINE>         fpltr &quot; Item for billing plan/invoice plan/payment cards</FPCLINE>
      <FPCLINE>         mwsbp &quot; Tax amount in document currency</FPCLINE>
      <FPCLINE>         fareg &quot; Rule in billing plan/invoice plan</FPCLINE>
      <FPCLINE>    FROM vbrp  &quot; Billing Document: Item Data</FPCLINE>
      <FPCLINE>    INTO TABLE fp_i_vbrp</FPCLINE>
      <FPCLINE>    WHERE vbeln EQ fp_vbeln.</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    SORT fp_i_vbrp BY vbeln posnr.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_vbrp</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_logo</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get Bio-Rad Logo</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_logo.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_graphics    TYPE tdobjectgr VALUE &apos;GRAPHICS&apos;,     &quot; SAPscript Graphics Management: Application object</FPCLINE>
      <FPCLINE>    lc_logo_image  TYPE tdobname   VALUE &apos;ZBIORAD_LOGO&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    lc_image_id    TYPE tdidgr     VALUE &apos;BMAP&apos;,         &quot; SAPscript Graphics Management: ID</FPCLINE>
      <FPCLINE>    lc_image_type  TYPE tdbtype    VALUE &apos;BCOL&apos;.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CALL METHOD cl_ssf_xsf_utilities=&gt;get_bds_graphic_as_bmp</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      p_object       = lc_graphics</FPCLINE>
      <FPCLINE>      p_name         = lc_logo_image</FPCLINE>
      <FPCLINE>      p_id           = lc_image_id</FPCLINE>
      <FPCLINE>      p_btype        = lc_image_type</FPCLINE>
      <FPCLINE>    RECEIVING</FPCLINE>
      <FPCLINE>      p_bmp          = gv_logo</FPCLINE>
      <FPCLINE>    EXCEPTIONS</FPCLINE>
      <FPCLINE>      not_found      = 1</FPCLINE>
      <FPCLINE>      internal_error = 2</FPCLINE>
      <FPCLINE>      OTHERS         = 3.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>* Display error message</FPCLINE>
      <FPCLINE>    MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno</FPCLINE>
      <FPCLINE>          WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_logo</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_read_sorg_post_add</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get Sales Org. Address Data</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_ADRNR    Sales Org. Address Number</FPCLINE>
      <FPCLINE>*      --&gt;FP_SORG     Sales Org.</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_read_sorg_post_add USING fp_adrnr   TYPE ad_addrnum &quot; Address number</FPCLINE>
      <FPCLINE>                                fp_sorg    TYPE vkorg.     &quot; Sales Organization</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_add_typ_org   TYPE ad_adrtype VALUE &apos;1&apos;,                           &quot; Address type (1=Organization, 2=Person, 3=Contact person)</FPCLINE>
      <FPCLINE>    lc_num_of_lines  TYPE anzei      VALUE &apos;5&apos;,                           &quot; Number of lines in address</FPCLINE>
      <FPCLINE>    lc_std_sorg_name TYPE tdobname   VALUE &apos;ZOTC_0014_D3_SORG_XXXX_NAME&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    lc_unknown_sorg  TYPE string     VALUE &apos;XXXX&apos;,</FPCLINE>
      <FPCLINE>    lc_tdobject      TYPE tdobject   VALUE &apos;TEXT&apos;,                        &quot; Texts: Application Object</FPCLINE>
      <FPCLINE>    lc_tdid          TYPE tdid       VALUE &apos;ST&apos;,                          &quot; Text ID</FPCLINE>
      <FPCLINE>    lc_tdspras       TYPE spras      VALUE &apos;EN&apos;,                          &quot; Language Key</FPCLINE>
      <FPCLINE>    lc_no_upper_case TYPE xfeld      VALUE &apos;X&apos;,                           &quot; Checkbox</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>    lc_vkorg_it      TYPE vkorg      VALUE &apos;2037&apos;, &quot; Sales Organization</FPCLINE>
      <FPCLINE>    lc_mi            TYPE char4      VALUE &apos;(MI)&apos;. &quot; Region</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_std_text TYPE tdobname. &quot; Name</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_address TYPE fsbp_address_printf_line, &quot; Print Form Row</FPCLINE>
      <FPCLINE>    lwa_line    TYPE tline.                    &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_lines   TYPE tline_t,</FPCLINE>
      <FPCLINE>    li_address TYPE fsbp_address_printf_line_tty.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get Sales Org. Address</FPCLINE>
      <FPCLINE>  CALL FUNCTION &apos;ADDRESS_INTO_PRINTFORM&apos;</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      address_type                   = lc_add_typ_org</FPCLINE>
      <FPCLINE>      address_number                 = fp_adrnr</FPCLINE>
      <FPCLINE>      receiver_language              = gv_form_lang</FPCLINE>
      <FPCLINE>      number_of_lines                = lc_num_of_lines</FPCLINE>
      <FPCLINE>      country_name_in_receiver_langu = abap_true</FPCLINE>
      <FPCLINE>*     language_for_country_name      = gv_form_lang</FPCLINE>
      <FPCLINE>      no_upper_case_for_city         = lc_no_upper_case</FPCLINE>
      <FPCLINE>      iv_country_name_separate_line  = abap_true</FPCLINE>
      <FPCLINE>    IMPORTING</FPCLINE>
      <FPCLINE>      address_printform_table        = li_address.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  LOOP AT li_address INTO lwa_address.</FPCLINE>
      <FPCLINE>*  Only five lines read from Address and Printed on Form</FPCLINE>
      <FPCLINE>    CASE sy-tabix.</FPCLINE>
      <FPCLINE>      WHEN 1.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Check for Sales Organization other than Italy</FPCLINE>
      <FPCLINE>        IF fp_sorg NE lc_vkorg_it.</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>          x_sorg_add-line1 = lwa_address-address_line.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF fp_sorg NE lc_vkorg_it</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>      WHEN 2.</FPCLINE>
      <FPCLINE>        x_sorg_add-line2 = lwa_address-address_line.</FPCLINE>
      <FPCLINE>      WHEN 3.</FPCLINE>
      <FPCLINE>        x_sorg_add-line3 = lwa_address-address_line.</FPCLINE>
      <FPCLINE>      WHEN 4.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Adding Region &apos;(MI)&apos; for Italy in header</FPCLINE>
      <FPCLINE>        IF fp_sorg EQ lc_vkorg_it.</FPCLINE>
      <FPCLINE>          x_sorg_add-line4 = lwa_address-address_line.</FPCLINE>
      <FPCLINE>          CONCATENATE x_sorg_add-line4 lc_mi INTO x_sorg_add-line4 SEPARATED BY space.</FPCLINE>
      <FPCLINE>        ELSE. &quot; ELSE -&gt; IF fp_sorg EQ lc_vkorg_it</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>          x_sorg_add-line4 = lwa_address-address_line.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF fp_sorg EQ lc_vkorg_it</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>      WHEN 5.</FPCLINE>
      <FPCLINE>        x_sorg_add-line5 = lwa_address-address_line.</FPCLINE>
      <FPCLINE>    ENDCASE.</FPCLINE>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT li_address INTO lwa_address</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>** Std Text for getting Sales Org. Name if it exists</FPCLINE>
      <FPCLINE>*  lv_std_text = lc_std_sorg_name.</FPCLINE>
      <FPCLINE>*  REPLACE lc_unknown_sorg WITH fp_sorg INTO lv_std_text.</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>** Retrieve Text</FPCLINE>
      <FPCLINE>*  CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>*    EXPORTING</FPCLINE>
      <FPCLINE>*      id                      = lc_tdid</FPCLINE>
      <FPCLINE>*      language                = lc_tdspras</FPCLINE>
      <FPCLINE>*      name                    = lv_std_text</FPCLINE>
      <FPCLINE>*      object                  = lc_tdobject</FPCLINE>
      <FPCLINE>*    TABLES</FPCLINE>
      <FPCLINE>*      lines                   = li_lines</FPCLINE>
      <FPCLINE>*    EXCEPTIONS</FPCLINE>
      <FPCLINE>*      id                      = 1</FPCLINE>
      <FPCLINE>*      language                = 1</FPCLINE>
      <FPCLINE>*      name                    = 1</FPCLINE>
      <FPCLINE>*      not_found               = 1</FPCLINE>
      <FPCLINE>*      object                  = 1</FPCLINE>
      <FPCLINE>*      reference_check         = 1</FPCLINE>
      <FPCLINE>*      wrong_access_to_archive = 1</FPCLINE>
      <FPCLINE>*      OTHERS                  = 1.</FPCLINE>
      <FPCLINE>*  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*    READ TABLE li_lines INTO lwa_line INDEX 1.</FPCLINE>
      <FPCLINE>*    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*      x_sorg_add-line1 = lwa_line-tdline.</FPCLINE>
      <FPCLINE>*    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Delete for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_read_sorg_post_add</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_check_duplicate_print</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Duplicate Print indicator</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_NAST  Message Status</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_check_duplicate_print USING fp_nast TYPE nast. &quot; Message Status</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_success TYPE na_vstat VALUE &apos;1&apos;. &quot; Processing status of message</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA: lv_vstat TYPE na_vstat. &quot; Processing status of message</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  SELECT vstat &quot; Processing status of message</FPCLINE>
      <FPCLINE>    INTO lv_vstat</FPCLINE>
      <FPCLINE>    FROM nast  &quot; Message Status</FPCLINE>
      <FPCLINE>    UP TO 1 ROWS</FPCLINE>
      <FPCLINE>    WHERE kappl = fp_nast-kappl</FPCLINE>
      <FPCLINE>      AND objky = gv_vbeln</FPCLINE>
      <FPCLINE>      AND kschl = fp_nast-kschl</FPCLINE>
      <FPCLINE>      AND spras = fp_nast-spras</FPCLINE>
      <FPCLINE>      AND parnr = fp_nast-parnr</FPCLINE>
      <FPCLINE>      AND parvw = fp_nast-parvw</FPCLINE>
      <FPCLINE>      AND nacha = fp_nast-nacha</FPCLINE>
      <FPCLINE>      AND vstat = lc_success.</FPCLINE>
      <FPCLINE>  ENDSELECT.</FPCLINE>
      <FPCLINE>  IF sy-subrc = 0 AND lv_vstat IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    gv_duplicate_flag = abap_true.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0 AND lv_vstat IS NOT INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_check_duplicate_print</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_sales_order_info</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Sales Order Information</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_ITEM_DETAIL  Invoice items</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_sales_order_info USING fp_i_item_detail TYPE invoice_t_prt_item_detail.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  TYPES:</FPCLINE>
      <FPCLINE>    BEGIN OF lty_vbkd,</FPCLINE>
      <FPCLINE>      vbeln	TYPE vbeln, &quot; Sales Document</FPCLINE>
      <FPCLINE>      bstkd	TYPE bstkd,</FPCLINE>
      <FPCLINE>    END OF lty_vbkd.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_item_detail      TYPE invoice_s_prt_item_detail, &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE>    lwa_sales_order_info TYPE ty_sales_order_info,</FPCLINE>
      <FPCLINE>    lwa_vbkd             TYPE lty_vbkd.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_item_detail TYPE invoice_t_prt_item_detail,</FPCLINE>
      <FPCLINE>    li_vbkd        TYPE STANDARD TABLE OF lty_vbkd.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_posnr_0 TYPE posnr VALUE &apos;000000&apos;. &quot; Item number of the SD document</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_item_detail = fp_i_item_detail.</FPCLINE>
      <FPCLINE>  SORT li_item_detail BY vbdpr-vbeln_vauf.</FPCLINE>
      <FPCLINE>  DELETE ADJACENT DUPLICATES FROM li_item_detail COMPARING vbdpr-vbeln_vauf.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF NOT li_item_detail IS INITIAL.</FPCLINE>
      <FPCLINE>* All Primary key field not selected as it is not required</FPCLINE>
      <FPCLINE>    SELECT vbeln &quot; Sales and Distribution Document Number</FPCLINE>
      <FPCLINE>           bstkd &quot; Customer purchase order number</FPCLINE>
      <FPCLINE>      FROM vbkd  &quot; Sales Document: Business Data</FPCLINE>
      <FPCLINE>      INTO TABLE li_vbkd</FPCLINE>
      <FPCLINE>      FOR ALL ENTRIES IN li_item_detail</FPCLINE>
      <FPCLINE>      WHERE vbeln EQ li_item_detail-vbdpr-vbeln_vauf</FPCLINE>
      <FPCLINE>      AND   posnr EQ lc_posnr_0.</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      SORT li_vbkd BY vbeln.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF NOT li_item_detail IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  LOOP AT li_item_detail INTO lwa_item_detail.</FPCLINE>
      <FPCLINE>    lwa_sales_order_info-aubel = lwa_item_detail-vbdpr-vbeln_vauf.</FPCLINE>
      <FPCLINE>    READ TABLE li_vbkd INTO lwa_vbkd</FPCLINE>
      <FPCLINE>                       WITH KEY vbeln = lwa_item_detail-vbdpr-vbeln_vauf</FPCLINE>
      <FPCLINE>                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      lwa_sales_order_info-bstkd = lwa_vbkd-bstkd.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    APPEND lwa_sales_order_info TO i_sales_order_info.</FPCLINE>
      <FPCLINE>    CLEAR lwa_sales_order_info.</FPCLINE>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT li_item_detail INTO lwa_item_detail</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  SORT i_sales_order_info BY aubel.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_sales_order_info</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_cust_service_phone</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Bio-Rad Customer Service Logo / Telephone number</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_SORG             Sales Organization</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_ITEM_DETAIL    Item Details</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_cust_service_phone USING fp_sorg          TYPE vkorg &quot; Sales Organization</FPCLINE>
      <FPCLINE>                                    fp_i_item_detail TYPE invoice_t_prt_item_detail</FPCLINE>
      <FPCLINE>                                    fp_i_emi_constants TYPE ty_t_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_graphics          TYPE tdobjectgr VALUE &apos;GRAPHICS&apos;,                   &quot; SAPscript Graphics Management: Application object</FPCLINE>
      <FPCLINE>    lc_image_id          TYPE tdidgr     VALUE &apos;BMAP&apos;,                       &quot; SAPscript Graphics Management: ID</FPCLINE>
      <FPCLINE>    lc_image_type        TYPE tdbtype    VALUE &apos;BCOL&apos;,</FPCLINE>
      <FPCLINE>    lc_cs_phone_image    TYPE tdobname   VALUE &apos;ZOTC_0014_D3_LOGO_CS_XXXX&apos;,  &quot; Name</FPCLINE>
      <FPCLINE>    lc_unknown_sorg      TYPE string     VALUE &apos;XXXX&apos;,</FPCLINE>
      <FPCLINE>    lc_cs_phone_std_text TYPE tdobname   VALUE &apos;ZOTC_0014_D3_PHONE_CS_XXXX&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    lc_enh_criteria_bom  TYPE z_criteria VALUE &apos;BOM&apos;.                        &quot; Enh. Criteria</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_cs_phone_image TYPE tdobname, &quot; Name</FPCLINE>
      <FPCLINE>    lv_vkorg          TYPE vkorg.    &quot; Sales Organization</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lw_item_detail    TYPE invoice_s_prt_item_detail. &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>*---&gt; Begin of delete for CR#356 by U033867</FPCLINE>
      <FPCLINE>** Get CS image Name</FPCLINE>
      <FPCLINE>*  lv_cs_phone_image = lc_cs_phone_image.</FPCLINE>
      <FPCLINE>*  REPLACE lc_unknown_sorg WITH fp_sorg INTO lv_cs_phone_image.</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>*  CALL METHOD cl_ssf_xsf_utilities=&gt;get_bds_graphic_as_bmp</FPCLINE>
      <FPCLINE>*    EXPORTING</FPCLINE>
      <FPCLINE>*      p_object       = lc_graphics</FPCLINE>
      <FPCLINE>*      p_name         = lv_cs_phone_image</FPCLINE>
      <FPCLINE>*      p_id           = lc_image_id</FPCLINE>
      <FPCLINE>*      p_btype        = lc_image_type</FPCLINE>
      <FPCLINE>*    RECEIVING</FPCLINE>
      <FPCLINE>*      p_bmp          = gv_cs_phone_image</FPCLINE>
      <FPCLINE>*    EXCEPTIONS</FPCLINE>
      <FPCLINE>*      not_found      = 1</FPCLINE>
      <FPCLINE>*      internal_error = 2</FPCLINE>
      <FPCLINE>*      OTHERS         = 3.</FPCLINE>
      <FPCLINE>*&lt;--- End of delete for CR#356 by u033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>*  CASE sy-subrc.</FPCLINE>
      <FPCLINE>*    WHEN 0.</FPCLINE>
      <FPCLINE>*      gv_cs_phone_image_flag = abap_true.</FPCLINE>
      <FPCLINE>*    WHEN 1.</FPCLINE>
      <FPCLINE>*      READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>*                                    WITH KEY criteria = lc_enh_criteria_bom</FPCLINE>
      <FPCLINE>*                                             sel_low  = fp_sorg.</FPCLINE>
      <FPCLINE>**     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>*      IF sy-subrc EQ 0 .</FPCLINE>
      <FPCLINE>*        READ TABLE fp_i_item_detail INTO lw_item_detail INDEX 1.</FPCLINE>
      <FPCLINE>*        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*          lv_vkorg =  lw_item_detail-vbdpr-vkbur.</FPCLINE>
      <FPCLINE>*        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*      ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*        lv_vkorg = fp_sorg.</FPCLINE>
      <FPCLINE>*      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*      gv_cs_phone_std_txt = lc_cs_phone_std_text.</FPCLINE>
      <FPCLINE>*      REPLACE lc_unknown_sorg WITH lv_vkorg INTO gv_cs_phone_std_txt.</FPCLINE>
      <FPCLINE>*    WHEN OTHERS.</FPCLINE>
      <FPCLINE>**    Display error message</FPCLINE>
      <FPCLINE>*      MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno</FPCLINE>
      <FPCLINE>*            WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.</FPCLINE>
      <FPCLINE>*  ENDCASE.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*---&gt; Begin of delete for CR#356 by U033867</FPCLINE>
      <FPCLINE>*  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>*    gv_cs_phone_image_flag = abap_true.</FPCLINE>
      <FPCLINE>*  ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>*&lt;--- End of delete for CR#356 by u033867</FPCLINE>
      <FPCLINE>  gv_cs_phone_std_txt = lc_cs_phone_std_text.</FPCLINE>
      <FPCLINE>  REPLACE lc_unknown_sorg WITH fp_sorg INTO gv_cs_phone_std_txt.</FPCLINE>
      <FPCLINE>*---&gt; Begin of delete for CR#356 by U033867</FPCLINE>
      <FPCLINE>*  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>*&lt;--- End of delete for CR#356 by u033867</FPCLINE>
      <FPCLINE>* &lt;--- End of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_cust_service_phone</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_cust_service_email</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Bio-Rad Customer Service Email</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_SORG             Sales Organization</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_ITEM_DETAIL    Item Details</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_cust_service_email USING fp_sorg            TYPE vkorg &quot; Sales Organization</FPCLINE>
      <FPCLINE>                                    fp_i_item_detail   TYPE invoice_t_prt_item_detail</FPCLINE>
      <FPCLINE>                                    fp_i_emi_constants TYPE ty_t_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_unknown_sorg      TYPE string     VALUE &apos;XXXX&apos;,</FPCLINE>
      <FPCLINE>    lc_cs_email_std_text TYPE tdobname   VALUE &apos;ZOTC_0014_D3_EMAIL_CS_XXXX&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    lc_enh_criteria_bom  TYPE z_criteria VALUE &apos;BOM&apos;.                        &quot; Enh. Criteria</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_vkorg  TYPE vkorg. &quot; Sales Organization</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lw_item_detail TYPE invoice_s_prt_item_detail. &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>*  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>*                                WITH KEY criteria = lc_enh_criteria_bom</FPCLINE>
      <FPCLINE>*                                         sel_low  = fp_sorg.</FPCLINE>
      <FPCLINE>** Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>*  IF sy-subrc EQ 0 .</FPCLINE>
      <FPCLINE>*    READ TABLE fp_i_item_detail INTO lw_item_detail INDEX 1.</FPCLINE>
      <FPCLINE>*    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*      lv_vkorg =  lw_item_detail-vbdpr-vkbur.</FPCLINE>
      <FPCLINE>*    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*  ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*    lv_vkorg = fp_sorg.</FPCLINE>
      <FPCLINE>*  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>  gv_cs_email_std_txt = lc_cs_email_std_text.</FPCLINE>
      <FPCLINE>*  REPLACE lc_unknown_sorg WITH lv_vkorg INTO gv_cs_email_std_txt.</FPCLINE>
      <FPCLINE>  REPLACE lc_unknown_sorg WITH fp_sorg INTO gv_cs_email_std_txt.</FPCLINE>
      <FPCLINE>* &lt;--- End of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_cust_service_email</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_bill_to_address</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Bill-To Party Address</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBPA                  Sales Doc Info</FPCLINE>
      <FPCLINE>*      --&gt;FP_BILLTO_LAND1            Country Key</FPCLINE>
      <FPCLINE>*      --&gt;FP_X_INVOICE_HEADER        Invoice Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_bill_to_address USING fp_i_vbpa           TYPE ty_t_vbpa</FPCLINE>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE>                                  fp_im_bil_prt_com  TYPE invoice_s_prt_interface</FPCLINE>
      <FPCLINE>                                  fp_im_nast         TYPE nast</FPCLINE>
      <FPCLINE>                                  fp_lv_adrnr        TYPE ad_addrnum</FPCLINE>
      <FPCLINE>** End of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE>                        CHANGING fp_billto_land1     TYPE land1 &quot; Country Key</FPCLINE>
      <FPCLINE>                                 fp_x_invoice_header TYPE ty_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_parvw_bill_to TYPE parvw      VALUE &apos;RE&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>    lc_add_typ_org   TYPE ad_adrtype VALUE &apos;1&apos;,  &quot; Address type (1=Organization, 2=Person, 3=Contact person)</FPCLINE>
      <FPCLINE>    lc_num_of_lines  TYPE anzei      VALUE &apos;6&apos;,  &quot; Number of lines in address</FPCLINE>
      <FPCLINE>    lc_no_upper_case TYPE xfeld      VALUE &apos;X&apos;,  &quot; Checkbox</FPCLINE>
      <FPCLINE>    lc_en_language   TYPE t002-spras VALUE &apos;EN&apos;.</FPCLINE>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_vbpa TYPE ty_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_adrnr TYPE ad_addrnum,</FPCLINE>
      <FPCLINE>    lv_region TYPE regio,</FPCLINE>
      <FPCLINE>    lwa_line   TYPE tline,</FPCLINE>
      <FPCLINE>    li_lines   TYPE tline_t,</FPCLINE>
      <FPCLINE>    lv_country TYPE land,</FPCLINE>
      <FPCLINE>    lv_vkorg TYPE vkorg,</FPCLINE>
      <FPCLINE>    lv_land1 TYPE land1,</FPCLINE>
      <FPCLINE>    lv_spras TYPE spras,</FPCLINE>
      <FPCLINE>    lv_spras_salesorg TYPE spras,</FPCLINE>
      <FPCLINE>    lv_spras_billto TYPE spras,</FPCLINE>
      <FPCLINE>    lv_country_billto TYPE land1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>** End of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  READ TABLE fp_i_vbpa INTO lwa_vbpa WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>                                              parvw = lc_parvw_bill_to</FPCLINE>
      <FPCLINE>                                     BINARY SEARCH.</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    fp_x_invoice_header-bill_to_kunnr = lwa_vbpa-kunnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Bill-To Country</FPCLINE>
      <FPCLINE>    fp_billto_land1 = lwa_vbpa-land1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Get Bill-To Address</FPCLINE>
      <FPCLINE>    CALL FUNCTION &apos;ADDRESS_INTO_PRINTFORM&apos;</FPCLINE>
      <FPCLINE>      EXPORTING</FPCLINE>
      <FPCLINE>        address_type                   = lc_add_typ_org</FPCLINE>
      <FPCLINE>        address_number                 = lwa_vbpa-adrnr</FPCLINE>
      <FPCLINE>        receiver_language              = gv_form_lang</FPCLINE>
      <FPCLINE>        number_of_lines                = lc_num_of_lines</FPCLINE>
      <FPCLINE>*       language_for_country_name      = gv_form_lang</FPCLINE>
      <FPCLINE>        country_name_in_receiver_langu = abap_true</FPCLINE>
      <FPCLINE>        no_upper_case_for_city         = lc_no_upper_case</FPCLINE>
      <FPCLINE>        iv_country_name_separate_line  = abap_true</FPCLINE>
      <FPCLINE>      IMPORTING</FPCLINE>
      <FPCLINE>        address_printform_table        = fp_x_invoice_header-bill_to_add.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>** Begin of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE>**Step 1. – Determine the source sales organization native language</FPCLINE>
      <FPCLINE>SELECT SINGLE country</FPCLINE>
      <FPCLINE>  INTO lv_country</FPCLINE>
      <FPCLINE>  FROM adrc</FPCLINE>
      <FPCLINE>  WHERE addrnumber = fp_im_bil_prt_com-head_detail-tvko-adrnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>** Step 2.Determine the Bill-To’s country native language</FPCLINE>
      <FPCLINE>        SELECT SINGLE country</FPCLINE>
      <FPCLINE>           INTO lv_country_billto</FPCLINE>
      <FPCLINE>           FROM adrc</FPCLINE>
      <FPCLINE>           WHERE addrnumber = fp_lv_adrnr.  &quot; lv_adrnr is fetched earlier above</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>            IF lv_country_billto NE lv_country.  &quot;Print in English</FPCLINE>
      <FPCLINE/>
      <FPCLINE>                CALL FUNCTION &apos;ADDRESS_INTO_PRINTFORM&apos;</FPCLINE>
      <FPCLINE>                  EXPORTING</FPCLINE>
      <FPCLINE>                    address_type                   = lc_add_typ_org</FPCLINE>
      <FPCLINE>                    address_number                 = lwa_vbpa-adrnr</FPCLINE>
      <FPCLINE>                    receiver_language              = lc_en_language</FPCLINE>
      <FPCLINE>                    number_of_lines                = lc_num_of_lines</FPCLINE>
      <FPCLINE>                    country_name_in_receiver_langu = abap_true</FPCLINE>
      <FPCLINE>                    no_upper_case_for_city         = lc_no_upper_case</FPCLINE>
      <FPCLINE>                    iv_country_name_separate_line  = abap_true</FPCLINE>
      <FPCLINE>                  IMPORTING</FPCLINE>
      <FPCLINE>                    address_printform_table        = fp_x_invoice_header-bill_to_add.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>            ENDIF.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          ENDIF.</FPCLINE>
      <FPCLINE>ENDIF.</FPCLINE>
      <FPCLINE>** Enf of SCTASK0793196/SCTASK0787285 R.1</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_bill_to_address</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_sold_to_address</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Sold-To Party Address</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBPA                  Sales Doc Info</FPCLINE>
      <FPCLINE>*      --&gt;FP_X_INVOICE_HEADER        Invoice Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_sold_to_address USING fp_i_vbpa TYPE ty_t_vbpa</FPCLINE>
      <FPCLINE>                        CHANGING fp_x_invoice_header TYPE ty_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_parvw_sold_to TYPE parvw      VALUE &apos;AG&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>    lc_add_typ_org   TYPE ad_adrtype VALUE &apos;1&apos;,  &quot; Address type (1=Organization, 2=Person, 3=Contact person)</FPCLINE>
      <FPCLINE>    lc_num_of_lines  TYPE anzei      VALUE &apos;6&apos;,  &quot; Number of lines in address</FPCLINE>
      <FPCLINE>    lc_no_upper_case TYPE xfeld      VALUE &apos;X&apos;.  &quot; Checkbox</FPCLINE>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_vbpa TYPE ty_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  READ TABLE fp_i_vbpa INTO lwa_vbpa WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>                                              parvw = lc_parvw_sold_to</FPCLINE>
      <FPCLINE>                                     BINARY SEARCH.</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    fp_x_invoice_header-sold_to_kunnr = lwa_vbpa-kunnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Get Bill-To Address</FPCLINE>
      <FPCLINE>    CALL FUNCTION &apos;ADDRESS_INTO_PRINTFORM&apos;</FPCLINE>
      <FPCLINE>      EXPORTING</FPCLINE>
      <FPCLINE>        address_type                   = lc_add_typ_org</FPCLINE>
      <FPCLINE>        address_number                 = lwa_vbpa-adrnr</FPCLINE>
      <FPCLINE>        receiver_language              = gv_form_lang</FPCLINE>
      <FPCLINE>        number_of_lines                = lc_num_of_lines</FPCLINE>
      <FPCLINE>        country_name_in_receiver_langu = abap_true</FPCLINE>
      <FPCLINE>*       language_for_country_name      = gv_form_lang</FPCLINE>
      <FPCLINE>        no_upper_case_for_city         = lc_no_upper_case</FPCLINE>
      <FPCLINE>        iv_country_name_separate_line  = abap_true</FPCLINE>
      <FPCLINE>      IMPORTING</FPCLINE>
      <FPCLINE>        address_printform_table        = fp_x_invoice_header-sold_to_add.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_sold_to_address</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_ship_to_address</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Ship-To Address</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBPA                  Invoice Partner Data</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_ITEM_DETAIL           Invoice Items</FPCLINE>
      <FPCLINE>*      --&gt;FP_X_INVOICE_HEADER        Invoice Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_ship_to_address USING fp_i_vbpa        TYPE ty_t_vbpa</FPCLINE>
      <FPCLINE>                                 fp_i_item_detail TYPE invoice_t_prt_item_detail</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                                 fp_i_vbrp        TYPE ty_t_vbrp</FPCLINE>
      <FPCLINE>* &lt;--- End    of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                        CHANGING fp_x_invoice_header TYPE ty_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_parvw_ship_to TYPE parvw      VALUE &apos;WE&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>    lc_add_typ_org   TYPE ad_adrtype VALUE &apos;1&apos;,  &quot; Address type (1=Organization, 2=Person, 3=Contact person)</FPCLINE>
      <FPCLINE>    lc_num_of_lines  TYPE anzei      VALUE &apos;6&apos;,  &quot; Number of lines in address</FPCLINE>
      <FPCLINE>    lc_no_upper_case TYPE xfeld      VALUE &apos;X&apos;.  &quot; Checkbox</FPCLINE>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_item_detail TYPE invoice_s_prt_item_detail, &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE>    lwa_vbpa        TYPE ty_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>  FIELD-SYMBOLS: &lt;lfs_vbrp&gt; TYPE ty_vbrp.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* This part of the code is commented and the new logic is implemmented below.</FPCLINE>
      <FPCLINE>* Get ECC6 Sales Order Number for First Item</FPCLINE>
      <FPCLINE>*  READ TABLE fp_i_item_detail INTO lwa_item_detail INDEX 1.</FPCLINE>
      <FPCLINE>*  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*    READ TABLE fp_i_vbpa INTO lwa_vbpa WITH KEY vbeln = lwa_item_detail-vbdpr-vbeln_vauf</FPCLINE>
      <FPCLINE>*                                                parvw = lc_parvw_ship_to</FPCLINE>
      <FPCLINE>*                                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>*    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*      fp_x_invoice_header-ship_to_kunnr = lwa_vbpa-kunnr.</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>**  Get Bill-To Address</FPCLINE>
      <FPCLINE>*      CALL FUNCTION &apos;ADDRESS_INTO_PRINTFORM&apos;</FPCLINE>
      <FPCLINE>*        EXPORTING</FPCLINE>
      <FPCLINE>*          address_type                  = lc_add_typ_org</FPCLINE>
      <FPCLINE>*          address_number                = lwa_vbpa-adrnr</FPCLINE>
      <FPCLINE>*          number_of_lines               = lc_num_of_lines</FPCLINE>
      <FPCLINE>*          language_for_country_name     = gv_form_lang</FPCLINE>
      <FPCLINE>*          iv_country_name_separate_line = abap_true</FPCLINE>
      <FPCLINE>*        IMPORTING</FPCLINE>
      <FPCLINE>*          address_printform_table       = fp_x_invoice_header-ship_to_add.</FPCLINE>
      <FPCLINE>*    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Delete Defect#6829(CR): D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* Get ECC6 Sales Order Number for First Item</FPCLINE>
      <FPCLINE>  READ TABLE fp_i_vbrp ASSIGNING &lt;lfs_vbrp&gt; INDEX 1.</FPCLINE>
      <FPCLINE>  IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>    READ TABLE fp_i_vbpa INTO lwa_vbpa WITH KEY vbeln = &lt;lfs_vbrp&gt;-vbeln</FPCLINE>
      <FPCLINE>                                                parvw = lc_parvw_ship_to</FPCLINE>
      <FPCLINE>                                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      fp_x_invoice_header-ship_to_kunnr = lwa_vbpa-kunnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Get Bill-To Address</FPCLINE>
      <FPCLINE>      CALL FUNCTION &apos;ADDRESS_INTO_PRINTFORM&apos;</FPCLINE>
      <FPCLINE>        EXPORTING</FPCLINE>
      <FPCLINE>          address_type                   = lc_add_typ_org</FPCLINE>
      <FPCLINE>          address_number                 = lwa_vbpa-adrnr</FPCLINE>
      <FPCLINE>          receiver_language              = gv_form_lang</FPCLINE>
      <FPCLINE>          number_of_lines                = lc_num_of_lines</FPCLINE>
      <FPCLINE>          country_name_in_receiver_langu = abap_true</FPCLINE>
      <FPCLINE>*         language_for_country_name      = gv_form_lang</FPCLINE>
      <FPCLINE>          no_upper_case_for_city         = lc_no_upper_case</FPCLINE>
      <FPCLINE>          iv_country_name_separate_line  = abap_true</FPCLINE>
      <FPCLINE>        IMPORTING</FPCLINE>
      <FPCLINE>          address_printform_table        = fp_x_invoice_header-ship_to_add.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert Defect#6829(CR): D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_ship_to_address</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_other_tax_numbers</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Other Tax Numbers</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_KUNAG                   Sold-to party</FPCLINE>
      <FPCLINE>*      --&gt;FP_X_INVOICE_HEADER        Invoice Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_other_tax_numbers USING fp_kunag TYPE kunag &quot; Sold-to party</FPCLINE>
      <FPCLINE>                          CHANGING fp_x_invoice_header TYPE ty_invoice_header.</FPCLINE>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_slash TYPE char1 VALUE &apos;\&apos;. &quot; Slash of type CHAR1</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_stcd1 TYPE stcd1, &quot; Tax Number 1</FPCLINE>
      <FPCLINE>    lv_stcd2 TYPE	stcd2.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  SELECT SINGLE stcd1 &quot; Tax Number 1</FPCLINE>
      <FPCLINE>                stcd2 &quot; Tax Number 2</FPCLINE>
      <FPCLINE>    FROM kna1         &quot; General Data in Customer Master</FPCLINE>
      <FPCLINE>    INTO (lv_stcd1, lv_stcd2)</FPCLINE>
      <FPCLINE>    WHERE kunnr EQ fp_kunag.</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    IF lv_stcd1 IS NOT INITIAL.</FPCLINE>
      <FPCLINE>      fp_x_invoice_header-other_tax_numbers = lv_stcd1.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF lv_stcd1 IS NOT INITIAL</FPCLINE>
      <FPCLINE>    IF lv_stcd2 IS NOT INITIAL.</FPCLINE>
      <FPCLINE>      IF fp_x_invoice_header-other_tax_numbers IS INITIAL.</FPCLINE>
      <FPCLINE>        fp_x_invoice_header-other_tax_numbers = lv_stcd2.</FPCLINE>
      <FPCLINE>      ELSE. &quot; ELSE -&gt; IF fp_x_invoice_header-other_tax_numbers IS INITIAL</FPCLINE>
      <FPCLINE>        CONCATENATE fp_x_invoice_header-other_tax_numbers lc_slash lv_stcd2</FPCLINE>
      <FPCLINE>               INTO fp_x_invoice_header-other_tax_numbers</FPCLINE>
      <FPCLINE>               SEPARATED BY space.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF fp_x_invoice_header-other_tax_numbers IS INITIAL</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF lv_stcd2 IS NOT INITIAL</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_other_tax_numbers</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_inv_items_table</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Build Invoice Items Table</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_X_HEAD_DETAIL     Head Details</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_ITEM_DETAIL     Item Details</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_EMI_CONSTANTS   Enhancement Status</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_KONV            Conditions</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBRP            Item Details</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBRK            Billing Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_inv_items_table USING fp_x_head_detail   TYPE invoice_s_prt_head_detail &quot; Header Details for Print</FPCLINE>
      <FPCLINE>                             fp_i_item_detail   TYPE invoice_t_prt_item_detail</FPCLINE>
      <FPCLINE>                             fp_i_emi_constants TYPE ty_t_emi_constants</FPCLINE>
      <FPCLINE>                             fp_i_konv          TYPE ty_t_konv</FPCLINE>
      <FPCLINE>                             fp_i_vbrp          TYPE ty_t_vbrp</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                             fp_i_vbrk          TYPE ty_t_vbrk</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>                             fp_im_bil_prt_com_header_vbeln TYPE vbeln. &quot; Sales Document number</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>  TYPES:</FPCLINE>
      <FPCLINE>    BEGIN OF lty_lips,</FPCLINE>
      <FPCLINE>     vbeln  TYPE vbeln_vl,   &quot; Delivery</FPCLINE>
      <FPCLINE>     posnr  TYPE posnr_vl,   &quot; Delivery Item</FPCLINE>
      <FPCLINE>     charg  TYPE charg_d,    &quot; Batch Number</FPCLINE>
      <FPCLINE>     kcmeng TYPE kcmeng,     &quot; Cumulative batch quantity of all split items (in StckUnit)</FPCLINE>
      <FPCLINE>     uecha  TYPE uecha,      &quot; Higher-Level Item of Batch Split Item</FPCLINE>
      <FPCLINE>     vfdat  TYPE vfdat,      &quot; Shelf Life Expiration or Best-Before Date</FPCLINE>
      <FPCLINE>    END OF lty_lips,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    BEGIN OF lty_items_no_print,</FPCLINE>
      <FPCLINE>      uecha	TYPE uecha,</FPCLINE>
      <FPCLINE>      posnr	TYPE posnr_vf,</FPCLINE>
      <FPCLINE>    END OF lty_items_no_print,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    BEGIN OF lty_ser01,</FPCLINE>
      <FPCLINE>      obknr	  TYPE objknr,   &quot; Object list number</FPCLINE>
      <FPCLINE>      lief_nr TYPE vbeln_vl, &quot; Delivery</FPCLINE>
      <FPCLINE>      posnr	  TYPE posnr_vl, &quot; Delivery Item</FPCLINE>
      <FPCLINE>    END OF lty_ser01,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    BEGIN OF lty_objk,</FPCLINE>
      <FPCLINE>      obknr TYPE objknr,     &quot; Object list number</FPCLINE>
      <FPCLINE>      obzae	TYPE objza,</FPCLINE>
      <FPCLINE>      sernr TYPE gernr,      &quot; Serial Number</FPCLINE>
      <FPCLINE>    END OF lty_objk,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    BEGIN OF lty_knmt,</FPCLINE>
      <FPCLINE>      vkorg TYPE vkorg,      &quot; Sales Organization</FPCLINE>
      <FPCLINE>      vtweg	TYPE vtweg,</FPCLINE>
      <FPCLINE>      kunnr	TYPE kunnr_v,</FPCLINE>
      <FPCLINE>      matnr TYPE matnr,      &quot; Material Number</FPCLINE>
      <FPCLINE>      kdmat	TYPE matnr_ku,   &quot; Material Number Used by Customer</FPCLINE>
      <FPCLINE>    END OF lty_knmt,</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Structure to fetch data form KONV table to check tax split for Italy</FPCLINE>
      <FPCLINE>    BEGIN OF lty_cond,</FPCLINE>
      <FPCLINE>      kposn TYPE kposn, &quot; Condition item number</FPCLINE>
      <FPCLINE>      kschl TYPE kscha, &quot; Condition type</FPCLINE>
      <FPCLINE>      kntyp TYPE kntyp, &quot; Condition category</FPCLINE>
      <FPCLINE>      kinak TYPE kinak, &quot; Inactive condition</FPCLINE>
      <FPCLINE>    END OF lty_cond.</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>*values of FAREG are SAP standards for down payments for 4 &amp; 5,</FPCLINE>
      <FPCLINE>*and value 6 is supplied from interface and checed in code to populate</FPCLINE>
      <FPCLINE>*text</FPCLINE>
      <FPCLINE>    BEGIN OF lc_fareg,</FPCLINE>
      <FPCLINE>      down_payment_4 TYPE fareg VALUE &apos;4&apos;,            &quot; Down payment in milestone billing on percentage basis</FPCLINE>
      <FPCLINE>      down_payment_5 TYPE fareg VALUE &apos;5&apos;,            &quot; Down payment in milestone billing on a value basis</FPCLINE>
      <FPCLINE>      per_billing_6  TYPE fareg VALUE &apos;6&apos;,            &quot; Periodic billing (rent)</FPCLINE>
      <FPCLINE>    END OF lc_fareg,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    BEGIN OF lc_enh_criteria,</FPCLINE>
      <FPCLINE>      delvy       TYPE z_criteria VALUE &apos;DELVY&apos;,      &quot; Enhancement Criteria</FPCLINE>
      <FPCLINE>      bom         TYPE z_criteria VALUE &apos;BOM&apos;,        &quot; Enhancement Criteria</FPCLINE>
      <FPCLINE>      cust_sales  TYPE z_criteria VALUE &apos;CUST_SALES&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>      inter_comp  TYPE z_criteria VALUE &apos;INTER_COMP&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>      fkart_wia   TYPE z_criteria VALUE &apos;FKART_WIA&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>      kschl_wia   TYPE z_criteria VALUE &apos;KSCHL_WIA&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>  END OF lc_enh_criteria,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  BEGIN OF lc_std_text,</FPCLINE>
      <FPCLINE>    start_date TYPE tdobname VALUE &apos;ZOTC_0014_PERIOD_START_DATE&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    end_date   TYPE tdobname VALUE &apos;ZOTC_0014_PERIOD_END_DATE&apos;,   &quot; Name</FPCLINE>
      <FPCLINE>  END OF lc_std_text,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  lc_koaid_taxes TYPE koaid    VALUE &apos;D&apos;,                         &quot; Condition class - Taxes</FPCLINE>
      <FPCLINE>  lc_posnr_0     TYPE posnr    VALUE &apos;000000&apos;,                    &quot; Line Item zero</FPCLINE>
      <FPCLINE>  lc_vgtyp_j     TYPE vbtyp_v  VALUE &apos;J&apos;,                         &quot; Document category of preceding SD document</FPCLINE>
      <FPCLINE>  lc_slash       TYPE char01   VALUE &apos;/&apos;,                         &quot; Slash</FPCLINE>
      <FPCLINE>  lc_hyphen      TYPE char1    VALUE &apos;-&apos;,                         &quot; Hyphen</FPCLINE>
      <FPCLINE>  lc_percentage  TYPE char1    VALUE &apos;%&apos;,                         &quot; Percentage</FPCLINE>
      <FPCLINE>  lc_tdobject    TYPE tdobject VALUE &apos;TEXT&apos;,                      &quot; Texts: Application Object</FPCLINE>
      <FPCLINE>  lc_tdid        TYPE tdid     VALUE &apos;ST&apos;,                        &quot; Text ID</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>  lc_zero        TYPE char1    VALUE &apos;0&apos;, &quot; Zero</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>*Begin of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>  lc_text_from    TYPE tdobname   VALUE &apos;ZOTC_0014_FROM&apos;,    &quot; Name</FPCLINE>
      <FPCLINE>  lc_text_service TYPE tdobname   VALUE &apos;ZOTC_0014_SERVICE&apos;, &quot; Name</FPCLINE>
      <FPCLINE>  lc_equal        TYPE char1      VALUE &apos;=&apos;,                 &quot; Equal of type CHAR1</FPCLINE>
      <FPCLINE>*End of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>  lc_prsfd              TYPE prsfd VALUE &apos;B&apos;,             &quot; Carry out pricing</FPCLINE>
      <FPCLINE>  lc_enh_criteria_vkorg TYPE z_criteria VALUE &apos;VKORG_D3&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>   lc_ivkorg            TYPE vkorg VALUE &apos;2037&apos;. &quot; Sales Organization -Italy</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  FIELD-SYMBOLS:</FPCLINE>
      <FPCLINE>    &lt;lfs_item_detail&gt; TYPE invoice_s_prt_item_detail, &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE>    &lt;lfs_inv_items&gt;   TYPE ty_inv_items,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    &lt;lfs_emi&gt;         TYPE zdev_enh_status, &quot; Enhancement Status</FPCLINE>
      <FPCLINE>    &lt;lfs_vbrk&gt;        TYPE ty_vbrk.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_bom_comp_flag TYPE char1,  &quot; Flag if Item is a BOM Component (&apos;X&apos; = True)</FPCLINE>
      <FPCLINE>    lv_uecha         TYPE uecha,  &quot; Higher-Level Item of Batch Split Item</FPCLINE>
      <FPCLINE>    lv_unit_price    TYPE netwr,  &quot; Currency amount in BAPI interfaces</FPCLINE>
      <FPCLINE>    lv_date_str      TYPE char15, &quot; Date_str of type CHAR15</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>    lv_quantity_tmp  TYPE int4, &quot; Temporary Field for Quantity</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*Begin of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>    lv_text_name TYPE tdobname, &quot; Name</FPCLINE>
      <FPCLINE>    lv_text      TYPE tdline,   &quot; Text Line</FPCLINE>
      <FPCLINE>*End of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>    lv_count     TYPE int2,  &quot; 2 byte integer (signed)</FPCLINE>
      <FPCLINE>    lv_knumv     TYPE knumv. &quot; Number of the document condition</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_konv             TYPE ty_konv,</FPCLINE>
      <FPCLINE>    lwa_inv_items        TYPE ty_inv_items,</FPCLINE>
      <FPCLINE>    lwa_inv_bom_items    TYPE zotc_0014_inv_bom_items,   &quot; BOM Components for Invoice Items</FPCLINE>
      <FPCLINE>    lwa_vbrp             TYPE ty_vbrp,</FPCLINE>
      <FPCLINE>    lwa_lips             TYPE lty_lips,</FPCLINE>
      <FPCLINE>    lwa_batch_numbers    TYPE zotc_0014_inv_items_batch, &quot; Batch Numbers for Invoice Items</FPCLINE>
      <FPCLINE>    lwa_item_detail_tmp  TYPE invoice_s_prt_item_detail, &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE>    lwa_items_no_print   TYPE lty_items_no_print,</FPCLINE>
      <FPCLINE>    lwa_ser01            TYPE lty_ser01,</FPCLINE>
      <FPCLINE>    lwa_objk             TYPE lty_objk,</FPCLINE>
      <FPCLINE>    lwa_knmt             TYPE lty_knmt,</FPCLINE>
      <FPCLINE>    lwa_line             TYPE tline,                     &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE>    lwa_sales_order_info TYPE	ty_sales_order_info,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>    lwa_tvap             TYPE ty_tvap.</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_item_detail_temp        TYPE invoice_t_prt_item_detail,</FPCLINE>
      <FPCLINE>    li_item_detail_higher_item TYPE invoice_t_prt_item_detail,</FPCLINE>
      <FPCLINE>    li_item_detail_sub_item    TYPE invoice_t_prt_item_detail,</FPCLINE>
      <FPCLINE>    li_konv                    TYPE ty_t_konv,</FPCLINE>
      <FPCLINE>    li_lips                    TYPE STANDARD TABLE OF lty_lips,</FPCLINE>
      <FPCLINE>    li_ser01                   TYPE STANDARD TABLE OF lty_ser01,</FPCLINE>
      <FPCLINE>    li_ser01_temp              TYPE STANDARD TABLE OF lty_ser01,</FPCLINE>
      <FPCLINE>    li_objk                    TYPE STANDARD TABLE OF lty_objk,</FPCLINE>
      <FPCLINE>    li_knmt                    TYPE STANDARD TABLE OF lty_knmt,</FPCLINE>
      <FPCLINE>    li_items_no_print          TYPE STANDARD TABLE OF lty_items_no_print,</FPCLINE>
      <FPCLINE>    li_lines                   TYPE tline_t,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    li_konv_tmp                TYPE ty_t_konv,</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    li_item_det_higher_item_copy TYPE invoice_t_prt_item_detail, &quot;++D3 Defect 11704 by DMOIRAN</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>    li_tvap                    TYPE STANDARD TABLE OF ty_tvap.</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get All Higher Items</FPCLINE>
      <FPCLINE>  li_item_detail_higher_item = fp_i_item_detail.</FPCLINE>
      <FPCLINE>  DELETE li_item_detail_higher_item WHERE vbdpr-uepos NE lc_posnr_0.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Sorted According to the order in which they are to be printed</FPCLINE>
      <FPCLINE>  SORT li_item_detail_higher_item BY vbdpr-vbeln_vauf vbdpr-posnr_vauf.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get All Sub Items</FPCLINE>
      <FPCLINE>  li_item_detail_sub_item = fp_i_item_detail.</FPCLINE>
      <FPCLINE>  DELETE li_item_detail_sub_item WHERE vbdpr-uepos EQ lc_posnr_0.</FPCLINE>
      <FPCLINE>  SORT li_item_detail_sub_item BY vbdpr-uepos vbdpr-posnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_konv[] = fp_i_konv[].</FPCLINE>
      <FPCLINE>  SORT li_konv BY kposn koaid kinak.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>  li_konv_tmp[] = fp_i_konv[].</FPCLINE>
      <FPCLINE>  SORT li_konv_tmp BY kposn kschl koaid kinak.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_item_detail_temp[] = fp_i_item_detail[].</FPCLINE>
      <FPCLINE>  SORT li_item_detail_temp BY vbdpr-vgbel vbdpr-vgpos.</FPCLINE>
      <FPCLINE>  DELETE ADJACENT DUPLICATES FROM li_item_detail_temp COMPARING vbdpr-vgbel vbdpr-vgpos.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF li_item_detail_temp IS NOT INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    SELECT vbeln  &quot; Delivery</FPCLINE>
      <FPCLINE>           posnr  &quot; Delivery Item</FPCLINE>
      <FPCLINE>           charg  &quot; Batch Number</FPCLINE>
      <FPCLINE>           kcmeng &quot; Cumulative batch quantity of all split items (in StckUnit)</FPCLINE>
      <FPCLINE>           uecha  &quot; Higher-Level Item of Batch Split Item</FPCLINE>
      <FPCLINE>           vfdat  &quot; Shelf Life Expiration or Best-Before Date</FPCLINE>
      <FPCLINE>      FROM lips   &quot; SD document: Delivery: Item data</FPCLINE>
      <FPCLINE>      INTO TABLE li_lips</FPCLINE>
      <FPCLINE>      FOR ALL ENTRIES IN li_item_detail_temp</FPCLINE>
      <FPCLINE>      WHERE vbeln   = li_item_detail_temp-vbdpr-vgbel</FPCLINE>
      <FPCLINE>      AND   posnr   = li_item_detail_temp-vbdpr-vgpos.</FPCLINE>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      SORT li_lips BY vbeln posnr.</FPCLINE>
      <FPCLINE>      DELETE ADJACENT DUPLICATES FROM li_lips COMPARING vbeln posnr.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Serial Numbers for Delivery</FPCLINE>
      <FPCLINE>    SELECT obknr   &quot; Object list number</FPCLINE>
      <FPCLINE>           lief_nr &quot; Delivery</FPCLINE>
      <FPCLINE>           posnr   &quot; Delivery Item</FPCLINE>
      <FPCLINE>      FROM ser01   &quot; Document Header for Serial Numbers for Delivery</FPCLINE>
      <FPCLINE>      INTO TABLE li_ser01</FPCLINE>
      <FPCLINE>      FOR ALL ENTRIES IN li_item_detail_temp</FPCLINE>
      <FPCLINE>      WHERE lief_nr EQ li_item_detail_temp-vbdpr-vgbel</FPCLINE>
      <FPCLINE>      AND   posnr   EQ li_item_detail_temp-vbdpr-vgpos.</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      SORT li_ser01 BY lief_nr posnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      li_ser01_temp[] = li_ser01[].</FPCLINE>
      <FPCLINE>      SORT li_ser01_temp BY obknr.</FPCLINE>
      <FPCLINE>      DELETE ADJACENT DUPLICATES FROM li_ser01_temp COMPARING obknr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      IF NOT li_ser01_temp IS INITIAL.</FPCLINE>
      <FPCLINE>        SELECT obknr &quot; Object list number</FPCLINE>
      <FPCLINE>               obzae &quot; Object list counters</FPCLINE>
      <FPCLINE>               sernr &quot; Serial Number</FPCLINE>
      <FPCLINE>          FROM objk  &quot; Plant Maintenance Object List</FPCLINE>
      <FPCLINE>          INTO TABLE li_objk</FPCLINE>
      <FPCLINE>          FOR ALL ENTRIES IN li_ser01_temp</FPCLINE>
      <FPCLINE>          WHERE obknr EQ li_ser01_temp-obknr.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          SORT li_objk BY obknr.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF NOT li_ser01_temp IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF li_item_detail_temp IS NOT INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_item_detail_temp[] = fp_i_item_detail[].</FPCLINE>
      <FPCLINE>  SORT li_item_detail_temp BY vbdpr-matnr.</FPCLINE>
      <FPCLINE>  DELETE ADJACENT DUPLICATES FROM li_item_detail_temp COMPARING vbdpr-matnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF NOT li_item_detail_temp IS INITIAL.</FPCLINE>
      <FPCLINE>    SELECT vkorg &quot; Sales Organization</FPCLINE>
      <FPCLINE>           vtweg &quot; Distribution Channel</FPCLINE>
      <FPCLINE>           kunnr &quot; Customer number</FPCLINE>
      <FPCLINE>           matnr &quot; Material Number</FPCLINE>
      <FPCLINE>           kdmat &quot; Material Number Used by Customer</FPCLINE>
      <FPCLINE>      FROM knmt  &quot; Customer-Material Info Record Data Table</FPCLINE>
      <FPCLINE>      INTO TABLE li_knmt</FPCLINE>
      <FPCLINE>      FOR ALL ENTRIES IN li_item_detail_temp</FPCLINE>
      <FPCLINE>      WHERE vkorg = fp_x_head_detail-vbdkr-vkorg</FPCLINE>
      <FPCLINE>      AND   vtweg = fp_x_head_detail-vbdkr-vtweg</FPCLINE>
      <FPCLINE>      AND   kunnr = fp_x_head_detail-vbdkr-kunag</FPCLINE>
      <FPCLINE>      AND   matnr = li_item_detail_temp-vbdpr-matnr.</FPCLINE>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      SORT li_knmt BY matnr.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF NOT li_item_detail_temp IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>* Comapre Sales Org from doc with the one in EMI value (for Italy)</FPCLINE>
      <FPCLINE>  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>  WITH KEY criteria = lc_enh_criteria_vkorg</FPCLINE>
      <FPCLINE>            sel_low = fp_x_head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*  Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>* Prepare local interanal table with Sale Doc Item Cat</FPCLINE>
      <FPCLINE>    li_item_detail_temp[] = fp_i_item_detail[].</FPCLINE>
      <FPCLINE>    SORT li_item_detail_temp BY vbdpr-pstyv.</FPCLINE>
      <FPCLINE>    DELETE ADJACENT DUPLICATES FROM li_item_detail_temp COMPARING vbdpr-pstyv.</FPCLINE>
      <FPCLINE>*   Get PRSFD</FPCLINE>
      <FPCLINE>    IF NOT li_item_detail_temp IS INITIAL.</FPCLINE>
      <FPCLINE>      SELECT pstyv &quot; Sales document item category</FPCLINE>
      <FPCLINE>             prsfd &quot; Carry out pricing</FPCLINE>
      <FPCLINE>        FROM tvap  &quot; Sales Document: Item Categories</FPCLINE>
      <FPCLINE>        INTO TABLE li_tvap</FPCLINE>
      <FPCLINE>         FOR ALL ENTRIES IN li_item_detail_temp</FPCLINE>
      <FPCLINE>        WHERE pstyv = li_item_detail_temp-vbdpr-pstyv</FPCLINE>
      <FPCLINE>        AND   prsfd = lc_prsfd.</FPCLINE>
      <FPCLINE>      IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>        SORT li_tvap BY pstyv.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF NOT li_item_detail_temp IS INITIAL</FPCLINE>
      <FPCLINE>    FREE li_item_detail_temp[].</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  LOOP AT li_item_detail_higher_item ASSIGNING &lt;lfs_item_detail&gt;.</FPCLINE>
      <FPCLINE>    CLEAR lwa_inv_items.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    IF &lt;lfs_item_detail&gt;-vbdpr-fareg EQ lc_fareg-down_payment_4 OR</FPCLINE>
      <FPCLINE>       &lt;lfs_item_detail&gt;-vbdpr-fareg EQ lc_fareg-down_payment_5.</FPCLINE>
      <FPCLINE>*    Exclusion of the Cleared Down Payment Items</FPCLINE>
      <FPCLINE>      CONTINUE.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-fareg EQ lc_fareg-down_payment_4 OR</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Sales Order number</FPCLINE>
      <FPCLINE>    lwa_inv_items-aubel = &lt;lfs_item_detail&gt;-vbdpr-vbeln_vauf.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Customer purchase order number</FPCLINE>
      <FPCLINE>    READ TABLE i_sales_order_info INTO lwa_sales_order_info</FPCLINE>
      <FPCLINE>                                  WITH KEY aubel = lwa_inv_items-aubel</FPCLINE>
      <FPCLINE>                                  BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      lwa_inv_items-bstkd = lwa_sales_order_info-bstkd.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    READ TABLE li_item_detail_sub_item TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                       WITH KEY vbdpr-uepos = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>**   Item is non-BOM Component</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      lwa_inv_items-posnr = &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>      SHIFT lwa_inv_items-posnr LEFT DELETING LEADING lc_zero.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      lwa_inv_items-matnr = &lt;lfs_item_detail&gt;-vbdpr-matnr.</FPCLINE>
      <FPCLINE>      lwa_inv_items-arktx = &lt;lfs_item_detail&gt;-vbdpr-arktx.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If Billing Type is ZWIA then Tax Rate will be determined as below</FPCLINE>
      <FPCLINE>      READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-fkart_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>        READ TABLE fp_i_vbrk ASSIGNING &lt;lfs_vbrk&gt; WITH KEY vbeln = &lt;lfs_item_detail&gt;-vbdpr-tdname+0(10) &quot;&lt;lfs_item_detail&gt;-vbdpr-vbeln_vauf</FPCLINE>
      <FPCLINE>                                                           fkart = &lt;lfs_emi&gt;-sel_low</FPCLINE>
      <FPCLINE>                                                           BINARY SEARCH.</FPCLINE>
      <FPCLINE>        IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>          READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-kschl_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            READ TABLE li_konv_tmp INTO lwa_konv WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                                          kschl = &lt;lfs_emi&gt;-sel_low &quot; WIA2</FPCLINE>
      <FPCLINE>                                                          koaid = lc_koaid_taxes    &quot; D</FPCLINE>
      <FPCLINE>                                                          kinak = abap_false</FPCLINE>
      <FPCLINE>                                                 BINARY SEARCH.</FPCLINE>
      <FPCLINE>            IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>              lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>              WRITE lwa_konv-kbetr TO lwa_inv_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>              CONDENSE lwa_inv_items-kbetr.</FPCLINE>
      <FPCLINE>              CONCATENATE lwa_inv_items-kbetr lc_percentage INTO lwa_inv_items-kbetr</FPCLINE>
      <FPCLINE>                                                            SEPARATED BY space.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>        ELSE. &quot; ELSE -&gt; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>          READ TABLE li_konv INTO lwa_konv</FPCLINE>
      <FPCLINE>                             WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                      koaid = lc_koaid_taxes</FPCLINE>
      <FPCLINE>                                      kinak = abap_false</FPCLINE>
      <FPCLINE>                             BINARY SEARCH.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          WRITE lwa_konv-kbetr TO lwa_inv_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>          CONDENSE lwa_inv_items-kbetr.</FPCLINE>
      <FPCLINE>          CONCATENATE lwa_inv_items-kbetr lc_percentage</FPCLINE>
      <FPCLINE>                      INTO lwa_inv_items-kbetr</FPCLINE>
      <FPCLINE>                      SEPARATED BY space.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>*    Unit of Measure in Output Language</FPCLINE>
      <FPCLINE>      CALL FUNCTION &apos;CONVERSION_EXIT_CUNIT_OUTPUT&apos;</FPCLINE>
      <FPCLINE>        EXPORTING</FPCLINE>
      <FPCLINE>          input          = &lt;lfs_item_detail&gt;-vbdpr-vrkme</FPCLINE>
      <FPCLINE>          language       = gv_form_lang</FPCLINE>
      <FPCLINE>        IMPORTING</FPCLINE>
      <FPCLINE>          output         = lwa_inv_items-vrkme</FPCLINE>
      <FPCLINE>        EXCEPTIONS</FPCLINE>
      <FPCLINE>          unit_not_found = 1</FPCLINE>
      <FPCLINE>          OTHERS         = 2.</FPCLINE>
      <FPCLINE>      IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>        lwa_inv_items-vrkme = &lt;lfs_item_detail&gt;-vbdpr-vrkme.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      IF &lt;lfs_item_detail&gt;-vbdpr-xchar EQ abap_true.</FPCLINE>
      <FPCLINE>*      Item is Batch Managed</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#7302:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>        lwa_inv_items-fkimg_tmp  = &lt;lfs_item_detail&gt;-vbdpr-fkimg.</FPCLINE>
      <FPCLINE>        lwa_inv_items-amount_tmp = &lt;lfs_item_detail&gt;-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE>        lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>        WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>        CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*          Caculate Unit Price</FPCLINE>
      <FPCLINE>        IF lwa_inv_items-fkimg_tmp &lt;&gt; 0 .</FPCLINE>
      <FPCLINE>          lv_unit_price  = lwa_inv_items-amount_tmp / lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF lwa_inv_items-fkimg_tmp &lt;&gt; 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;--&gt; Begin of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*&amp;--We are passing the KRW currency to the EUR currency</FPCLINE>
      <FPCLINE>*        WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*        WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*&amp;&lt;-- End of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>        WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>        WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>        CLEAR: lv_unit_price.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#7302:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>        READ TABLE li_lips INTO lwa_lips</FPCLINE>
      <FPCLINE>                           WITH KEY vbeln = &lt;lfs_item_detail&gt;-vbdpr-vgbel</FPCLINE>
      <FPCLINE>                                    posnr = &lt;lfs_item_detail&gt;-vbdpr-vgpos</FPCLINE>
      <FPCLINE>                           BINARY SEARCH.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          IF lwa_lips-uecha EQ lc_posnr_0.</FPCLINE>
      <FPCLINE>**        Non-Batch Split</FPCLINE>
      <FPCLINE>* ---&gt; Insert of Delete for Defect#7302:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>*            lwa_inv_items-fkimg_tmp  = &lt;lfs_item_detail&gt;-vbdpr-fkimg.</FPCLINE>
      <FPCLINE>*            lwa_inv_items-amount_tmp = &lt;lfs_item_detail&gt;-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>**          Caculate Unit Price</FPCLINE>
      <FPCLINE>*            IF lwa_inv_items-fkimg_tmp &lt;&gt; 0 .</FPCLINE>
      <FPCLINE>*              lv_unit_price  = lwa_inv_items-amount_tmp / lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>*            ENDIF. &quot; IF lwa_inv_items-fkimg_tmp &lt;&gt; 0</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>** Begin of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>**            WRITE lwa_inv_items-fkimg_tmp  TO lwa_inv_items-fkimg UNIT lwa_inv_items-vrkme.</FPCLINE>
      <FPCLINE>** End of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>** Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*            lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>*            WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>*            CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>** End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>*            WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*            WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>*            CLEAR: lv_unit_price.</FPCLINE>
      <FPCLINE>* &lt;--- End of Delete for Defect#7302:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*          Batch Number</FPCLINE>
      <FPCLINE>            lwa_batch_numbers-batch = lwa_lips-charg.</FPCLINE>
      <FPCLINE>            PERFORM f_format_date USING lwa_lips-vfdat</FPCLINE>
      <FPCLINE>                               CHANGING lwa_batch_numbers-vfdat.</FPCLINE>
      <FPCLINE>            APPEND lwa_batch_numbers TO lwa_inv_items-batch_numbers.</FPCLINE>
      <FPCLINE>            CLEAR lwa_batch_numbers.</FPCLINE>
      <FPCLINE>          ELSE. &quot; ELSE -&gt; IF lwa_lips-uecha EQ lc_posnr_0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>**         Batch Split</FPCLINE>
      <FPCLINE>            lv_uecha = lwa_lips-uecha. &quot;Delivery Higher Item</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*          Check if Item Print is Required</FPCLINE>
      <FPCLINE>            READ TABLE li_items_no_print TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                         WITH KEY uecha = lv_uecha</FPCLINE>
      <FPCLINE>                                                  posnr = &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE>*           Binary Search Not used as table is modified inside this loop</FPCLINE>
      <FPCLINE>            IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*            Item not required</FPCLINE>
      <FPCLINE>              CONTINUE.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*   ---&gt; Begin of change for Defect#7558:D3_OTC_FDD_0014 by rbanerj1</FPCLINE>
      <FPCLINE>            CLEAR : lwa_inv_items-fkimg_tmp,</FPCLINE>
      <FPCLINE>                    lwa_inv_items-amount_tmp.</FPCLINE>
      <FPCLINE>*   &lt;--- End of change for Defect#7558:D3_OTC_FDD_0014 by rbanerj1</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3 Defect 11704 by DMOIRAN</FPCLINE>
      <FPCLINE>* Issue: In scenario of an invoice having multiple deliveries with batch split from</FPCLINE>
      <FPCLINE>* a sales order line item, the line item from first delivery is only displayed.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*Fix: Consider only the delivery which matches with delivery of the current iteration</FPCLINE>
      <FPCLINE>* while building up IT (li_items_no_print) to skip batch split line item display.</FPCLINE>
      <FPCLINE>            CLEAR li_item_det_higher_item_copy[].</FPCLINE>
      <FPCLINE>            APPEND LINES OF li_item_detail_higher_item TO li_item_det_higher_item_copy.</FPCLINE>
      <FPCLINE>            DELETE li_item_det_higher_item_copy WHERE vbdpr-vgbel NE &lt;lfs_item_detail&gt;-vbdpr-vgbel.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End    of Insert for D3 Defect 11704 by DMOIRAN</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            LOOP AT li_item_detail_higher_item INTO lwa_item_detail_tmp.    &quot;--D3 Defect 11704 by DMOIRAN</FPCLINE>
      <FPCLINE>            LOOP AT li_item_det_higher_item_copy INTO lwa_item_detail_tmp. &quot;++D3 Defect 11704 by DMOIRAN</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              READ TABLE li_lips INTO lwa_lips WITH KEY vbeln = lwa_item_detail_tmp-vbdpr-vgbel</FPCLINE>
      <FPCLINE>                                                        posnr = lwa_item_detail_tmp-vbdpr-vgpos</FPCLINE>
      <FPCLINE>                                               BINARY SEARCH.</FPCLINE>
      <FPCLINE>              IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                IF lwa_lips-uecha EQ lv_uecha.</FPCLINE>
      <FPCLINE>*                Items Not required for Print</FPCLINE>
      <FPCLINE>                  lwa_items_no_print-uecha = lv_uecha.</FPCLINE>
      <FPCLINE>                  lwa_items_no_print-posnr = lwa_item_detail_tmp-vbdpr-posnr.</FPCLINE>
      <FPCLINE>                  APPEND lwa_items_no_print TO li_items_no_print.</FPCLINE>
      <FPCLINE>                  CLEAR lwa_items_no_print.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>                  lwa_inv_items-fkimg_tmp  = lwa_inv_items-fkimg_tmp  + lwa_item_detail_tmp-vbdpr-fkimg.</FPCLINE>
      <FPCLINE>                  lwa_inv_items-amount_tmp = lwa_inv_items-amount_tmp + lwa_item_detail_tmp-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*                Batch Number</FPCLINE>
      <FPCLINE>                  lwa_batch_numbers-batch = lwa_lips-charg.</FPCLINE>
      <FPCLINE>                  PERFORM f_format_date USING lwa_lips-vfdat</FPCLINE>
      <FPCLINE>                                     CHANGING lwa_batch_numbers-vfdat.</FPCLINE>
      <FPCLINE>                  APPEND lwa_batch_numbers TO lwa_inv_items-batch_numbers.</FPCLINE>
      <FPCLINE>                  CLEAR lwa_batch_numbers.</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF lwa_lips-uecha EQ lv_uecha</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>            ENDLOOP. &quot; LOOP AT li_item_det_higher_item_copy INTO lwa_item_detail_tmp</FPCLINE>
      <FPCLINE>            IF lwa_inv_items-fkimg_tmp &lt;&gt; 0 .</FPCLINE>
      <FPCLINE>              lv_unit_price = lwa_inv_items-amount_tmp / lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF lwa_inv_items-fkimg_tmp &lt;&gt; 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*            WRITE lwa_inv_items-fkimg_tmp  TO lwa_inv_items-fkimg UNIT lwa_inv_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>            lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>            WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>            CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*&amp;--We are passing the KRW currency to the EUR currency</FPCLINE>
      <FPCLINE>*            WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*            WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>* &lt;--- End of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>            WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>            WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>**</FPCLINE>
      <FPCLINE/>
      <FPCLINE>            CLEAR: lv_unit_price.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          ENDIF. &quot; IF lwa_lips-uecha EQ lc_posnr_0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ELSE. &quot; ELSE -&gt; IF &lt;lfs_item_detail&gt;-vbdpr-xchar EQ abap_true</FPCLINE>
      <FPCLINE>        lwa_inv_items-fkimg_tmp  = &lt;lfs_item_detail&gt;-vbdpr-fkimg.</FPCLINE>
      <FPCLINE>        lwa_inv_items-amount_tmp = &lt;lfs_item_detail&gt;-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*      Caculate Unit Price</FPCLINE>
      <FPCLINE>        IF lwa_inv_items-fkimg_tmp &lt;&gt; 0.</FPCLINE>
      <FPCLINE>          lv_unit_price  = lwa_inv_items-amount_tmp / lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF lwa_inv_items-fkimg_tmp &lt;&gt; 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*        WRITE lwa_inv_items-fkimg_tmp  TO lwa_inv_items-fkimg UNIT lwa_inv_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>        lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>        WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>        CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*&amp;--We are passing the KRW currency to the EUR currency</FPCLINE>
      <FPCLINE>*        WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*        WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>* &lt;--- End of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>        WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>        WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>        CLEAR: lv_unit_price.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-xchar EQ abap_true</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*    Serial Number</FPCLINE>
      <FPCLINE>      IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j. &quot; could be &lt;lfs_item_detail&gt;-vbdpr-VGTYP_VAUF (check in debug)</FPCLINE>
      <FPCLINE>        READ TABLE li_ser01 INTO lwa_ser01</FPCLINE>
      <FPCLINE>                            WITH KEY lief_nr = &lt;lfs_item_detail&gt;-vbdpr-vgbel</FPCLINE>
      <FPCLINE>                                     posnr   = &lt;lfs_item_detail&gt;-vbdpr-vgpos</FPCLINE>
      <FPCLINE>                            BINARY SEARCH.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          LOOP AT li_objk INTO lwa_objk.</FPCLINE>
      <FPCLINE>            IF lwa_objk-obknr EQ lwa_ser01-obknr.</FPCLINE>
      <FPCLINE>              APPEND lwa_objk-sernr TO lwa_inv_items-serial_numbers.</FPCLINE>
      <FPCLINE>              CLEAR lwa_objk .</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF lwa_objk-obknr EQ lwa_ser01-obknr</FPCLINE>
      <FPCLINE>          ENDLOOP. &quot; LOOP AT li_objk INTO lwa_objk</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*    Customer Material Number</FPCLINE>
      <FPCLINE>      READ TABLE li_knmt INTO lwa_knmt WITH KEY matnr = &lt;lfs_item_detail&gt;-vbdpr-matnr</FPCLINE>
      <FPCLINE>                                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>        lwa_inv_items-kdmat = lwa_knmt-kdmat.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*    Delivery Information</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If the document type is delivery (J) then only delivery information will be populated</FPCLINE>
      <FPCLINE>      IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>        READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                      WITH KEY criteria = lc_enh_criteria-delvy</FPCLINE>
      <FPCLINE>                                               sel_low  = fp_x_head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          PERFORM f_format_date USING &lt;lfs_item_detail&gt;-vbdpr-fbuda</FPCLINE>
      <FPCLINE>                             CHANGING lv_date_str.</FPCLINE>
      <FPCLINE>**Begin of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>*          CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lc_slash lv_date_str</FPCLINE>
      <FPCLINE>*                 INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>**End of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>**Begin of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>          lv_text_name = lc_text_from.</FPCLINE>
      <FPCLINE>          PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                              gv_form_lang</FPCLINE>
      <FPCLINE>                                        CHANGING lv_text      .</FPCLINE>
      <FPCLINE>          CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lv_text lv_date_str</FPCLINE>
      <FPCLINE>                 INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>          CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                 lv_text_name.</FPCLINE>
      <FPCLINE>          lv_text_name = lc_text_service.</FPCLINE>
      <FPCLINE>          PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                              gv_form_lang</FPCLINE>
      <FPCLINE>                                        CHANGING lv_text.</FPCLINE>
      <FPCLINE>          CONCATENATE lwa_inv_items-del_info lc_slash lc_equal lv_text</FPCLINE>
      <FPCLINE>                                           INTO lwa_inv_items-del_info</FPCLINE>
      <FPCLINE>                                           SEPARATED BY space.</FPCLINE>
      <FPCLINE>          CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                 lv_text_name.</FPCLINE>
      <FPCLINE>**End of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>          CLEAR lv_date_str.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>*    Billing Start Date &amp; End Date</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      IF &lt;lfs_item_detail&gt;-vbdpr-fareg EQ lc_fareg-per_billing_6.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*      Retrieve Text For Billing Plan Start Date</FPCLINE>
      <FPCLINE>        CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>          EXPORTING</FPCLINE>
      <FPCLINE>            id                      = lc_tdid</FPCLINE>
      <FPCLINE>            language                = gv_form_lang</FPCLINE>
      <FPCLINE>            name                    = lc_std_text-start_date</FPCLINE>
      <FPCLINE>            object                  = lc_tdobject</FPCLINE>
      <FPCLINE>          TABLES</FPCLINE>
      <FPCLINE>            lines                   = li_lines</FPCLINE>
      <FPCLINE>          EXCEPTIONS</FPCLINE>
      <FPCLINE>            id                      = 1</FPCLINE>
      <FPCLINE>            language                = 1</FPCLINE>
      <FPCLINE>            name                    = 1</FPCLINE>
      <FPCLINE>            not_found               = 1</FPCLINE>
      <FPCLINE>            object                  = 1</FPCLINE>
      <FPCLINE>            reference_check         = 1</FPCLINE>
      <FPCLINE>            wrong_access_to_archive = 1</FPCLINE>
      <FPCLINE>            OTHERS                  = 1.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          READ TABLE li_lines INTO lwa_line INDEX 1.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            READ TABLE fp_i_vbrp INTO lwa_vbrp</FPCLINE>
      <FPCLINE>                                 WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>                                          posnr = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                 BINARY SEARCH.</FPCLINE>
      <FPCLINE>            IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>              PERFORM f_format_date USING lwa_vbrp-abrbg</FPCLINE>
      <FPCLINE>                                 CHANGING lv_date_str.</FPCLINE>
      <FPCLINE>              CONCATENATE lwa_line-tdline lv_date_str</FPCLINE>
      <FPCLINE>                   INTO lwa_inv_items-bill_dates</FPCLINE>
      <FPCLINE>                   SEPARATED BY space.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*      Retrieve Text For Billing Plan End Date</FPCLINE>
      <FPCLINE>        CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>          EXPORTING</FPCLINE>
      <FPCLINE>            id                      = lc_tdid</FPCLINE>
      <FPCLINE>            language                = gv_form_lang</FPCLINE>
      <FPCLINE>            name                    = lc_std_text-end_date</FPCLINE>
      <FPCLINE>            object                  = lc_tdobject</FPCLINE>
      <FPCLINE>          TABLES</FPCLINE>
      <FPCLINE>            lines                   = li_lines</FPCLINE>
      <FPCLINE>          EXCEPTIONS</FPCLINE>
      <FPCLINE>            id                      = 1</FPCLINE>
      <FPCLINE>            language                = 1</FPCLINE>
      <FPCLINE>            name                    = 1</FPCLINE>
      <FPCLINE>            not_found               = 1</FPCLINE>
      <FPCLINE>            object                  = 1</FPCLINE>
      <FPCLINE>            reference_check         = 1</FPCLINE>
      <FPCLINE>            wrong_access_to_archive = 1</FPCLINE>
      <FPCLINE>            OTHERS                  = 1.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          READ TABLE li_lines INTO lwa_line INDEX 1.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            PERFORM f_format_date USING &lt;lfs_item_detail&gt;-vbdpr-fbuda</FPCLINE>
      <FPCLINE>                               CHANGING lv_date_str.</FPCLINE>
      <FPCLINE>            CONCATENATE lwa_inv_items-bill_dates lc_hyphen lwa_line-tdline lv_date_str</FPCLINE>
      <FPCLINE>                 INTO lwa_inv_items-bill_dates</FPCLINE>
      <FPCLINE>                 SEPARATED BY space.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-fareg EQ lc_fareg-per_billing_6</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*    Billing Document Item Text</FPCLINE>
      <FPCLINE>      CONCATENATE fp_x_head_detail-vbdkr-vbeln &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>             INTO lwa_inv_items-bill_item_std_text.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>      IF li_tvap IS NOT INITIAL.</FPCLINE>
      <FPCLINE>        READ TABLE li_tvap INTO lwa_tvap WITH KEY pstyv = &lt;lfs_item_detail&gt;-vbdpr-pstyv BINARY SEARCH.</FPCLINE>
      <FPCLINE>        IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>          lwa_inv_items-foc_flag = abap_true.</FPCLINE>
      <FPCLINE>          CLEAR lwa_tvap.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF li_tvap IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Check if Sales Organization is Italy</FPCLINE>
      <FPCLINE>      IF fp_x_head_detail-vbdkr-vkorg EQ lc_ivkorg.</FPCLINE>
      <FPCLINE>        CLEAR lv_count.</FPCLINE>
      <FPCLINE>        LOOP AT li_konv INTO lwa_konv WHERE kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                        AND   koaid = lc_koaid_taxes.</FPCLINE>
      <FPCLINE>          IF lwa_konv-kinak NE &apos;A&apos;.</FPCLINE>
      <FPCLINE>            lv_count = lv_count + 1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          ENDIF. &quot; IF lwa_konv-kinak NE &apos;A&apos;</FPCLINE>
      <FPCLINE>        ENDLOOP. &quot; LOOP AT li_konv INTO lwa_konv WHERE kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>        IF lv_count &gt; 1.</FPCLINE>
      <FPCLINE>* Print nothing for the tax split of the item</FPCLINE>
      <FPCLINE>          lwa_inv_items-kbetr = space.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF lv_count &gt; 1</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF fp_x_head_detail-vbdkr-vkorg EQ lc_ivkorg</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>      APPEND lwa_inv_items TO i_inv_items.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#8134 by NALI</FPCLINE>
      <FPCLINE>      CLEAR lwa_inv_items.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#8134 by NALI</FPCLINE>
      <FPCLINE>    ELSE. &quot; ELSE -&gt; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE>**   Item is BOM Component Header</FPCLINE>
      <FPCLINE>*     Check Distribution Channel - Customer Sales</FPCLINE>
      <FPCLINE>      READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                    WITH KEY criteria = lc_enh_criteria-cust_sales</FPCLINE>
      <FPCLINE>                                             sel_low  = fp_x_head_detail-vbdkr-vtweg.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*       Check Sales Org. - For EHQ/USPA customer billing (EHQ-Sales Org 2000 / USPA - Sales Org 1024)</FPCLINE>
      <FPCLINE>        READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                      WITH KEY criteria = lc_enh_criteria-bom</FPCLINE>
      <FPCLINE>                                               sel_low  = fp_x_head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*       Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          lwa_inv_items-posnr  = &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>          SHIFT lwa_inv_items-posnr LEFT DELETING LEADING lc_zero.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          lwa_inv_items-matnr  = &lt;lfs_item_detail&gt;-vbdpr-matnr.</FPCLINE>
      <FPCLINE>          lwa_inv_items-arktx  = &lt;lfs_item_detail&gt;-vbdpr-arktx.</FPCLINE>
      <FPCLINE>          lwa_inv_items-fkimg_tmp = &lt;lfs_item_detail&gt;-vbdpr-fkimg.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If Billing Type is ZWIA then Tax Rate will be determined as below</FPCLINE>
      <FPCLINE>          READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-fkart_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            READ TABLE fp_i_vbrk ASSIGNING &lt;lfs_vbrk&gt; WITH KEY vbeln = &lt;lfs_item_detail&gt;-vbdpr-tdname+0(10) &quot;&lt;lfs_item_detail&gt;-vbdpr-vbeln_vauf</FPCLINE>
      <FPCLINE>                                                               fkart = &lt;lfs_emi&gt;-sel_low</FPCLINE>
      <FPCLINE>                                                               BINARY SEARCH.</FPCLINE>
      <FPCLINE>            IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>              READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-kschl_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>              IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                READ TABLE li_konv_tmp INTO lwa_konv WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                                              kschl = &lt;lfs_emi&gt;-sel_low &quot; WIA2</FPCLINE>
      <FPCLINE>                                                              koaid = lc_koaid_taxes    &quot; D</FPCLINE>
      <FPCLINE>                                                              kinak = abap_false</FPCLINE>
      <FPCLINE>                                                     BINARY SEARCH.</FPCLINE>
      <FPCLINE>                IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>                  lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>                  WRITE lwa_konv-kbetr TO lwa_inv_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>                  CONDENSE lwa_inv_items-kbetr.</FPCLINE>
      <FPCLINE>                  CONCATENATE lwa_inv_items-kbetr lc_percentage INTO lwa_inv_items-kbetr</FPCLINE>
      <FPCLINE>                                                                SEPARATED BY space.</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>            ELSE. &quot; ELSE -&gt; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              READ TABLE li_konv INTO lwa_konv</FPCLINE>
      <FPCLINE>                                 WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                          koaid = lc_koaid_taxes</FPCLINE>
      <FPCLINE>                                 BINARY SEARCH.</FPCLINE>
      <FPCLINE>              IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>                WRITE lwa_konv-kbetr TO lwa_inv_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>                CONDENSE lwa_inv_items-kbetr.</FPCLINE>
      <FPCLINE>                CONCATENATE lwa_inv_items-kbetr lc_percentage</FPCLINE>
      <FPCLINE>                       INTO lwa_inv_items-kbetr</FPCLINE>
      <FPCLINE>                       SEPARATED BY space.</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>*        Unit of Measure in Output Language</FPCLINE>
      <FPCLINE>          CALL FUNCTION &apos;CONVERSION_EXIT_CUNIT_OUTPUT&apos;</FPCLINE>
      <FPCLINE>            EXPORTING</FPCLINE>
      <FPCLINE>              input          = &lt;lfs_item_detail&gt;-vbdpr-vrkme</FPCLINE>
      <FPCLINE>              language       = gv_form_lang</FPCLINE>
      <FPCLINE>            IMPORTING</FPCLINE>
      <FPCLINE>              output         = lwa_inv_items-vrkme</FPCLINE>
      <FPCLINE>            EXCEPTIONS</FPCLINE>
      <FPCLINE>              unit_not_found = 1</FPCLINE>
      <FPCLINE>              OTHERS         = 2.</FPCLINE>
      <FPCLINE>          IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>            lwa_inv_items-vrkme = &lt;lfs_item_detail&gt;-vbdpr-vrkme.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*          WRITE lwa_inv_items-fkimg_tmp TO lwa_inv_items-fkimg UNIT lwa_inv_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>          lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>          WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>          CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Read All BOM Components</FPCLINE>
      <FPCLINE>          LOOP AT li_item_detail_sub_item INTO lwa_item_detail_tmp.</FPCLINE>
      <FPCLINE>            IF lwa_item_detail_tmp-vbdpr-uepos EQ &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            BOM Header - calculated from BOM Components</FPCLINE>
      <FPCLINE>              lwa_inv_items-amount_tmp = lwa_inv_items-amount_tmp + lwa_item_detail_tmp-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            BOM Component</FPCLINE>
      <FPCLINE>              lwa_inv_bom_items-matnr     = lwa_item_detail_tmp-vbdpr-matnr.</FPCLINE>
      <FPCLINE>              lwa_inv_bom_items-fkimg_tmp = lwa_item_detail_tmp-vbdpr-fkimg.</FPCLINE>
      <FPCLINE>              lwa_inv_bom_items-arktx     = lwa_item_detail_tmp-vbdpr-arktx.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            Unit of Measure in Output Language</FPCLINE>
      <FPCLINE>              CALL FUNCTION &apos;CONVERSION_EXIT_CUNIT_OUTPUT&apos;</FPCLINE>
      <FPCLINE>                EXPORTING</FPCLINE>
      <FPCLINE>                  input          = lwa_item_detail_tmp-vbdpr-vrkme</FPCLINE>
      <FPCLINE>                  language       = gv_form_lang</FPCLINE>
      <FPCLINE>                IMPORTING</FPCLINE>
      <FPCLINE>                  output         = lwa_inv_bom_items-vrkme</FPCLINE>
      <FPCLINE>                EXCEPTIONS</FPCLINE>
      <FPCLINE>                  unit_not_found = 1</FPCLINE>
      <FPCLINE>                  OTHERS         = 2.</FPCLINE>
      <FPCLINE>              IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>                lwa_inv_bom_items-vrkme = lwa_item_detail_tmp-vbdpr-vrkme.</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE>*              WRITE lwa_inv_bom_items-fkimg_tmp TO lwa_inv_bom_items-fkimg  UNIT lwa_inv_bom_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE>              lv_quantity_tmp = lwa_inv_bom_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>              WRITE lv_quantity_tmp TO lwa_inv_bom_items-fkimg.</FPCLINE>
      <FPCLINE>              CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              IF lwa_item_detail_tmp-vbdpr-xchar EQ abap_true.</FPCLINE>
      <FPCLINE>*              Batch Numbers</FPCLINE>
      <FPCLINE>                READ TABLE li_lips INTO lwa_lips</FPCLINE>
      <FPCLINE>                                   WITH KEY vbeln = lwa_item_detail_tmp-vbdpr-vgbel</FPCLINE>
      <FPCLINE>                                            posnr = lwa_item_detail_tmp-vbdpr-vgpos</FPCLINE>
      <FPCLINE>                                   BINARY SEARCH.</FPCLINE>
      <FPCLINE>                IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                  lwa_batch_numbers-batch = lwa_lips-charg.</FPCLINE>
      <FPCLINE>                  PERFORM f_format_date USING lwa_lips-vfdat</FPCLINE>
      <FPCLINE>                                     CHANGING lwa_batch_numbers-vfdat.</FPCLINE>
      <FPCLINE>                  APPEND lwa_batch_numbers TO lwa_inv_bom_items-batch_numbers.</FPCLINE>
      <FPCLINE>                  CLEAR lwa_batch_numbers.</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF lwa_item_detail_tmp-vbdpr-xchar EQ abap_true</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            Serial Number</FPCLINE>
      <FPCLINE>              IF lwa_item_detail_tmp-vbdpr-vgtyp = lc_vgtyp_j. &quot; could be &lt;lfs_item_detail&gt;-vbdpr-VGTYP_VAUF (check in debug)</FPCLINE>
      <FPCLINE>                READ TABLE li_ser01 INTO lwa_ser01</FPCLINE>
      <FPCLINE>                                    WITH KEY lief_nr = lwa_item_detail_tmp-vbdpr-vgbel</FPCLINE>
      <FPCLINE>                                             posnr   = lwa_item_detail_tmp-vbdpr-vgpos</FPCLINE>
      <FPCLINE>                                    BINARY SEARCH.</FPCLINE>
      <FPCLINE>                IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                  LOOP AT li_objk INTO lwa_objk.</FPCLINE>
      <FPCLINE>                    IF lwa_objk-obknr EQ lwa_ser01-obknr.</FPCLINE>
      <FPCLINE>                      APPEND lwa_objk-sernr TO lwa_inv_bom_items-serial_numbers.</FPCLINE>
      <FPCLINE>                      CLEAR lwa_objk.</FPCLINE>
      <FPCLINE>                    ENDIF. &quot; IF lwa_objk-obknr EQ lwa_ser01-obknr</FPCLINE>
      <FPCLINE>                  ENDLOOP. &quot; LOOP AT li_objk INTO lwa_objk</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF lwa_item_detail_tmp-vbdpr-vgtyp = lc_vgtyp_j</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              APPEND lwa_inv_bom_items TO lwa_inv_items-bom_components.</FPCLINE>
      <FPCLINE>              CLEAR lwa_inv_bom_items.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF lwa_item_detail_tmp-vbdpr-uepos EQ &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>          ENDLOOP. &quot; LOOP AT li_item_detail_sub_item INTO lwa_item_detail_tmp</FPCLINE>
      <FPCLINE>          IF lwa_inv_items-fkimg_tmp &lt;&gt; 0 .</FPCLINE>
      <FPCLINE>            lv_unit_price = lwa_inv_items-amount_tmp / lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF lwa_inv_items-fkimg_tmp &lt;&gt; 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*          WRITE lwa_inv_items-fkimg_tmp  TO lwa_inv_items-fkimg UNIT lwa_inv_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>          lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>          WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>          CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*&amp;--We are passing the KRW currency to the EUR currency</FPCLINE>
      <FPCLINE>*          WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*          WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>* &lt;--- End of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>          WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          CLEAR: lv_unit_price.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        BOM Header Information</FPCLINE>
      <FPCLINE>*        Customer Material Number</FPCLINE>
      <FPCLINE>          READ TABLE li_knmt INTO lwa_knmt WITH KEY matnr = &lt;lfs_item_detail&gt;-vbdpr-matnr</FPCLINE>
      <FPCLINE>                                           BINARY SEARCH.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            lwa_inv_items-kdmat = lwa_knmt-kdmat.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Delivery Information</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If the document type is delivery (J) then only delivery information will be populated</FPCLINE>
      <FPCLINE>          IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>            READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                          WITH KEY criteria = lc_enh_criteria-delvy</FPCLINE>
      <FPCLINE>                                                   sel_low  = fp_x_head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*        Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>            IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>              PERFORM f_format_date USING &lt;lfs_item_detail&gt;-vbdpr-fbuda</FPCLINE>
      <FPCLINE>                                 CHANGING lv_date_str.</FPCLINE>
      <FPCLINE>**Begin of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>*              CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lc_slash lv_date_str</FPCLINE>
      <FPCLINE>*                     INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>**End of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>**Begin of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>              lv_text_name = lc_text_from.</FPCLINE>
      <FPCLINE>              PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                                  gv_form_lang</FPCLINE>
      <FPCLINE>                                            CHANGING lv_text      .</FPCLINE>
      <FPCLINE>              CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lv_text lv_date_str</FPCLINE>
      <FPCLINE>                     INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>              CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                     lv_text_name.</FPCLINE>
      <FPCLINE>              lv_text_name = lc_text_service.</FPCLINE>
      <FPCLINE>              PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                                  gv_form_lang</FPCLINE>
      <FPCLINE>                                            CHANGING lv_text.</FPCLINE>
      <FPCLINE>              CONCATENATE lwa_inv_items-del_info lc_slash lc_equal lv_text</FPCLINE>
      <FPCLINE>                                               INTO lwa_inv_items-del_info</FPCLINE>
      <FPCLINE>                                               SEPARATED BY space.</FPCLINE>
      <FPCLINE>              CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                     lv_text_name.</FPCLINE>
      <FPCLINE>**End of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              CLEAR lv_date_str.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Billing Document Item Text</FPCLINE>
      <FPCLINE>          CONCATENATE fp_x_head_detail-vbdkr-vbeln &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                 INTO lwa_inv_items-bill_item_std_text.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>          IF li_tvap IS NOT INITIAL.</FPCLINE>
      <FPCLINE>            READ TABLE li_tvap INTO lwa_tvap WITH KEY pstyv = &lt;lfs_item_detail&gt;-vbdpr-pstyv BINARY SEARCH.</FPCLINE>
      <FPCLINE>            IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>              lwa_inv_items-foc_flag = abap_true.</FPCLINE>
      <FPCLINE>              CLEAR lwa_tvap.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF li_tvap IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          APPEND lwa_inv_items TO i_inv_items.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#8134 by NALI</FPCLINE>
      <FPCLINE>          CLEAR lwa_inv_items.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#8134 by NALI</FPCLINE>
      <FPCLINE>        ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>**       For LRD customer billing</FPCLINE>
      <FPCLINE>          lwa_inv_items-posnr  = &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>          SHIFT lwa_inv_items-posnr LEFT DELETING LEADING lc_zero.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          lwa_inv_items-matnr  = &lt;lfs_item_detail&gt;-vbdpr-matnr.</FPCLINE>
      <FPCLINE>          lwa_inv_items-arktx  = &lt;lfs_item_detail&gt;-vbdpr-arktx.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          lwa_inv_items-fkimg_tmp = &lt;lfs_item_detail&gt;-vbdpr-fkimg.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Tax Rate</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If Billing Type is ZWIA then Tax Rate will be determined as below</FPCLINE>
      <FPCLINE>          READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-fkart_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            READ TABLE fp_i_vbrk ASSIGNING &lt;lfs_vbrk&gt; WITH KEY vbeln = &lt;lfs_item_detail&gt;-vbdpr-tdname+0(10) &quot;&lt;lfs_item_detail&gt;-vbdpr-vbeln_vauf</FPCLINE>
      <FPCLINE>                                                               fkart = &lt;lfs_emi&gt;-sel_low</FPCLINE>
      <FPCLINE>                                                               BINARY SEARCH.</FPCLINE>
      <FPCLINE>            IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>              READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-kschl_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>              IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                READ TABLE li_konv_tmp INTO lwa_konv WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                                              kschl = &lt;lfs_emi&gt;-sel_low &quot; WIA2</FPCLINE>
      <FPCLINE>                                                              koaid = lc_koaid_taxes    &quot; D</FPCLINE>
      <FPCLINE>                                                              kinak = abap_false</FPCLINE>
      <FPCLINE>                                                     BINARY SEARCH.</FPCLINE>
      <FPCLINE>                IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>                  lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>                  WRITE lwa_konv-kbetr TO lwa_inv_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>                  CONDENSE lwa_inv_items-kbetr.</FPCLINE>
      <FPCLINE>                  CONCATENATE lwa_inv_items-kbetr lc_percentage INTO lwa_inv_items-kbetr</FPCLINE>
      <FPCLINE>                                                                SEPARATED BY space.</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>            ELSE. &quot; ELSE -&gt; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>              READ TABLE li_konv INTO lwa_konv</FPCLINE>
      <FPCLINE>                                 WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                          koaid = lc_koaid_taxes</FPCLINE>
      <FPCLINE>                                 BINARY SEARCH.</FPCLINE>
      <FPCLINE>              IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>                WRITE lwa_konv-kbetr TO lwa_inv_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>                CONDENSE lwa_inv_items-kbetr.</FPCLINE>
      <FPCLINE>                CONCATENATE lwa_inv_items-kbetr lc_percentage</FPCLINE>
      <FPCLINE>                       INTO lwa_inv_items-kbetr</FPCLINE>
      <FPCLINE>                       SEPARATED BY space.</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Unit of Measure in Output Language</FPCLINE>
      <FPCLINE>          CALL FUNCTION &apos;CONVERSION_EXIT_CUNIT_OUTPUT&apos;</FPCLINE>
      <FPCLINE>            EXPORTING</FPCLINE>
      <FPCLINE>              input          = &lt;lfs_item_detail&gt;-vbdpr-vrkme</FPCLINE>
      <FPCLINE>              language       = gv_form_lang</FPCLINE>
      <FPCLINE>            IMPORTING</FPCLINE>
      <FPCLINE>              output         = lwa_inv_items-vrkme</FPCLINE>
      <FPCLINE>            EXCEPTIONS</FPCLINE>
      <FPCLINE>              unit_not_found = 1</FPCLINE>
      <FPCLINE>              OTHERS         = 2.</FPCLINE>
      <FPCLINE>          IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>            lwa_inv_items-vrkme = &lt;lfs_item_detail&gt;-vbdpr-vrkme.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Read All BOM Components</FPCLINE>
      <FPCLINE>          LOOP AT li_item_detail_sub_item INTO lwa_item_detail_tmp.</FPCLINE>
      <FPCLINE>            IF lwa_item_detail_tmp-vbdpr-uepos EQ &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE>              lwa_inv_items-amount_tmp = lwa_inv_items-amount_tmp + lwa_item_detail_tmp-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF lwa_item_detail_tmp-vbdpr-uepos EQ &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>          ENDLOOP. &quot; LOOP AT li_item_detail_sub_item INTO lwa_item_detail_tmp</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          IF lwa_inv_items-fkimg_tmp &lt;&gt; 0.</FPCLINE>
      <FPCLINE>            lv_unit_price = lwa_inv_items-amount_tmp / lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF lwa_inv_items-fkimg_tmp &lt;&gt; 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*          WRITE lwa_inv_items-fkimg_tmp  TO lwa_inv_items-fkimg UNIT lwa_inv_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>          lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>          WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>          CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*&amp;--We are passing the KRW currency in place of EUR currency as per the requirement.</FPCLINE>
      <FPCLINE>*          WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*          WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>* &lt;--- End of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          WRITE lwa_inv_items-amount_tmp TO lwa_inv_items-amount     CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>          WRITE lv_unit_price            TO lwa_inv_items-unit_price CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>          CLEAR: lv_unit_price.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Customer Material Number</FPCLINE>
      <FPCLINE>          READ TABLE li_knmt INTO lwa_knmt WITH KEY matnr = &lt;lfs_item_detail&gt;-vbdpr-matnr</FPCLINE>
      <FPCLINE>                                           BINARY SEARCH.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            lwa_inv_items-kdmat = lwa_knmt-kdmat.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Delivery Information</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If the document type is delivery (J) then only delivery information will be populated</FPCLINE>
      <FPCLINE>          IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>            READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                          WITH KEY criteria = lc_enh_criteria-delvy</FPCLINE>
      <FPCLINE>                                                   sel_low  = fp_x_head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*         Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>            IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>              PERFORM f_format_date USING &lt;lfs_item_detail&gt;-vbdpr-fbuda</FPCLINE>
      <FPCLINE>                                 CHANGING lv_date_str.</FPCLINE>
      <FPCLINE>*Begin of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>*              CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lc_slash lv_date_str</FPCLINE>
      <FPCLINE>*                     INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>*End of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>**Begin of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>              lv_text_name = lc_text_from.</FPCLINE>
      <FPCLINE>              PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                                  gv_form_lang</FPCLINE>
      <FPCLINE>                                            CHANGING lv_text      .</FPCLINE>
      <FPCLINE>              CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lv_text lv_date_str</FPCLINE>
      <FPCLINE>                     INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>              CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                     lv_text_name.</FPCLINE>
      <FPCLINE>              lv_text_name = lc_text_service.</FPCLINE>
      <FPCLINE>              PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                                  gv_form_lang</FPCLINE>
      <FPCLINE>                                            CHANGING lv_text.</FPCLINE>
      <FPCLINE>              CONCATENATE lwa_inv_items-del_info lc_slash lc_equal lv_text</FPCLINE>
      <FPCLINE>                                               INTO lwa_inv_items-del_info</FPCLINE>
      <FPCLINE>                                               SEPARATED BY space.</FPCLINE>
      <FPCLINE>              CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                     lv_text_name.</FPCLINE>
      <FPCLINE>**End of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>              CLEAR lv_date_str.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Billing Document Item Text</FPCLINE>
      <FPCLINE>          CONCATENATE fp_x_head_detail-vbdkr-vbeln &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                 INTO lwa_inv_items-bill_item_std_text.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>          IF li_tvap IS NOT INITIAL.</FPCLINE>
      <FPCLINE>            READ TABLE li_tvap INTO lwa_tvap WITH KEY pstyv = &lt;lfs_item_detail&gt;-vbdpr-pstyv BINARY SEARCH.</FPCLINE>
      <FPCLINE>            IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>              lwa_inv_items-foc_flag = abap_true.</FPCLINE>
      <FPCLINE>              CLEAR lwa_tvap.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF li_tvap IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          APPEND lwa_inv_items TO i_inv_items.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#8134 by NALI</FPCLINE>
      <FPCLINE>          CLEAR lwa_inv_items.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#8134 by NALI</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*       Check Distribution Channel for I/C billing (EHQ/ USPA Inter company billing)</FPCLINE>
      <FPCLINE>        READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                      WITH KEY criteria = lc_enh_criteria-inter_comp</FPCLINE>
      <FPCLINE>                                               sel_low  = fp_x_head_detail-vbdkr-vtweg.</FPCLINE>
      <FPCLINE>*       Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          lwa_inv_items-posnr     = &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE>          SHIFT lwa_inv_items-posnr LEFT DELETING LEADING lc_zero.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5678 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          lwa_inv_items-matnr     = &lt;lfs_item_detail&gt;-vbdpr-matnr.</FPCLINE>
      <FPCLINE>          lwa_inv_items-arktx     = &lt;lfs_item_detail&gt;-vbdpr-arktx.</FPCLINE>
      <FPCLINE>          lwa_inv_items-fkimg_tmp = &lt;lfs_item_detail&gt;-vbdpr-fkimg.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Unit of Measure in Output Language</FPCLINE>
      <FPCLINE>          CALL FUNCTION &apos;CONVERSION_EXIT_CUNIT_OUTPUT&apos;</FPCLINE>
      <FPCLINE>            EXPORTING</FPCLINE>
      <FPCLINE>              input          = &lt;lfs_item_detail&gt;-vbdpr-vrkme</FPCLINE>
      <FPCLINE>              language       = gv_form_lang</FPCLINE>
      <FPCLINE>            IMPORTING</FPCLINE>
      <FPCLINE>              output         = lwa_inv_items-vrkme</FPCLINE>
      <FPCLINE>            EXCEPTIONS</FPCLINE>
      <FPCLINE>              unit_not_found = 1</FPCLINE>
      <FPCLINE>              OTHERS         = 2.</FPCLINE>
      <FPCLINE>          IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>            lwa_inv_items-vrkme = &lt;lfs_item_detail&gt;-vbdpr-vrkme.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>*          WRITE lwa_inv_items-fkimg_tmp TO lwa_inv_items-fkimg UNIT lwa_inv_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE>          lv_quantity_tmp = lwa_inv_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>          WRITE lv_quantity_tmp TO lwa_inv_items-fkimg.</FPCLINE>
      <FPCLINE>          CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 5688 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Read All BOM Components</FPCLINE>
      <FPCLINE>          LOOP AT li_item_detail_sub_item INTO lwa_item_detail_tmp.</FPCLINE>
      <FPCLINE>            IF lwa_item_detail_tmp-vbdpr-uepos EQ &lt;lfs_item_detail&gt;-vbdpr-posnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            BOM Component</FPCLINE>
      <FPCLINE>              lwa_inv_bom_items-matnr      = lwa_item_detail_tmp-vbdpr-matnr.</FPCLINE>
      <FPCLINE>              lwa_inv_bom_items-fkimg_tmp  = lwa_item_detail_tmp-vbdpr-fkimg.</FPCLINE>
      <FPCLINE>              lwa_inv_bom_items-arktx      = lwa_item_detail_tmp-vbdpr-arktx.</FPCLINE>
      <FPCLINE>              lwa_inv_bom_items-amount_tmp = lwa_item_detail_tmp-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            Calculate BOM Header Amount</FPCLINE>
      <FPCLINE>              lwa_inv_items-amount_tmp = lwa_inv_items-amount_tmp + lwa_item_detail_tmp-vbdpr-kzwi1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            Unit of Measure in Output Language</FPCLINE>
      <FPCLINE>              CALL FUNCTION &apos;CONVERSION_EXIT_CUNIT_OUTPUT&apos;</FPCLINE>
      <FPCLINE>                EXPORTING</FPCLINE>
      <FPCLINE>                  input          = lwa_item_detail_tmp-vbdpr-vrkme</FPCLINE>
      <FPCLINE>                  language       = gv_form_lang</FPCLINE>
      <FPCLINE>                IMPORTING</FPCLINE>
      <FPCLINE>                  output         = lwa_inv_bom_items-vrkme</FPCLINE>
      <FPCLINE>                EXCEPTIONS</FPCLINE>
      <FPCLINE>                  unit_not_found = 1</FPCLINE>
      <FPCLINE>                  OTHERS         = 2.</FPCLINE>
      <FPCLINE>              IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>                lwa_inv_bom_items-vrkme = lwa_item_detail_tmp-vbdpr-vrkme.</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE>              IF lwa_inv_bom_items-fkimg_tmp &lt;&gt; 0.</FPCLINE>
      <FPCLINE>                lv_unit_price = lwa_inv_bom_items-amount_tmp / lwa_inv_bom_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF lwa_inv_bom_items-fkimg_tmp &lt;&gt; 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Begin of Delete for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE>*              WRITE lwa_inv_bom_items-fkimg_tmp  TO lwa_inv_bom_items-fkimg      UNIT lwa_inv_bom_items-vrkme.</FPCLINE>
      <FPCLINE>* End of Delete for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE>* Begin of Insert for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE>              lv_quantity_tmp = lwa_inv_bom_items-fkimg_tmp.</FPCLINE>
      <FPCLINE>              WRITE lv_quantity_tmp TO lwa_inv_bom_items-fkimg.</FPCLINE>
      <FPCLINE>              CLEAR lv_quantity_tmp.</FPCLINE>
      <FPCLINE>* End of Insert for Defect 6075 by Muhammed Syed</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*&amp;--Commented as we are passing the KRW currency to the EUR currency</FPCLINE>
      <FPCLINE>*&amp;--    for the decimal format issue.</FPCLINE>
      <FPCLINE>*              WRITE lwa_inv_bom_items-amount_tmp TO lwa_inv_bom_items-amount     CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>*              WRITE lv_unit_price                TO lwa_inv_bom_items-unit_price CURRENCY fp_x_head_detail-vbdkr-waers.</FPCLINE>
      <FPCLINE>* &lt;--- End of delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              WRITE lwa_inv_bom_items-amount_tmp TO lwa_inv_bom_items-amount     CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>              WRITE lv_unit_price                TO lwa_inv_bom_items-unit_price CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>              CLEAR lv_unit_price.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            Tax Rate</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If Billing Type is ZWIA then Tax Rate will be determined as below</FPCLINE>
      <FPCLINE>              READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-fkart_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>              IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                READ TABLE fp_i_vbrk ASSIGNING &lt;lfs_vbrk&gt; WITH KEY vbeln = &lt;lfs_item_detail&gt;-vbdpr-tdname+0(10) &quot;&lt;lfs_item_detail&gt;-vbdpr-vbeln_vauf</FPCLINE>
      <FPCLINE>                                                                   fkart = &lt;lfs_emi&gt;-sel_low</FPCLINE>
      <FPCLINE>                                                                   BINARY SEARCH.</FPCLINE>
      <FPCLINE>                IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>                  READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_enh_criteria-kschl_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>                  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                    READ TABLE li_konv_tmp INTO lwa_konv WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                                                  kschl = &lt;lfs_emi&gt;-sel_low &quot; WIA2</FPCLINE>
      <FPCLINE>                                                                  koaid = lc_koaid_taxes    &quot; D</FPCLINE>
      <FPCLINE>                                                                  kinak = abap_false</FPCLINE>
      <FPCLINE>                                                         BINARY SEARCH.</FPCLINE>
      <FPCLINE>                    IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>                      lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>                      WRITE lwa_konv-kbetr TO lwa_inv_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>                      CONDENSE lwa_inv_items-kbetr.</FPCLINE>
      <FPCLINE>                      CONCATENATE lwa_inv_items-kbetr lc_percentage INTO lwa_inv_items-kbetr</FPCLINE>
      <FPCLINE>                                                                    SEPARATED BY space.</FPCLINE>
      <FPCLINE>                    ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>                  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>                ELSE. &quot; ELSE -&gt; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                  READ TABLE li_konv INTO lwa_konv</FPCLINE>
      <FPCLINE>                                     WITH KEY kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                              koaid = lc_koaid_taxes</FPCLINE>
      <FPCLINE>                                     BINARY SEARCH.</FPCLINE>
      <FPCLINE>                  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                    lwa_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>                    WRITE lwa_konv-kbetr TO lwa_inv_bom_items-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>                    CONDENSE lwa_inv_bom_items-kbetr.</FPCLINE>
      <FPCLINE>                    CONCATENATE lwa_inv_bom_items-kbetr lc_percentage</FPCLINE>
      <FPCLINE>                           INTO lwa_inv_bom_items-kbetr</FPCLINE>
      <FPCLINE>                           SEPARATED BY space.</FPCLINE>
      <FPCLINE>                  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              IF lwa_item_detail_tmp-vbdpr-xchar EQ abap_true.</FPCLINE>
      <FPCLINE>*              Batch Numbers</FPCLINE>
      <FPCLINE>                READ TABLE li_lips INTO lwa_lips</FPCLINE>
      <FPCLINE>                                   WITH KEY vbeln = lwa_item_detail_tmp-vbdpr-vgbel</FPCLINE>
      <FPCLINE>                                            posnr = lwa_item_detail_tmp-vbdpr-vgpos</FPCLINE>
      <FPCLINE>                                   BINARY SEARCH.</FPCLINE>
      <FPCLINE>                IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                  lwa_batch_numbers-batch = lwa_lips-charg.</FPCLINE>
      <FPCLINE>                  PERFORM f_format_date USING lwa_lips-vfdat</FPCLINE>
      <FPCLINE>                                     CHANGING lwa_batch_numbers-vfdat.</FPCLINE>
      <FPCLINE>                  APPEND lwa_batch_numbers TO lwa_inv_bom_items-batch_numbers.</FPCLINE>
      <FPCLINE>                  CLEAR lwa_batch_numbers.</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF lwa_item_detail_tmp-vbdpr-xchar EQ abap_true</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*            Serial Number</FPCLINE>
      <FPCLINE>              IF lwa_item_detail_tmp-vbdpr-vgtyp = lc_vgtyp_j. &quot; could be &lt;lfs_item_detail&gt;-vbdpr-VGTYP_VAUF (check in debug)</FPCLINE>
      <FPCLINE>                READ TABLE li_ser01 INTO lwa_ser01</FPCLINE>
      <FPCLINE>                                    WITH KEY lief_nr = lwa_item_detail_tmp-vbdpr-vgbel</FPCLINE>
      <FPCLINE>                                             posnr   = lwa_item_detail_tmp-vbdpr-vgpos</FPCLINE>
      <FPCLINE>                                    BINARY SEARCH.</FPCLINE>
      <FPCLINE>                IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>                  LOOP AT li_objk INTO lwa_objk.</FPCLINE>
      <FPCLINE>                    IF lwa_objk-obknr EQ lwa_ser01-obknr.</FPCLINE>
      <FPCLINE>                      APPEND lwa_objk-sernr TO lwa_inv_bom_items-serial_numbers.</FPCLINE>
      <FPCLINE>                      CLEAR lwa_objk.</FPCLINE>
      <FPCLINE>                    ENDIF. &quot; IF lwa_objk-obknr EQ lwa_ser01-obknr</FPCLINE>
      <FPCLINE>                  ENDLOOP. &quot; LOOP AT li_objk INTO lwa_objk</FPCLINE>
      <FPCLINE>                ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF lwa_item_detail_tmp-vbdpr-vgtyp = lc_vgtyp_j</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              APPEND lwa_inv_bom_items TO lwa_inv_items-bom_components.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>            ENDIF. &quot; IF lwa_item_detail_tmp-vbdpr-uepos EQ &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>          ENDLOOP. &quot; LOOP AT li_item_detail_sub_item INTO lwa_item_detail_tmp</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        BOM Header Information</FPCLINE>
      <FPCLINE>*        Customer Material Number</FPCLINE>
      <FPCLINE>          READ TABLE li_knmt INTO lwa_knmt WITH KEY matnr = &lt;lfs_item_detail&gt;-vbdpr-matnr</FPCLINE>
      <FPCLINE>                                           BINARY SEARCH.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            lwa_inv_items-kdmat = lwa_knmt-kdmat.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Delivery Information</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If the document type is delivery (J) then only delivery information will be populated</FPCLINE>
      <FPCLINE>          IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>            READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                                          WITH KEY criteria = lc_enh_criteria-delvy</FPCLINE>
      <FPCLINE>                                                   sel_low  = fp_x_head_detail-vbdkr-vkorg.</FPCLINE>
      <FPCLINE>*         Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>            IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>              PERFORM f_format_date USING &lt;lfs_item_detail&gt;-vbdpr-fbuda</FPCLINE>
      <FPCLINE>                                   CHANGING lv_date_str.</FPCLINE>
      <FPCLINE>*Begin of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>*              CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lc_slash lv_date_str</FPCLINE>
      <FPCLINE>*                     INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>*End of delete for Defect 2619 by U033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>**Begin of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>              lv_text_name = lc_text_from.</FPCLINE>
      <FPCLINE>              PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                                  gv_form_lang</FPCLINE>
      <FPCLINE>                                            CHANGING lv_text      .</FPCLINE>
      <FPCLINE>              CONCATENATE &lt;lfs_item_detail&gt;-vbdpr-vgbel lv_text lv_date_str</FPCLINE>
      <FPCLINE>                     INTO lwa_inv_items-del_info SEPARATED BY space.</FPCLINE>
      <FPCLINE>              CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                     lv_text_name.</FPCLINE>
      <FPCLINE>              lv_text_name = lc_text_service.</FPCLINE>
      <FPCLINE>              PERFORM f_read_text_del_info  USING lv_text_name</FPCLINE>
      <FPCLINE>                                                  gv_form_lang</FPCLINE>
      <FPCLINE>                                            CHANGING lv_text.</FPCLINE>
      <FPCLINE>              CONCATENATE lwa_inv_items-del_info lc_slash lc_equal lv_text</FPCLINE>
      <FPCLINE>                                               INTO lwa_inv_items-del_info</FPCLINE>
      <FPCLINE>                                               SEPARATED BY space.</FPCLINE>
      <FPCLINE>              CLEAR: lv_text,</FPCLINE>
      <FPCLINE>                     lv_text_name.</FPCLINE>
      <FPCLINE>**End of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>              CLEAR lv_date_str.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF &lt;lfs_item_detail&gt;-vbdpr-vgtyp = lc_vgtyp_j</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6294:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*        Billing Document Item Text</FPCLINE>
      <FPCLINE>          CONCATENATE fp_x_head_detail-vbdkr-vbeln &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                 INTO lwa_inv_items-bill_item_std_text.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>          IF li_tvap IS NOT INITIAL.</FPCLINE>
      <FPCLINE>            READ TABLE li_tvap INTO lwa_tvap WITH KEY pstyv = &lt;lfs_item_detail&gt;-vbdpr-pstyv BINARY SEARCH.</FPCLINE>
      <FPCLINE>            IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>              lwa_inv_items-foc_flag = abap_true.</FPCLINE>
      <FPCLINE>              CLEAR lwa_tvap.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF li_tvap IS NOT INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Check if Sales Organization is Italy</FPCLINE>
      <FPCLINE>          IF fp_x_head_detail-vbdkr-vkorg EQ lc_ivkorg.</FPCLINE>
      <FPCLINE>            CLEAR lv_count.</FPCLINE>
      <FPCLINE>            LOOP AT li_konv INTO lwa_konv WHERE kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>                                            AND   koaid = lc_koaid_taxes.</FPCLINE>
      <FPCLINE>              IF lwa_konv-kinak NE &apos;A&apos;.</FPCLINE>
      <FPCLINE>                lv_count = lv_count + 1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>              ENDIF. &quot; IF lwa_konv-kinak NE &apos;A&apos;</FPCLINE>
      <FPCLINE>            ENDLOOP. &quot; LOOP AT li_konv INTO lwa_konv WHERE kposn = &lt;lfs_item_detail&gt;-vbdpr-posnr</FPCLINE>
      <FPCLINE>            IF lv_count &gt; 1.</FPCLINE>
      <FPCLINE>* Print nothing for the tax split of the item</FPCLINE>
      <FPCLINE>              lwa_inv_items-kbetr = space.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF lv_count &gt; 1</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF fp_x_head_detail-vbdkr-vkorg EQ lc_ivkorg</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3.04 by U024694</FPCLINE>
      <FPCLINE>          APPEND lwa_inv_items TO i_inv_items.</FPCLINE>
      <FPCLINE>          CLEAR lwa_inv_items.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT li_item_detail_higher_item ASSIGNING &lt;lfs_item_detail&gt;</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_inv_items_table</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_end_of_items</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Build End of Invoice</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_end_of_items.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    BEGIN OF lc_vbtyp,</FPCLINE>
      <FPCLINE>      invoice     TYPE vbtyp VALUE &apos;M&apos;,                    &quot; Doc Category - Invoice</FPCLINE>
      <FPCLINE>      credit_memo TYPE vbtyp VALUE &apos;O&apos;,                    &quot; Doc Category - Credit memo</FPCLINE>
      <FPCLINE>      debit_memo  TYPE vbtyp VALUE &apos;P&apos;,                    &quot; Doc Category - Debit_memo</FPCLINE>
      <FPCLINE>    END OF lc_vbtyp,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    BEGIN OF lc_tdid,</FPCLINE>
      <FPCLINE>      inv_cust_master_note TYPE tdid VALUE &apos;Z006&apos;,         &quot; Text ID</FPCLINE>
      <FPCLINE>      inv_oa_header_note   TYPE tdid VALUE &apos;Z009&apos;,         &quot; Text ID</FPCLINE>
      <FPCLINE>    END OF lc_tdid,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    lc_tdobject_invoice_header TYPE tdobject VALUE &apos;VBBK&apos;, &quot; Texts: Application Object</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    lc_en TYPE spras VALUE &apos;E&apos;. &quot; Language Key</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_item_detail      TYPE invoice_s_prt_item_detail, &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE>    lwa_bill_header_text TYPE ty_bill_header_text,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    li_lines             TYPE STANDARD TABLE OF tline, &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE>    lv_name              TYPE tdobname.                &quot; Name</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Original Invoice</FPCLINE>
      <FPCLINE>  SELECT vbelv &quot; Preceding sales and distribution document</FPCLINE>
      <FPCLINE>    UP TO 1 ROWS</FPCLINE>
      <FPCLINE>    FROM vbfa  &quot; Sales Document Flow</FPCLINE>
      <FPCLINE>    INTO gv_original_invoice</FPCLINE>
      <FPCLINE>    WHERE vbeln   EQ gv_vbeln</FPCLINE>
      <FPCLINE>    AND   vbtyp_n IN (lc_vbtyp-debit_memo ,lc_vbtyp-credit_memo)</FPCLINE>
      <FPCLINE>    AND   vbtyp_v EQ lc_vbtyp-invoice.</FPCLINE>
      <FPCLINE>  ENDSELECT.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Delete for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* This code is not required anymore as header texts are retrieved now in the interface itself.</FPCLINE>
      <FPCLINE>* Billing document header texts (Z006 / Z009 Text types)</FPCLINE>
      <FPCLINE>*  lwa_bill_header_text-tdobject = lc_tdobject_invoice_header.</FPCLINE>
      <FPCLINE>*  lwa_bill_header_text-tdname   = gv_vbeln.</FPCLINE>
      <FPCLINE>*  lwa_bill_header_text-tdid     = lc_tdid-inv_cust_master_note.</FPCLINE>
      <FPCLINE>*  APPEND lwa_bill_header_text TO i_bill_header_text.</FPCLINE>
      <FPCLINE>*  CLEAR lwa_bill_header_text.</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>*  lwa_bill_header_text-tdobject = lc_tdobject_invoice_header.</FPCLINE>
      <FPCLINE>*  lwa_bill_header_text-tdname   = gv_vbeln.</FPCLINE>
      <FPCLINE>*  lwa_bill_header_text-tdid     = lc_tdid-inv_oa_header_note.</FPCLINE>
      <FPCLINE>*  APPEND lwa_bill_header_text TO i_bill_header_text.</FPCLINE>
      <FPCLINE>*  CLEAR lwa_bill_header_text.</FPCLINE>
      <FPCLINE>* &lt;--- End of Delete for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* Billing document header texts (Z006 / Z009 Text types)</FPCLINE>
      <FPCLINE>  lv_name = gv_vbeln.</FPCLINE>
      <FPCLINE>  CLEAR li_lines[].</FPCLINE>
      <FPCLINE>* Text Z006</FPCLINE>
      <FPCLINE>  CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      client                  = sy-mandt</FPCLINE>
      <FPCLINE>      id                      = lc_tdid-inv_cust_master_note</FPCLINE>
      <FPCLINE>      language                = gv_form_lang</FPCLINE>
      <FPCLINE>      name                    = lv_name</FPCLINE>
      <FPCLINE>      object                  = lc_tdobject_invoice_header</FPCLINE>
      <FPCLINE>    TABLES</FPCLINE>
      <FPCLINE>      lines                   = li_lines</FPCLINE>
      <FPCLINE>    EXCEPTIONS</FPCLINE>
      <FPCLINE>      id                      = 1</FPCLINE>
      <FPCLINE>      language                = 2</FPCLINE>
      <FPCLINE>      name                    = 3</FPCLINE>
      <FPCLINE>      not_found               = 4</FPCLINE>
      <FPCLINE>      object                  = 5</FPCLINE>
      <FPCLINE>      reference_check         = 6</FPCLINE>
      <FPCLINE>      wrong_access_to_archive = 7</FPCLINE>
      <FPCLINE>      OTHERS                  = 8.</FPCLINE>
      <FPCLINE>  IF sy-subrc &lt;&gt; 0 OR li_lines[] IS INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    CLEAR li_lines[].</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>      EXPORTING</FPCLINE>
      <FPCLINE>        client                  = sy-mandt</FPCLINE>
      <FPCLINE>        id                      = lc_tdid-inv_cust_master_note</FPCLINE>
      <FPCLINE>        language                = lc_en</FPCLINE>
      <FPCLINE>        name                    = lv_name</FPCLINE>
      <FPCLINE>        object                  = lc_tdobject_invoice_header</FPCLINE>
      <FPCLINE>      TABLES</FPCLINE>
      <FPCLINE>        lines                   = li_lines</FPCLINE>
      <FPCLINE>      EXCEPTIONS</FPCLINE>
      <FPCLINE>        id                      = 1</FPCLINE>
      <FPCLINE>        language                = 2</FPCLINE>
      <FPCLINE>        name                    = 3</FPCLINE>
      <FPCLINE>        not_found               = 4</FPCLINE>
      <FPCLINE>        object                  = 5</FPCLINE>
      <FPCLINE>        reference_check         = 6</FPCLINE>
      <FPCLINE>        wrong_access_to_archive = 7</FPCLINE>
      <FPCLINE>        OTHERS                  = 8.</FPCLINE>
      <FPCLINE>    IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      APPEND LINES OF li_lines[] TO i_bill_header_txt[].</FPCLINE>
      <FPCLINE>      CLEAR li_lines[].</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc &lt;&gt; 0 OR li_lines[] IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    APPEND LINES OF li_lines[] TO i_bill_header_txt[].</FPCLINE>
      <FPCLINE>    CLEAR li_lines[].</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc &lt;&gt; 0 OR li_lines[] IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CLEAR li_lines[].</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Text Z009</FPCLINE>
      <FPCLINE>  CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      client                  = sy-mandt</FPCLINE>
      <FPCLINE>      id                      = lc_tdid-inv_oa_header_note</FPCLINE>
      <FPCLINE>      language                = gv_form_lang</FPCLINE>
      <FPCLINE>      name                    = lv_name</FPCLINE>
      <FPCLINE>      object                  = lc_tdobject_invoice_header</FPCLINE>
      <FPCLINE>    TABLES</FPCLINE>
      <FPCLINE>      lines                   = li_lines</FPCLINE>
      <FPCLINE>    EXCEPTIONS</FPCLINE>
      <FPCLINE>      id                      = 1</FPCLINE>
      <FPCLINE>      language                = 2</FPCLINE>
      <FPCLINE>      name                    = 3</FPCLINE>
      <FPCLINE>      not_found               = 4</FPCLINE>
      <FPCLINE>      object                  = 5</FPCLINE>
      <FPCLINE>      reference_check         = 6</FPCLINE>
      <FPCLINE>      wrong_access_to_archive = 7</FPCLINE>
      <FPCLINE>      OTHERS                  = 8.</FPCLINE>
      <FPCLINE>  IF sy-subrc &lt;&gt; 0 OR li_lines[] IS INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    CLEAR li_lines[].</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>      EXPORTING</FPCLINE>
      <FPCLINE>        client                  = sy-mandt</FPCLINE>
      <FPCLINE>        id                      = lc_tdid-inv_oa_header_note</FPCLINE>
      <FPCLINE>        language                = lc_en</FPCLINE>
      <FPCLINE>        name                    = lv_name</FPCLINE>
      <FPCLINE>        object                  = lc_tdobject_invoice_header</FPCLINE>
      <FPCLINE>      TABLES</FPCLINE>
      <FPCLINE>        lines                   = li_lines</FPCLINE>
      <FPCLINE>      EXCEPTIONS</FPCLINE>
      <FPCLINE>        id                      = 1</FPCLINE>
      <FPCLINE>        language                = 2</FPCLINE>
      <FPCLINE>        name                    = 3</FPCLINE>
      <FPCLINE>        not_found               = 4</FPCLINE>
      <FPCLINE>        object                  = 5</FPCLINE>
      <FPCLINE>        reference_check         = 6</FPCLINE>
      <FPCLINE>        wrong_access_to_archive = 7</FPCLINE>
      <FPCLINE>        OTHERS                  = 8.</FPCLINE>
      <FPCLINE>    IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      APPEND LINES OF li_lines[] TO i_bill_header_txt[].</FPCLINE>
      <FPCLINE>      CLEAR li_lines[].</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc &lt;&gt; 0 OR li_lines[] IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    APPEND LINES OF li_lines[] TO i_bill_header_txt[].</FPCLINE>
      <FPCLINE>    CLEAR li_lines[].</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc &lt;&gt; 0 OR li_lines[] IS INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End    of Insert for Defect#7275:D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_end_of_items</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_sub_total</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Calculate Sub-Total</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_sub_total.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_sub_total TYPE kwert. &quot; Condition value</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_inv_items TYPE ty_inv_items.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  LOOP AT i_inv_items INTO lwa_inv_items.</FPCLINE>
      <FPCLINE>    lv_sub_total = lv_sub_total + lwa_inv_items-amount_tmp.</FPCLINE>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT i_inv_items INTO lwa_inv_items</FPCLINE>
      <FPCLINE>  WRITE lv_sub_total TO gv_sub_total CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_sub_total</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_charges</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Calculate Freight Charges, Handling Charges, Insurance Charges,</FPCLINE>
      <FPCLINE>*        Document Charges</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_KONV  Conditions</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_charges USING fp_i_konv TYPE ty_t_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>*For each condition, a different logic is used for amount calculation</FPCLINE>
      <FPCLINE>*and if a new condition is added it will require change in logic,</FPCLINE>
      <FPCLINE>*therefore constants are used instead EMI entries</FPCLINE>
      <FPCLINE>    BEGIN OF lc_kschl,</FPCLINE>
      <FPCLINE>      total_freight     TYPE kscha VALUE &apos;ZTFR&apos;, &quot; Condition type</FPCLINE>
      <FPCLINE>      handling_charges  TYPE kscha VALUE &apos;ZHDL&apos;, &quot; Condition type</FPCLINE>
      <FPCLINE>      insurance_chrages TYPE kscha VALUE &apos;ZINS&apos;, &quot; Condition type</FPCLINE>
      <FPCLINE>      document_charges  TYPE kscha VALUE &apos;ZDOC&apos;, &quot; Condition type</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>      envt_fee          TYPE kscha VALUE &apos;ZENV&apos;, &quot;Environmental fee</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>    END OF lc_kschl.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_freight_charges   TYPE	kwert,</FPCLINE>
      <FPCLINE>    lv_handling_charges	 TYPE	kwert,</FPCLINE>
      <FPCLINE>    lv_insurance_charges TYPE	kwert,</FPCLINE>
      <FPCLINE>    lv_document_charges	 TYPE	kwert,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>    lv_envt_fee          TYPE kwert. &quot; Condition value</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_konv TYPE ty_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  LOOP AT fp_i_konv INTO lwa_konv .</FPCLINE>
      <FPCLINE>    IF lwa_konv-kinak EQ abap_false.</FPCLINE>
      <FPCLINE>*  Calculate Totals for different Conditions</FPCLINE>
      <FPCLINE>      CASE lwa_konv-kschl.</FPCLINE>
      <FPCLINE>        WHEN lc_kschl-total_freight.</FPCLINE>
      <FPCLINE>          lv_freight_charges = lv_freight_charges + lwa_konv-kwert.</FPCLINE>
      <FPCLINE>        WHEN lc_kschl-handling_charges.</FPCLINE>
      <FPCLINE>          lv_handling_charges = lv_handling_charges + lwa_konv-kwert.</FPCLINE>
      <FPCLINE>        WHEN lc_kschl-insurance_chrages.</FPCLINE>
      <FPCLINE>          lv_insurance_charges = lv_insurance_charges + lwa_konv-kwert.</FPCLINE>
      <FPCLINE>        WHEN lc_kschl-document_charges.</FPCLINE>
      <FPCLINE>          lv_document_charges = lv_document_charges + lwa_konv-kwert.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>        WHEN lc_kschl-envt_fee.</FPCLINE>
      <FPCLINE>          lv_envt_fee = lv_envt_fee + lwa_konv-kwert.</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>        WHEN OTHERS.</FPCLINE>
      <FPCLINE>          CONTINUE.</FPCLINE>
      <FPCLINE>      ENDCASE.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF lwa_konv-kinak EQ abap_false</FPCLINE>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT fp_i_konv INTO lwa_konv</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>*  WRITE lv_freight_charges   TO gv_freight_charges   CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>  IF lv_freight_charges IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    WRITE lv_freight_charges   TO gv_freight_charges   CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>    CLEAR lv_freight_charges.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF lv_freight_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>    CLEAR gv_freight_charges.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF lv_freight_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End   of Change for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>*  WRITE lv_handling_charges  TO gv_handling_charges  CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>  IF lv_handling_charges IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    WRITE lv_handling_charges  TO gv_handling_charges  CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF lv_handling_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>    CLEAR gv_handling_charges.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF lv_handling_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Change for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>* &lt;--- Begin of Change for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>*    WRITE lv_insurance_charges TO gv_insurance_charges CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>  IF lv_insurance_charges IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    WRITE lv_insurance_charges TO gv_insurance_charges CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF lv_insurance_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>    CLEAR gv_insurance_charges.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF lv_insurance_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End   of Change for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>*  WRITE lv_document_charges  TO gv_document_charges  CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>  IF lv_document_charges IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    WRITE lv_document_charges  TO gv_document_charges  CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF lv_document_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>    CLEAR gv_document_charges.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF lv_document_charges IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Change for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>* &lt;--- Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>  IF lv_envt_fee IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    WRITE lv_envt_fee  TO gv_envt_fee CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>    CLEAR lv_envt_fee.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF lv_envt_fee IS NOT INITIAL</FPCLINE>
      <FPCLINE>    CLEAR gv_envt_fee.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF lv_envt_fee IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_charges</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_down_payment</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Down Payment Amounts / Outstanding amounts / List of Down Pay.</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_TOTAL_AMT      Total Amount</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBRP         Item Details</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_down_payment USING fp_total_amt TYPE netwr &quot; Net Value in Document Currency</FPCLINE>
      <FPCLINE>                              fp_i_vbrp    TYPE ty_t_vbrp.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  TYPES:</FPCLINE>
      <FPCLINE>    BEGIN OF lty_vbfa,</FPCLINE>
      <FPCLINE>      vbelv   TYPE vbeln_von,  &quot; Preceding sales and distribution document</FPCLINE>
      <FPCLINE>      posnv   TYPE posnr_von,  &quot; Preceding item of an SD document</FPCLINE>
      <FPCLINE>      vbeln   TYPE vbeln_nach, &quot; Subsequent sales and distribution document</FPCLINE>
      <FPCLINE>      posnn   TYPE posnr_nach, &quot; Subsequent item of an SD document</FPCLINE>
      <FPCLINE>      vbtyp_n	TYPE vbtyp_n,</FPCLINE>
      <FPCLINE>    END OF lty_vbfa,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    BEGIN OF lty_vbrk,</FPCLINE>
      <FPCLINE>      vbeln	TYPE vbeln_vf,</FPCLINE>
      <FPCLINE>      fkdat	TYPE fkdat,</FPCLINE>
      <FPCLINE>      netwr	TYPE netwr,</FPCLINE>
      <FPCLINE>      mwsbk	TYPE mwsbp,</FPCLINE>
      <FPCLINE>    END OF lty_vbrk.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>*Values of FAREG are SAP standards for down payments for 4 &amp; 5</FPCLINE>
      <FPCLINE>*So constants used instead EMI</FPCLINE>
      <FPCLINE>    BEGIN OF lc_fareg,</FPCLINE>
      <FPCLINE>      down_payment_4 TYPE fareg VALUE &apos;4&apos;,              &quot; Down payment in milestone billing on percentage basis</FPCLINE>
      <FPCLINE>      down_payment_5 TYPE fareg VALUE &apos;5&apos;,              &quot; Down payment in milestone billing on a value basis</FPCLINE>
      <FPCLINE>    END OF lc_fareg,</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    lc_fktyp_down_payment_request TYPE fktyp VALUE &apos;P&apos;, &quot;	Down payment request</FPCLINE>
      <FPCLINE>    lc_slash                      TYPE char1 VALUE &apos;/&apos;. &quot;Slash</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_down_payment_amt	TYPE netwr,</FPCLINE>
      <FPCLINE>    lv_outstanding_amt  TYPE netwr,  &quot; Net Value in Document Currency</FPCLINE>
      <FPCLINE>    lv_date_str         TYPE char15. &quot; Date_str of type CHAR15</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_vbrp          TYPE ty_vbrp, &quot; Items Detail for PDF Print</FPCLINE>
      <FPCLINE>    lwa_vbfa          TYPE lty_vbfa,</FPCLINE>
      <FPCLINE>    lwa_vbrk          TYPE lty_vbrk,</FPCLINE>
      <FPCLINE>    lwa_down_payments TYPE ty_down_payments.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_vbrp_down_payment_items   TYPE STANDARD TABLE OF ty_vbrp,</FPCLINE>
      <FPCLINE>    li_vbrp_down_payment_temp    TYPE STANDARD TABLE OF ty_vbrp,</FPCLINE>
      <FPCLINE>    li_vbfa                      TYPE STANDARD TABLE OF lty_vbfa,</FPCLINE>
      <FPCLINE>    li_vbrk_down_payment_billing TYPE STANDARD TABLE OF lty_vbrk.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_vbrp_down_payment_items[] = fp_i_vbrp[].</FPCLINE>
      <FPCLINE>  DELETE li_vbrp_down_payment_items WHERE NOT ( fareg EQ lc_fareg-down_payment_4 OR</FPCLINE>
      <FPCLINE>                                                fareg EQ lc_fareg-down_payment_5 ).</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF NOT li_vbrp_down_payment_items IS INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Set Downpayment Flag</FPCLINE>
      <FPCLINE>    gv_down_payment_flag = abap_true.</FPCLINE>
      <FPCLINE>*  Down Payment Currency</FPCLINE>
      <FPCLINE>    gv_currency_down_payment = gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    li_vbrp_down_payment_temp[] = li_vbrp_down_payment_items[].</FPCLINE>
      <FPCLINE>    SORT li_vbrp_down_payment_temp BY vgbel fplnr fpltr .</FPCLINE>
      <FPCLINE>    DELETE ADJACENT DUPLICATES FROM li_vbrp_down_payment_temp COMPARING vgbel fplnr fpltr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    IF NOT li_vbrp_down_payment_temp[] IS INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      SELECT vbelv   &quot; Preceding sales and distribution document</FPCLINE>
      <FPCLINE>             posnv   &quot; Preceding item of an SD document</FPCLINE>
      <FPCLINE>             vbeln   &quot; Subsequent sales and distribution document</FPCLINE>
      <FPCLINE>             posnn   &quot; Subsequent item of an SD document</FPCLINE>
      <FPCLINE>             vbtyp_n &quot; Document category of subsequent document</FPCLINE>
      <FPCLINE>        FROM vbfa    &quot; Sales Document Flow</FPCLINE>
      <FPCLINE>        INTO TABLE li_vbfa</FPCLINE>
      <FPCLINE>        FOR ALL ENTRIES IN li_vbrp_down_payment_temp</FPCLINE>
      <FPCLINE>        WHERE vbelv EQ li_vbrp_down_payment_temp-vgbel</FPCLINE>
      <FPCLINE>        AND   fktyp EQ lc_fktyp_down_payment_request</FPCLINE>
      <FPCLINE>        AND   fplnr EQ li_vbrp_down_payment_temp-fplnr</FPCLINE>
      <FPCLINE>        AND   fpltr EQ li_vbrp_down_payment_temp-fpltr.</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>        SORT li_vbfa BY vbeln.</FPCLINE>
      <FPCLINE>        DELETE ADJACENT DUPLICATES FROM li_vbfa COMPARING vbeln.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*      Down Payment Request paid by the Customer using the Billing plan number</FPCLINE>
      <FPCLINE>        SELECT vbeln &quot; Billing Document</FPCLINE>
      <FPCLINE>               fkdat &quot; Billing date for billing index and printout</FPCLINE>
      <FPCLINE>               netwr &quot; Net Value in Document Currency</FPCLINE>
      <FPCLINE>               mwsbk &quot; Tax amount in document currency</FPCLINE>
      <FPCLINE>          FROM vbrk  &quot; Billing Document: Header Data</FPCLINE>
      <FPCLINE>          INTO TABLE li_vbrk_down_payment_billing</FPCLINE>
      <FPCLINE>          FOR ALL ENTRIES IN li_vbfa</FPCLINE>
      <FPCLINE>          WHERE vbeln EQ li_vbfa-vbeln.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          SORT li_vbrk_down_payment_billing BY vbeln.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF NOT li_vbrp_down_payment_temp[] IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    LOOP AT li_vbrp_down_payment_items INTO lwa_vbrp.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*    Down Payment Amount</FPCLINE>
      <FPCLINE>      lv_down_payment_amt = lv_down_payment_amt + lwa_vbrp-netwr + lwa_vbrp-mwsbp.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    ENDLOOP. &quot; LOOP AT li_vbrp_down_payment_items INTO lwa_vbrp</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    lv_outstanding_amt = fp_total_amt - lv_down_payment_amt.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    WRITE lv_down_payment_amt TO gv_down_payment_amt CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>    WRITE lv_outstanding_amt  TO gv_outstanding_amt  CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Get Downpayment Request Billing Document</FPCLINE>
      <FPCLINE>    LOOP AT li_vbfa INTO lwa_vbfa.</FPCLINE>
      <FPCLINE>      CLEAR lv_down_payment_amt.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      READ TABLE li_vbrk_down_payment_billing INTO lwa_vbrk</FPCLINE>
      <FPCLINE>                                              WITH KEY vbeln = lwa_vbfa-vbeln</FPCLINE>
      <FPCLINE>                                              BINARY SEARCH.</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>        CLEAR lv_date_str.</FPCLINE>
      <FPCLINE>        PERFORM f_format_date USING lwa_vbrk-fkdat</FPCLINE>
      <FPCLINE>                           CHANGING lv_date_str.</FPCLINE>
      <FPCLINE>*      Document &amp; Billing Date</FPCLINE>
      <FPCLINE>        CONCATENATE lwa_vbrk-vbeln lc_slash lv_date_str</FPCLINE>
      <FPCLINE>               INTO lwa_down_payments-document_date</FPCLINE>
      <FPCLINE>               SEPARATED BY space.</FPCLINE>
      <FPCLINE>*      Amount</FPCLINE>
      <FPCLINE>        lv_down_payment_amt = lwa_vbrk-netwr + lwa_vbrk-mwsbk.</FPCLINE>
      <FPCLINE>        WRITE lv_down_payment_amt TO lwa_down_payments-amount CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>        APPEND lwa_down_payments TO i_down_payments.</FPCLINE>
      <FPCLINE>        CLEAR lwa_down_payments.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    ENDLOOP. &quot; LOOP AT li_vbfa INTO lwa_vbfa</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ENDIF. &quot; IF NOT li_vbrp_down_payment_items IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_down_payment</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>** ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect@7129(CR301) by NALI</FPCLINE>
      <FPCLINE>**&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>**&amp;      Form  f_get_tax_reporting_country</FPCLINE>
      <FPCLINE>**&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>**       Get the Tax reporting Country</FPCLINE>
      <FPCLINE>**----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>**      --&gt;FP_VBELN       Billing Document</FPCLINE>
      <FPCLINE>**      &lt;--FP_ZZRLAND     Tax Reporting Country</FPCLINE>
      <FPCLINE>**----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*FORM f_get_tax_reporting_country USING fp_vbeln   TYPE vbeln  &quot; Sales and Distribution Document Number</FPCLINE>
      <FPCLINE>*                              CHANGING fp_zzrland TYPE land1. &quot; Country Key</FPCLINE>
      <FPCLINE>**&amp;--Get Tax Reporting Country from VBRK</FPCLINE>
      <FPCLINE>*  SELECT SINGLE zzrland &quot; Tax Reporting Country</FPCLINE>
      <FPCLINE>*    FROM vbrk           &quot; Billing Document: Header Data</FPCLINE>
      <FPCLINE>*    INTO fp_zzrland</FPCLINE>
      <FPCLINE>*    WHERE vbeln = fp_vbeln.</FPCLINE>
      <FPCLINE>*</FPCLINE>
      <FPCLINE>*ENDFORM. &quot; f_get_tax_reporting_country</FPCLINE>
      <FPCLINE>** &lt;--- End of Change for D3_OTC_FDD_0014_Defect@7129(CR301) by NALI</FPCLINE>
      <FPCLINE>* ---&gt; End   of Delete for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_tax_legal_mentions</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Tax Legal Mention</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_COMP_LAND1  Company Country Code</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_KONV      Conditions</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBRK      Billing Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_tax_legal_mentions USING fp_comp_land1 TYPE land1 &quot; Country Key</FPCLINE>
      <FPCLINE>                                    fp_i_konv     TYPE ty_t_konv</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                                    fp_i_emi_constants TYPE ty_t_emi_constants</FPCLINE>
      <FPCLINE>                                    fp_i_vbrk          TYPE ty_t_vbrk</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>                                    fp_zzrland         TYPE land1 &quot; Country Key</FPCLINE>
      <FPCLINE>* &lt;--- End of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>                                    fp_vkorg           TYPE vkorg. &quot; Sales Organization</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_koaid_taxes      TYPE koaid    VALUE &apos;D&apos;,                        &quot; Taxes</FPCLINE>
      <FPCLINE>    lc_std_text         TYPE tdobname VALUE &apos;ZOTC_0014_D3_TCODE_XX_YY&apos;, &quot; Std Text</FPCLINE>
      <FPCLINE>    lc_unknown_country  TYPE char2    VALUE &apos;XX&apos;,                       &quot; Unknown_country of type CHAR2</FPCLINE>
      <FPCLINE>    lc_unknown_tax_code TYPE char2    VALUE &apos;YY&apos;,                       &quot; Unknown_tax_code of type CHAR2</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>    lc_enh_criteria_vkorg TYPE z_criteria VALUE &apos;VKORG_D3&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    lc_fkart_wia   TYPE z_criteria VALUE &apos;FKART_WIA&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>    lc_kschl_wia   TYPE z_criteria VALUE &apos;KSCHL_WIA&apos;. &quot; Enh. Criteria</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  FIELD-SYMBOLS: &lt;lfs_emi&gt;  TYPE zdev_enh_status, &quot; Enhancement Status</FPCLINE>
      <FPCLINE>                 &lt;lfs_vbrk&gt; TYPE ty_vbrk.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_std_text TYPE tdobname. &quot; Name</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_konv TYPE ty_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If Billing Type is ZWIA &amp; Condition Type is WIA2 then those records will be considered</FPCLINE>
      <FPCLINE>  READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_fkart_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    READ TABLE fp_i_vbrk ASSIGNING &lt;lfs_vbrk&gt; WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>                                                       fkart = &lt;lfs_emi&gt;-sel_low</FPCLINE>
      <FPCLINE>                                                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>      READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_kschl_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>        LOOP AT fp_i_konv INTO lwa_konv WHERE</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                                              kschl = &lt;lfs_emi&gt;-sel_low AND</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                                              kinak EQ abap_false AND</FPCLINE>
      <FPCLINE>                                              koaid EQ lc_koaid_taxes.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          lv_std_text = lc_std_text.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Delete for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>*          REPLACE lc_unknown_country  WITH fp_comp_land1  INTO lv_std_text.</FPCLINE>
      <FPCLINE>* &lt;--- End of Delete for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* Tax Reporting Country</FPCLINE>
      <FPCLINE>          REPLACE lc_unknown_country  WITH &lt;lfs_vbrk&gt;-zzrland  INTO lv_std_text.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>          REPLACE lc_unknown_tax_code WITH lwa_konv-mwsk1 INTO lv_std_text.</FPCLINE>
      <FPCLINE>          CONDENSE lv_std_text NO-GAPS.</FPCLINE>
      <FPCLINE>          APPEND lv_std_text TO i_tax_legal_mention.</FPCLINE>
      <FPCLINE>        ENDLOOP. &quot; LOOP AT fp_i_konv INTO lwa_konv WHERE</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    ELSE. &quot; ELSE -&gt; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>      LOOP AT fp_i_konv INTO lwa_konv WHERE kinak EQ abap_false AND</FPCLINE>
      <FPCLINE>                                            koaid EQ lc_koaid_taxes.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>* Sales Org for Italy from EMI</FPCLINE>
      <FPCLINE>        READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>        WITH KEY criteria = lc_enh_criteria_vkorg</FPCLINE>
      <FPCLINE>                  sel_low = fp_vkorg.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          IF lwa_konv-kawrt NE &apos;0.00&apos;.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>            lv_std_text = lc_std_text.</FPCLINE>
      <FPCLINE>* Tax Reporting Country</FPCLINE>
      <FPCLINE>            IF fp_zzrland IS NOT INITIAL.</FPCLINE>
      <FPCLINE>              REPLACE lc_unknown_country  WITH fp_zzrland  INTO lv_std_text.</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF fp_zzrland IS NOT INITIAL</FPCLINE>
      <FPCLINE>            REPLACE lc_unknown_tax_code WITH lwa_konv-mwsk1 INTO lv_std_text.</FPCLINE>
      <FPCLINE>            CONDENSE lv_std_text NO-GAPS.</FPCLINE>
      <FPCLINE>            APPEND lv_std_text TO i_tax_legal_mention.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF lwa_konv-kawrt NE &apos;0 00&apos;</FPCLINE>
      <FPCLINE>        ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          lv_std_text = lc_std_text.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Tax Reporting Country</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>*        REPLACE lc_unknown_country  WITH fp_comp_land1  INTO lv_std_text.</FPCLINE>
      <FPCLINE>          IF fp_zzrland IS NOT INITIAL.</FPCLINE>
      <FPCLINE>            REPLACE lc_unknown_country  WITH fp_zzrland  INTO lv_std_text.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF fp_zzrland IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Change for D3_OTC_FDD_0014_Defect#7129(CR301) by NALI</FPCLINE>
      <FPCLINE>          REPLACE lc_unknown_tax_code WITH lwa_konv-mwsk1 INTO lv_std_text.</FPCLINE>
      <FPCLINE>          CONDENSE lv_std_text NO-GAPS.</FPCLINE>
      <FPCLINE>          APPEND lv_std_text TO i_tax_legal_mention.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014 D3R3.05 by U024694</FPCLINE>
      <FPCLINE>      ENDLOOP. &quot; LOOP AT fp_i_konv INTO lwa_konv WHERE kinak EQ abap_false AND</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>  SORT i_tax_legal_mention BY std_text.</FPCLINE>
      <FPCLINE>  DELETE ADJACENT DUPLICATES FROM i_tax_legal_mention COMPARING std_text.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_tax_legal_mentions</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_bank_details</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get Bio-Rad Bank Details</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_BUKRS                 Company Code</FPCLINE>
      <FPCLINE>*      --&gt;FP_WAERK                 Document Currency</FPCLINE>
      <FPCLINE>*      --&gt;fp_i_emi_constants        EMI Entries</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_bank_details USING fp_bukrs          TYPE bukrs &quot; Company Code</FPCLINE>
      <FPCLINE>                          fp_waerk          TYPE waerk &quot; SD Document Currency</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>                          fp_vkorg          TYPE vkorg &quot; Sales Organisation</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>                          fp_i_emi_constants TYPE ty_t_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_bukrs    TYPE z_criteria VALUE &apos;CAP_BUKRS&apos;,                      &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>    lc_firma_ch TYPE z_criteria VALUE &apos;ZVKORG_FIRMA_CH&apos;,                &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>    lc_bankaddr_firma_ch  TYPE tdobname VALUE &apos;ZOTC_BANKADDR_FIRMA_CH&apos;, &quot; Satandard Text</FPCLINE>
      <FPCLINE>    lc_tdid     TYPE tdid       VALUE &apos;ST&apos;,                             &quot; Text ID</FPCLINE>
      <FPCLINE>    lc_object   TYPE tdobject   VALUE &apos;TEXT&apos;,                           &quot; Texts: Application Object</FPCLINE>
      <FPCLINE>    lc_en       TYPE langu      VALUE &apos;E&apos;,                              &quot; Language Key</FPCLINE>
      <FPCLINE>    lc_sep      TYPE char1      VALUE &apos;-&apos;,                              &quot; Sep of type CHAR1</FPCLINE>
      <FPCLINE>*---&gt; Begin of change for CR#356 by U033867</FPCLINE>
      <FPCLINE>    lc_bank_key_nval TYPE z_criteria      VALUE &apos;BANK_KEY_NVALUE&apos;, &quot; Bank country key</FPCLINE>
      <FPCLINE>    lc_bank_key_cle  TYPE z_criteria      VALUE &apos;BANK_KEY_CLEACC&apos;, &quot; Bank country key</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>    lc_bank_nocle      TYPE z_criteria    VALUE &apos;BANK_KEY_NOCLEACC&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>    lc_bank_key_acc  TYPE z_criteria      VALUE &apos;BANK_KEY_ACCNO&apos;. &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>*&lt;--- End of change for CR#356 by u033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  TYPES:</FPCLINE>
      <FPCLINE>    BEGIN OF lty_zotc_bank,</FPCLINE>
      <FPCLINE>      bukrs TYPE bukrs, &quot; Company Code</FPCLINE>
      <FPCLINE>      waerk	TYPE waerk,</FPCLINE>
      <FPCLINE>      hbkid	TYPE hbkid,</FPCLINE>
      <FPCLINE>      htkid	TYPE hktid,</FPCLINE>
      <FPCLINE>    END OF lty_zotc_bank.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_banks TYPE banks, &quot; Bank country key</FPCLINE>
      <FPCLINE>    lv_bankl TYPE bankk, &quot; Bank Keys</FPCLINE>
      <FPCLINE>    lv_bankn TYPE bankn, &quot; Bank account number</FPCLINE>
      <FPCLINE>    lv_bkont TYPE bkont, &quot; Bank Control Key</FPCLINE>
      <FPCLINE>*---&gt; Begin of change for CR#356 by U033867</FPCLINE>
      <FPCLINE>    lv_len   TYPE int4,     &quot; Natural Number</FPCLINE>
      <FPCLINE>    lv_var   TYPE int4,     &quot; Natural Number</FPCLINE>
      <FPCLINE>    lv_count TYPE int4,     &quot; Natural Number</FPCLINE>
      <FPCLINE>    lv_bank_iban TYPE iban. &quot; IBAN (International Bank Account Number)</FPCLINE>
      <FPCLINE>*&lt;--- End of change for CR#356 by u033867</FPCLINE>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_zotc_bank TYPE lty_zotc_bank.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_zotc_bank TYPE STANDARD TABLE OF lty_zotc_bank,</FPCLINE>
      <FPCLINE>    li_lines             TYPE STANDARD TABLE OF tline. &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get bank details based on company code and currency</FPCLINE>
      <FPCLINE>  SELECT bukrs     &quot; Company Code</FPCLINE>
      <FPCLINE>         waerk     &quot; SD Document Currency</FPCLINE>
      <FPCLINE>         hbkid     &quot; Short Key for a House Bank</FPCLINE>
      <FPCLINE>         htkid     &quot; ID for Account Details</FPCLINE>
      <FPCLINE>    FROM zotc_bank &quot; House Bank Determination</FPCLINE>
      <FPCLINE>    INTO TABLE li_zotc_bank</FPCLINE>
      <FPCLINE>    WHERE bukrs = fp_bukrs.</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    SORT li_zotc_bank BY bukrs waerk.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Check Entry exists for Document Currency</FPCLINE>
      <FPCLINE>  READ TABLE li_zotc_bank INTO lwa_zotc_bank</FPCLINE>
      <FPCLINE>                          WITH KEY bukrs = fp_bukrs</FPCLINE>
      <FPCLINE>                                   waerk = fp_waerk</FPCLINE>
      <FPCLINE>                          BINARY SEARCH.</FPCLINE>
      <FPCLINE>  IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>    READ TABLE li_zotc_bank INTO lwa_zotc_bank</FPCLINE>
      <FPCLINE>                            WITH KEY bukrs = fp_bukrs</FPCLINE>
      <FPCLINE>                                     waerk = space</FPCLINE>
      <FPCLINE>                            BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>      RETURN.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Get bank name, street, city and SWIFT based on T012</FPCLINE>
      <FPCLINE>  SELECT SINGLE</FPCLINE>
      <FPCLINE>         banks &quot; Bank country key</FPCLINE>
      <FPCLINE>         bankl &quot; Bank Keys</FPCLINE>
      <FPCLINE>    FROM t012  &quot; House Banks</FPCLINE>
      <FPCLINE>    INTO (lv_banks, lv_bankl)</FPCLINE>
      <FPCLINE>    WHERE bukrs = lwa_zotc_bank-bukrs</FPCLINE>
      <FPCLINE>      AND hbkid = lwa_zotc_bank-hbkid.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>    SELECT SINGLE</FPCLINE>
      <FPCLINE>           banka &quot; Name of bank</FPCLINE>
      <FPCLINE>           stras &quot; House number and street</FPCLINE>
      <FPCLINE>           ort01 &quot; City</FPCLINE>
      <FPCLINE>           swift &quot; SWIFT/BIC for International Payments</FPCLINE>
      <FPCLINE>      FROM bnka  &quot; Bank master record</FPCLINE>
      <FPCLINE>      INTO (gv_bank_name,</FPCLINE>
      <FPCLINE>            gv_bank_address,</FPCLINE>
      <FPCLINE>            gv_bank_city,</FPCLINE>
      <FPCLINE>            gv_bank_bic)</FPCLINE>
      <FPCLINE>      WHERE banks = lv_banks</FPCLINE>
      <FPCLINE>        AND bankl = lv_bankl.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>* Get IBAN number based on T012K</FPCLINE>
      <FPCLINE>  SELECT SINGLE</FPCLINE>
      <FPCLINE>         bankn &quot; Bank account number</FPCLINE>
      <FPCLINE>         bkont &quot; Bank Control Key</FPCLINE>
      <FPCLINE>    FROM t012k &quot; House Bank Accounts</FPCLINE>
      <FPCLINE>    INTO (lv_bankn, lv_bkont)</FPCLINE>
      <FPCLINE>    WHERE bukrs = lwa_zotc_bank-bukrs</FPCLINE>
      <FPCLINE>      AND hbkid = lwa_zotc_bank-hbkid</FPCLINE>
      <FPCLINE>      AND hktid = lwa_zotc_bank-htkid.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>    SELECT SINGLE</FPCLINE>
      <FPCLINE>           iban  &quot; IBAN (International Bank Account Number)</FPCLINE>
      <FPCLINE>      FROM tiban &quot; IBAN</FPCLINE>
      <FPCLINE>*---&gt; Begin of change for CR#356 by U033867</FPCLINE>
      <FPCLINE>      INTO lv_bank_iban</FPCLINE>
      <FPCLINE>*&lt;--- End of change for CR#356 by u033867</FPCLINE>
      <FPCLINE>*---&gt; Begin of delete for CR#356 by U033867</FPCLINE>
      <FPCLINE>*      INTO gv_bank_iban</FPCLINE>
      <FPCLINE>*&lt;--- End of delete for CR#356 by u033867</FPCLINE>
      <FPCLINE>      WHERE banks = lv_banks</FPCLINE>
      <FPCLINE>        AND bankl = lv_bankl</FPCLINE>
      <FPCLINE>        AND bankn = lv_bankn</FPCLINE>
      <FPCLINE>        AND bkont = lv_bkont.</FPCLINE>
      <FPCLINE>*---&gt; Begin of change for CR#356 by U033867</FPCLINE>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      CONDENSE lv_bank_iban .</FPCLINE>
      <FPCLINE>      lv_len = strlen( lv_bank_iban ).</FPCLINE>
      <FPCLINE>      lv_count = ceil( lv_len / &apos;4.0&apos; ).</FPCLINE>
      <FPCLINE>      lv_var = 0.</FPCLINE>
      <FPCLINE>      DO lv_count TIMES.</FPCLINE>
      <FPCLINE>        CONCATENATE gv_bank_iban lv_bank_iban+lv_var(4)</FPCLINE>
      <FPCLINE>                 INTO  gv_bank_iban SEPARATED BY space.</FPCLINE>
      <FPCLINE>        lv_var = lv_var + 4 .</FPCLINE>
      <FPCLINE>      ENDDO.</FPCLINE>
      <FPCLINE>      SHIFT gv_bank_iban LEFT DELETING LEADING space.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>*&lt;--- End of change for CR#356 by u033867</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*---&gt; Begin of delete for CR#356 by U033867</FPCLINE>
      <FPCLINE>*  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>*                               WITH KEY criteria = lc_bukrs</FPCLINE>
      <FPCLINE>*                                        sel_low  = fp_bukrs.</FPCLINE>
      <FPCLINE>**       Small table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>*  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*    CONCATENATE lv_bankl+0(2)</FPCLINE>
      <FPCLINE>*                lv_bankl+2(2)</FPCLINE>
      <FPCLINE>*                lv_bankl+4(2)</FPCLINE>
      <FPCLINE>*                lv_bankn</FPCLINE>
      <FPCLINE>*           INTO gv_bank_account</FPCLINE>
      <FPCLINE>*           SEPARATED BY lc_sep.</FPCLINE>
      <FPCLINE>*  ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*    CONCATENATE lv_bankl</FPCLINE>
      <FPCLINE>*                lv_bankn</FPCLINE>
      <FPCLINE>*                lv_bkont</FPCLINE>
      <FPCLINE>*           INTO gv_bank_account</FPCLINE>
      <FPCLINE>*           SEPARATED BY space.</FPCLINE>
      <FPCLINE>*  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>*&lt;--- End of delete for CR#356 by u033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>*---&gt; Begin of change for CR#356 by U033867</FPCLINE>
      <FPCLINE>*Binary search not used as table has few entries</FPCLINE>
      <FPCLINE>  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                               WITH KEY criteria = lc_bank_key_acc</FPCLINE>
      <FPCLINE>                                        sel_low  = lv_banks.</FPCLINE>
      <FPCLINE>  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>*        CONCATENATE lv_bankn</FPCLINE>
      <FPCLINE>*                    lv_bkont</FPCLINE>
      <FPCLINE>*           INTO gv_bank_account</FPCLINE>
      <FPCLINE>*           SEPARATED BY space.</FPCLINE>
      <FPCLINE>* ---&gt; End of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>    CONCATENATE lv_bank_iban+4(10)</FPCLINE>
      <FPCLINE>                lv_bank_iban+14(11)</FPCLINE>
      <FPCLINE>                lv_bank_iban+25(2)</FPCLINE>
      <FPCLINE>           INTO gv_bank_account</FPCLINE>
      <FPCLINE>           SEPARATED BY space.</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>*    CONCATENATE lv_bankl</FPCLINE>
      <FPCLINE>*                lv_bankn</FPCLINE>
      <FPCLINE>*                lv_bkont</FPCLINE>
      <FPCLINE>*           INTO gv_bank_account</FPCLINE>
      <FPCLINE>*           SEPARATED BY space.</FPCLINE>
      <FPCLINE>* ---&gt; End of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>    CONCATENATE lv_bankn</FPCLINE>
      <FPCLINE>                lv_bkont</FPCLINE>
      <FPCLINE>           INTO gv_bank_account</FPCLINE>
      <FPCLINE>           SEPARATED BY space.</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>*&lt;--- End of change for CR#356 by u033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>*---&gt; Begin of delete for CR#356 by U033867</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>*  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>*                               WITH KEY criteria = lc_firma_ch</FPCLINE>
      <FPCLINE>*                                        sel_low  = fp_vkorg.</FPCLINE>
      <FPCLINE>**       Small table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>*  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*&lt;--- End of delete for CR#356 by u033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>** To Change Bank Address</FPCLINE>
      <FPCLINE>**---&gt; Begin of change for CR#356 by U033867</FPCLINE>
      <FPCLINE>**Binary search not used as table has few entries</FPCLINE>
      <FPCLINE>*  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>*                               WITH KEY criteria = lc_bank_key_acc</FPCLINE>
      <FPCLINE>*                                        sel_low  = lv_banks.</FPCLINE>
      <FPCLINE>*  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>* ---&gt; End of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*Binary search not used as table has few entries</FPCLINE>
      <FPCLINE>  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                           WITH KEY criteria = lc_bank_key_nval</FPCLINE>
      <FPCLINE>                                    sel_low  = lv_banks.</FPCLINE>
      <FPCLINE>  IF sy-subrc = 0 .</FPCLINE>
      <FPCLINE>*&lt;--- End of change for CR#356 by u033867</FPCLINE>
      <FPCLINE>    CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>      EXPORTING</FPCLINE>
      <FPCLINE>        client                  = sy-mandt</FPCLINE>
      <FPCLINE>        id                      = lc_tdid</FPCLINE>
      <FPCLINE>        language                = lc_en</FPCLINE>
      <FPCLINE>        name                    = lc_bankaddr_firma_ch</FPCLINE>
      <FPCLINE>        object                  = lc_object</FPCLINE>
      <FPCLINE>      TABLES</FPCLINE>
      <FPCLINE>        lines                   = li_lines</FPCLINE>
      <FPCLINE>      EXCEPTIONS</FPCLINE>
      <FPCLINE>        id                      = 1</FPCLINE>
      <FPCLINE>        language                = 2</FPCLINE>
      <FPCLINE>        name                    = 3</FPCLINE>
      <FPCLINE>        not_found               = 4</FPCLINE>
      <FPCLINE>        object                  = 5</FPCLINE>
      <FPCLINE>        reference_check         = 6</FPCLINE>
      <FPCLINE>        wrong_access_to_archive = 7</FPCLINE>
      <FPCLINE>        OTHERS                  = 8.</FPCLINE>
      <FPCLINE>    IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>      APPEND LINES OF li_lines[] TO i_payment_terms_1[].</FPCLINE>
      <FPCLINE>      CLEAR li_lines[].</FPCLINE>
      <FPCLINE>      CLEAR gv_bank_name.</FPCLINE>
      <FPCLINE>      CLEAR gv_bank_address.</FPCLINE>
      <FPCLINE>      CLEAR gv_bank_city.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>*    gv_bankaddr_firma_ch = lc_bankaddr_firma_ch.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>*      gv_clearing_acc      = lv_bankl.</FPCLINE>
      <FPCLINE>*---&gt; Begin of change for CR#356 by U033867</FPCLINE>
      <FPCLINE>*    ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* ---&gt; End of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                     WITH KEY criteria = lc_bank_key_cle</FPCLINE>
      <FPCLINE>                              sel_low  = lv_banks.</FPCLINE>
      <FPCLINE>  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>    CONCATENATE lv_bankl+0(2)</FPCLINE>
      <FPCLINE>                lv_bankl+2(2)</FPCLINE>
      <FPCLINE>                lv_bankl+4(2)</FPCLINE>
      <FPCLINE>           INTO gv_clearing_acc</FPCLINE>
      <FPCLINE>           SEPARATED BY lc_sep.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>    READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                           WITH KEY criteria = lc_bank_nocle</FPCLINE>
      <FPCLINE>                                    sel_low  = lv_banks</FPCLINE>
      <FPCLINE>                           BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc IS NOT INITIAL.</FPCLINE>
      <FPCLINE>      gv_clearing_acc = lv_bankl.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc IS NOT INITIAL</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>*&lt;--- End of change for CR#356 by u033867</FPCLINE>
      <FPCLINE>*  ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>*    CLEAR gv_bankaddr_firma_ch.</FPCLINE>
      <FPCLINE>*    CLEAR gv_clearing_acc.</FPCLINE>
      <FPCLINE>*  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* ---&gt; End of Delete for D3_OTC_FDD_0014_CR#356_2nd_change by MGARG</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_bank_details</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_F_summary</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       VAT Summary (Tax rate / Tax base amount / Tax amount)</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_KONV  Conditions</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_vat_summary USING fp_i_konv TYPE ty_t_konv</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>                         fp_i_emi_constants TYPE ty_t_emi_constants</FPCLINE>
      <FPCLINE>                         fp_i_vbrk          TYPE ty_t_vbrk.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  TYPES:</FPCLINE>
      <FPCLINE>    BEGIN OF lty_tax_konv,</FPCLINE>
      <FPCLINE>      text1 TYPE text1_007s, &quot; Name for value-added tax</FPCLINE>
      <FPCLINE>* * ---&gt; Begin of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>      kdatu TYPE kdatu, &quot; Name for value-added tax</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>      kbetr	TYPE kbetr,</FPCLINE>
      <FPCLINE>      kawrt	TYPE kawrt,</FPCLINE>
      <FPCLINE>      kwert	TYPE kwert,</FPCLINE>
      <FPCLINE>    END OF lty_tax_konv,</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Structure to populate VAT Summary text</FPCLINE>
      <FPCLINE>    BEGIN OF lty_tstxt,</FPCLINE>
      <FPCLINE>      mwskz TYPE mwskz,      &quot; Tax on sales/purchases code</FPCLINE>
      <FPCLINE>      text1 TYPE text1_007s, &quot; Name for value-added tax</FPCLINE>
      <FPCLINE>    END OF lty_tstxt.</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_koaid_taxes TYPE koaid VALUE &apos;D&apos;, &quot; Taxes</FPCLINE>
      <FPCLINE>    lc_percentage  TYPE char1 VALUE &apos;%&apos;, &quot; Percentage</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    lc_fkart_wia   TYPE z_criteria VALUE &apos;FKART_WIA&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>    lc_kschl_wia   TYPE z_criteria VALUE &apos;KSCHL_WIA&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* * ---&gt; Begin of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>    lc_zzvatnsf   TYPE z_criteria VALUE &apos;ZZVATNSF&apos;. &quot; Enh. Criteria &quot; + DDWIVEDI</FPCLINE>
      <FPCLINE>* * ---&gt; End of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  FIELD-SYMBOLS: &lt;lfs_emi&gt;  TYPE zdev_enh_status, &quot; Enhancement Status</FPCLINE>
      <FPCLINE>                 &lt;lfs_vbrk&gt; TYPE ty_vbrk,</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* ---&gt; Begin of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>                 &lt;lfs_zzvatnsf&gt; TYPE selopt. &quot; Transfer Structure for Select Options</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_kawrt TYPE kawrt, &quot; Condition base value</FPCLINE>
      <FPCLINE>    lv_kwert TYPE kwert, &quot; Condition value</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>    lv_kalsm  TYPE kalsm_d,                     &quot; Sales and Distribution: Pricing Procedure in Pricing</FPCLINE>
      <FPCLINE>    lwa_tstxt TYPE lty_tstxt,                   &quot; work area to populate VAT text</FPCLINE>
      <FPCLINE>    li_tstxt  TYPE STANDARD TABLE OF lty_tstxt. &quot; Internal table to populate VAT text</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_konv        TYPE ty_konv,</FPCLINE>
      <FPCLINE>    lwa_tax_konv    TYPE lty_tax_konv,</FPCLINE>
      <FPCLINE>    lwa_vat_summary TYPE ty_vat_summary,</FPCLINE>
      <FPCLINE>* ---&gt; Begin of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>    li_zzvatnsf   TYPE STANDARD TABLE OF selopt, &quot; Transfer Structure for Select Options</FPCLINE>
      <FPCLINE>    lwa_emi       TYPE zdev_enh_status,          &quot; Enhancement Status</FPCLINE>
      <FPCLINE>    lwa_range     TYPE selopt.                   &quot; Transfer Structure for Select Options</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_tax_konv TYPE STANDARD TABLE OF lty_tax_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>*  Range for emi entries with criteria ZZVATNSF</FPCLINE>
      <FPCLINE>  LOOP AT fp_i_emi_constants INTO lwa_emi WHERE criteria = lc_zzvatnsf.</FPCLINE>
      <FPCLINE>    lwa_range-sign = lwa_emi-sel_sign.</FPCLINE>
      <FPCLINE>    lwa_range-option = lwa_emi-sel_option.</FPCLINE>
      <FPCLINE>    lwa_range-low = lwa_emi-sel_low.</FPCLINE>
      <FPCLINE>    APPEND lwa_range TO li_zzvatnsf.</FPCLINE>
      <FPCLINE>    CLEAR : lwa_emi,</FPCLINE>
      <FPCLINE>            lwa_range.</FPCLINE>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT fp_i_emi_constants INTO lwa_emi WHERE criteria = lc_zzvatnsf</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>* If Billing Type is ZWIA &amp; Condition Type is WIA2 then those records will be considered</FPCLINE>
      <FPCLINE>  READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_fkart_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Fetch Pricing procedure for Country key &amp; Language key</FPCLINE>
      <FPCLINE>    IF fp_i_vbrk IS NOT INITIAL.</FPCLINE>
      <FPCLINE>      SELECT kalsm &quot; Pricing procedure</FPCLINE>
      <FPCLINE>        FROM t005  &quot; Countries</FPCLINE>
      <FPCLINE>        INTO lv_kalsm</FPCLINE>
      <FPCLINE>        UP TO 1 ROWS</FPCLINE>
      <FPCLINE>        FOR ALL ENTRIES IN fp_i_vbrk</FPCLINE>
      <FPCLINE>        WHERE spras = gv_form_lang</FPCLINE>
      <FPCLINE>          AND land1 = fp_i_vbrk-zzrland.</FPCLINE>
      <FPCLINE>      ENDSELECT.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>        IF fp_i_konv IS NOT INITIAL.</FPCLINE>
      <FPCLINE>* Fetch tax code &amp; VAT name for KONV entries</FPCLINE>
      <FPCLINE>          SELECT mwskz &quot; Tax on sales/purchases code</FPCLINE>
      <FPCLINE>                 text1 &quot; Name for value-added tax</FPCLINE>
      <FPCLINE>            FROM t007s &quot; Tax Code Names</FPCLINE>
      <FPCLINE>            INTO TABLE li_tstxt</FPCLINE>
      <FPCLINE>            FOR ALL ENTRIES IN fp_i_konv</FPCLINE>
      <FPCLINE>            WHERE spras = gv_form_lang</FPCLINE>
      <FPCLINE>              AND kalsm = lv_kalsm</FPCLINE>
      <FPCLINE>            AND   mwskz = fp_i_konv-mwsk1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>            SORT li_tstxt BY mwskz.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>          CLEAR lv_kalsm.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF fp_i_konv IS NOT INITIAL</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF fp_i_vbrk IS NOT INITIAL</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    READ TABLE fp_i_vbrk ASSIGNING &lt;lfs_vbrk&gt; WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>                                                       fkart = &lt;lfs_emi&gt;-sel_low</FPCLINE>
      <FPCLINE>                                                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>      READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_kschl_wia.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>        LOOP AT fp_i_konv INTO lwa_konv WHERE kschl = &lt;lfs_emi&gt;-sel_low AND</FPCLINE>
      <FPCLINE>                                              kinak EQ abap_false AND</FPCLINE>
      <FPCLINE>                                              koaid EQ lc_koaid_taxes.</FPCLINE>
      <FPCLINE>          lwa_tax_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE>          lwa_tax_konv-kawrt = lwa_konv-kawrt.</FPCLINE>
      <FPCLINE>          lwa_tax_konv-kwert = lwa_konv-kwert.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>          READ TABLE li_tstxt INTO lwa_tstxt WITH KEY mwskz = lwa_konv-mwsk1 BINARY SEARCH.</FPCLINE>
      <FPCLINE>          IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>            lwa_tax_konv-text1 = lwa_tstxt-text1.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>          CLEAR lwa_tstxt.</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>          APPEND lwa_tax_konv TO li_tax_konv.</FPCLINE>
      <FPCLINE>          CLEAR lwa_tax_konv.</FPCLINE>
      <FPCLINE>        ENDLOOP. &quot; LOOP AT fp_i_konv INTO lwa_konv WHERE kschl = &lt;lfs_emi&gt;-sel_low AND</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    ELSE. &quot; ELSE -&gt; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>      LOOP AT fp_i_konv INTO lwa_konv WHERE  kinak EQ abap_false AND</FPCLINE>
      <FPCLINE>                                             koaid EQ lc_koaid_taxes.</FPCLINE>
      <FPCLINE>* ---&gt; Begin of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>*Checking EMI entry for ZZVATNSF criteria</FPCLINE>
      <FPCLINE>        READ TABLE fp_i_emi_constants ASSIGNING &lt;lfs_emi&gt; WITH KEY criteria = lc_zzvatnsf.</FPCLINE>
      <FPCLINE>        IF sy-subrc = 0 .</FPCLINE>
      <FPCLINE>          READ TABLE fp_i_vbrk ASSIGNING &lt;lfs_vbrk&gt; WITH KEY vbeln = gv_vbeln.</FPCLINE>
      <FPCLINE>          IF li_zzvatnsf IS NOT INITIAL.</FPCLINE>
      <FPCLINE>            READ TABLE li_zzvatnsf ASSIGNING &lt;lfs_zzvatnsf&gt; WITH KEY low = &lt;lfs_vbrk&gt;-zzvatnsf.</FPCLINE>
      <FPCLINE>            IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>              gv_serv_rend_flag = abap_true . &quot; Flag To display Serv Render Heading.</FPCLINE>
      <FPCLINE>              lwa_tax_konv-kdatu = lwa_konv-kdatu. &quot; Name for value-added tax</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF li_zzvatnsf IS NOT INITIAL</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>        lwa_tax_konv-kbetr = lwa_konv-kbetr / 10.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>        lwa_tax_konv-kawrt = lwa_konv-kawrt.</FPCLINE>
      <FPCLINE>        lwa_tax_konv-kwert = lwa_konv-kwert.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>        READ TABLE li_tstxt INTO lwa_tstxt WITH KEY mwskz = lwa_konv-mwsk1 BINARY SEARCH.</FPCLINE>
      <FPCLINE>        IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>          lwa_tax_konv-text1 = lwa_tstxt-text1.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>        CLEAR lwa_tstxt.</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>        APPEND lwa_tax_konv TO li_tax_konv.</FPCLINE>
      <FPCLINE>        CLEAR lwa_tax_konv.</FPCLINE>
      <FPCLINE>      ENDLOOP. &quot; LOOP AT fp_i_konv INTO lwa_konv WHERE kinak EQ abap_false AND</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Sort by Tax Rate</FPCLINE>
      <FPCLINE>  SORT li_tax_konv BY kbetr.</FPCLINE>
      <FPCLINE>  LOOP AT li_tax_konv INTO lwa_tax_konv.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Tax base Amount &amp; Tax Amt</FPCLINE>
      <FPCLINE>    lv_kawrt = lv_kawrt + lwa_tax_konv-kawrt.</FPCLINE>
      <FPCLINE>    lv_kwert = lv_kwert + lwa_tax_konv-kwert.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  Tax Rate</FPCLINE>
      <FPCLINE>    AT END OF kbetr.</FPCLINE>
      <FPCLINE>      WRITE lwa_tax_konv-kbetr TO lwa_vat_summary-kbetr CURRENCY lc_percentage.</FPCLINE>
      <FPCLINE>      CONDENSE lwa_vat_summary-kbetr NO-GAPS.</FPCLINE>
      <FPCLINE>      CONCATENATE lwa_vat_summary-kbetr lc_percentage</FPCLINE>
      <FPCLINE>             INTO lwa_vat_summary-kbetr</FPCLINE>
      <FPCLINE>             SEPARATED BY space.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*      WRITE lv_kawrt TO lwa_vat_summary-kawrt.</FPCLINE>
      <FPCLINE>*      WRITE lv_kwert TO lwa_vat_summary-kwert.</FPCLINE>
      <FPCLINE>* &lt;--- End of Delete for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>      WRITE lv_kawrt TO lwa_vat_summary-kawrt CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>      WRITE lv_kwert TO lwa_vat_summary-kwert CURRENCY gv_bill_doc_currency.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect# 2720 by SMUKHER4 on 04.05.2017</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Populating VAT Summary text</FPCLINE>
      <FPCLINE>      lwa_vat_summary-text1 = lwa_tax_konv-text1.</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for Incident#INC0432585 (D3hc.13 Changes) by DDWIVEDI</FPCLINE>
      <FPCLINE>*      WRITE lwa_tax_konv-kdatu TO lwa_vat_summary-kdatu .</FPCLINE>
      <FPCLINE>* ---&gt; End of delete for Incident#INC0432585 (D3hc.13 Changes) by DDWIVEDI</FPCLINE>
      <FPCLINE>* ---&gt; Begin of insert for Incident#INC0432585 (D3hc.13 Changes) by DDWIVEDI</FPCLINE>
      <FPCLINE>      MOVE lwa_tax_konv-kdatu  TO lwa_vat_summary-kdatu .</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for Incident#INC0432585 (D3hc.13 Changes) by DDWIVEDI</FPCLINE>
      <FPCLINE>      APPEND lwa_vat_summary TO i_vat_summary.</FPCLINE>
      <FPCLINE>      CLEAR: lwa_vat_summary, lv_kawrt, lv_kwert.</FPCLINE>
      <FPCLINE>    ENDAT.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ENDLOOP. &quot; LOOP AT li_tax_konv INTO lwa_tax_konv</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_vat_summary</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_payment_terms</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get Payment Terms</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_ZTERM         Terms of Payment Key</FPCLINE>
      <FPCLINE>*      --&gt;FP_FKDAT         Billing date</FPCLINE>
      <FPCLINE>*      --&gt;FP_ZTERM_TX1     Payment Term Text 1</FPCLINE>
      <FPCLINE>*      --&gt;FP_ZTERM_TX2     Payment Term Text 2</FPCLINE>
      <FPCLINE>*      --&gt;FP_ZTERM_TX3     Payment Term Text 3</FPCLINE>
      <FPCLINE>*      --&gt;FP_VBTYP         SD document category</FPCLINE>
      <FPCLINE>*      --&gt;FP_VKORG         Sales Organization</FPCLINE>
      <FPCLINE>*      --&gt;FP_EMI_CONSTANTS EMI Entries</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_payment_terms USING fp_zterm     TYPE dzterm &quot; Terms of Payment Key</FPCLINE>
      <FPCLINE>                           fp_fkdat     TYPE fkdat  &quot; Billing date for billing index and printout</FPCLINE>
      <FPCLINE>                           fp_zterm_tx1	TYPE text80</FPCLINE>
      <FPCLINE>                           fp_zterm_tx2	TYPE text80</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>                           fp_zterm_tx3	TYPE text80</FPCLINE>
      <FPCLINE>                           fp_vbtyp     TYPE vbtyp &quot; SD document category</FPCLINE>
      <FPCLINE>                           fp_vkorg     TYPE vkorg &quot; Sales Organization</FPCLINE>
      <FPCLINE>                           fp_emi_constants TYPE ty_t_emi_constants.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_tdobject TYPE tdobject VALUE &apos;TEXT&apos;, &quot; Texts: Application Object</FPCLINE>
      <FPCLINE>    lc_tdid     TYPE tdid     VALUE &apos;ST&apos;,   &quot; Text ID</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>    lc_vbtyp_credit TYPE z_criteria VALUE &apos;ZVBTYP_CREDIT_MEMO&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>    lc_vkorg_diamed TYPE z_criteria VALUE &apos;ZVKORG_DIAMED_CH&apos;,   &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>    lc_std_text TYPE tdobname VALUE &apos;ZOTC_0014_REFER_TO_SCHED_OF_PAY&apos;, &quot; Name</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>    lc_vkorg_it      TYPE vkorg      VALUE &apos;2037&apos;, &quot; Sales Organization</FPCLINE>
      <FPCLINE>    lc_spras         TYPE spras      VALUE &apos;I&apos;,    &quot; Language key - Italy</FPCLINE>
      <FPCLINE>    lc_hipen         TYPE char1      VALUE &apos;-&apos;.    &quot; Hipen</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_zterm TYPE dzterm,     &quot; Terms of Payment Key</FPCLINE>
      <FPCLINE>    lv_vtext TYPE dzterm_bez, &quot; Description of terms of payment</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>    lv_text1 TYPE text1_052. &quot; Own Explanation of Term of Payment</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_line     TYPE tline, &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>    lwa_top_text  TYPE vtopis. &quot; Information Structure for Installment Payment Terms</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_lines    TYPE STANDARD TABLE OF tline, &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>    li_top_text TYPE STANDARD TABLE OF vtopis. &quot; Information Structure for Installment Payment Terms</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  READ TABLE fp_emi_constants TRANSPORTING NO FIELDS WITH KEY criteria = lc_vbtyp_credit</FPCLINE>
      <FPCLINE>                                                              sel_low = fp_vbtyp</FPCLINE>
      <FPCLINE>                                                              active = abap_true.</FPCLINE>
      <FPCLINE>*       Small table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>  IF sy-subrc &lt;&gt; 0.</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>    SELECT zterm &quot; Terms of Payment Key</FPCLINE>
      <FPCLINE>      FROM t052  &quot; Terms of Payment</FPCLINE>
      <FPCLINE>      INTO lv_zterm</FPCLINE>
      <FPCLINE>      UP TO 1 ROWS</FPCLINE>
      <FPCLINE>      WHERE zterm = fp_zterm</FPCLINE>
      <FPCLINE>        AND xsplt = abap_true.</FPCLINE>
      <FPCLINE>    ENDSELECT.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>      SELECT SINGLE vtext &quot; Description of terms of payment</FPCLINE>
      <FPCLINE>        FROM tvzbt        &quot; Customers: Terms of Payment Texts</FPCLINE>
      <FPCLINE>        INTO lv_vtext</FPCLINE>
      <FPCLINE>        WHERE spras EQ gv_form_lang</FPCLINE>
      <FPCLINE>        AND   zterm EQ lv_zterm.</FPCLINE>
      <FPCLINE>      IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>*    Payment Term - Line 1</FPCLINE>
      <FPCLINE>        gv_payment_term_1 = lv_vtext.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*    Payment Term - Line 2</FPCLINE>
      <FPCLINE>*    Retrieve Std texts</FPCLINE>
      <FPCLINE>        CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>          EXPORTING</FPCLINE>
      <FPCLINE>            id                      = lc_tdid</FPCLINE>
      <FPCLINE>            language                = gv_form_lang</FPCLINE>
      <FPCLINE>            name                    = lc_std_text</FPCLINE>
      <FPCLINE>            object                  = lc_tdobject</FPCLINE>
      <FPCLINE>          TABLES</FPCLINE>
      <FPCLINE>            lines                   = li_lines</FPCLINE>
      <FPCLINE>          EXCEPTIONS</FPCLINE>
      <FPCLINE>            id                      = 1</FPCLINE>
      <FPCLINE>            language                = 1</FPCLINE>
      <FPCLINE>            name                    = 1</FPCLINE>
      <FPCLINE>            not_found               = 1</FPCLINE>
      <FPCLINE>            object                  = 1</FPCLINE>
      <FPCLINE>            reference_check         = 1</FPCLINE>
      <FPCLINE>            wrong_access_to_archive = 1</FPCLINE>
      <FPCLINE>            OTHERS                  = 1.</FPCLINE>
      <FPCLINE>        IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>          READ TABLE li_lines INTO lwa_line INDEX 1.</FPCLINE>
      <FPCLINE>          IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>            gv_payment_term_2 = lwa_line-tdline.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>*    gv_payment_term_1 = fp_zterm_tx1.</FPCLINE>
      <FPCLINE>*    gv_payment_term_2 = fp_zterm_tx2.</FPCLINE>
      <FPCLINE>* &lt;--- End of Delete for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>      CALL FUNCTION &apos;SD_PRINT_TERMS_OF_PAYMENT&apos;</FPCLINE>
      <FPCLINE>        EXPORTING</FPCLINE>
      <FPCLINE>          bldat                        = fp_fkdat</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>* Added below parameter bcoz calculation for payment term &apos;0001&apos; was not happening correctly</FPCLINE>
      <FPCLINE>          budat                        = fp_fkdat</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>          language                     = gv_form_lang</FPCLINE>
      <FPCLINE>          terms_of_payment             = fp_zterm</FPCLINE>
      <FPCLINE>        TABLES</FPCLINE>
      <FPCLINE>          top_text                     = li_top_text</FPCLINE>
      <FPCLINE>        EXCEPTIONS</FPCLINE>
      <FPCLINE>          terms_of_payment_not_in_t052 = 1</FPCLINE>
      <FPCLINE>          OTHERS                       = 2.</FPCLINE>
      <FPCLINE>*&amp;-- No sy-subrc check is required.</FPCLINE>
      <FPCLINE>      IF li_top_text  IS NOT INITIAL.</FPCLINE>
      <FPCLINE>*  &amp;--Get the Payment Terms Line 1</FPCLINE>
      <FPCLINE>        READ TABLE fp_emi_constants TRANSPORTING NO FIELDS WITH KEY criteria = lc_vkorg_diamed</FPCLINE>
      <FPCLINE>                                                                    sel_low = fp_vkorg</FPCLINE>
      <FPCLINE>                                                                    active = abap_true.</FPCLINE>
      <FPCLINE>*       Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>        IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>*    Field 64.1 = Print Label 59 in the language of the output + &apos; &apos; + HDATUM of the First line of TOP_TEXT</FPCLINE>
      <FPCLINE>          READ TABLE li_top_text  INTO lwa_top_text INDEX 1.</FPCLINE>
      <FPCLINE>          IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>            PERFORM f_format_date USING lwa_top_text-hdatum</FPCLINE>
      <FPCLINE>                             CHANGING gv_hdatum.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>        ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>          READ TABLE li_top_text  INTO lwa_top_text INDEX 1.</FPCLINE>
      <FPCLINE>          IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>            gv_payment_term_1 = lwa_top_text-line.</FPCLINE>
      <FPCLINE>*--&gt; Begin of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>* Populate Payment term text for payment term &amp; Language key</FPCLINE>
      <FPCLINE>            IF fp_vkorg EQ lc_vkorg_it.</FPCLINE>
      <FPCLINE>              SELECT text1 &quot; Own Explanation of Term of Payment</FPCLINE>
      <FPCLINE>                FROM t052u &quot; Own Explanations for Terms of Payment</FPCLINE>
      <FPCLINE>                INTO lv_text1</FPCLINE>
      <FPCLINE>                UP TO 1 ROWS</FPCLINE>
      <FPCLINE>                WHERE zterm = fp_zterm</FPCLINE>
      <FPCLINE>                  AND spras = lc_spras.</FPCLINE>
      <FPCLINE>              ENDSELECT.</FPCLINE>
      <FPCLINE>              IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>                CONCATENATE gv_payment_term_1 lc_hipen lv_text1 INTO gv_payment_term_1 SEPARATED BY space.</FPCLINE>
      <FPCLINE>              ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF fp_vkorg EQ lc_vkorg_it</FPCLINE>
      <FPCLINE>*&lt;-- End of change for D3_OTC_FDD_0014_Defect# 5683 by U100018 on 17-APR-2018</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  &amp;--Get the Payment Terms Line 2</FPCLINE>
      <FPCLINE>        READ TABLE li_top_text  INTO lwa_top_text INDEX 2.</FPCLINE>
      <FPCLINE>        IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>          gv_payment_term_2 = lwa_top_text-line.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*  &amp;--Get the Payment Terms Line 3</FPCLINE>
      <FPCLINE>        READ TABLE li_top_text  INTO lwa_top_text INDEX 3.</FPCLINE>
      <FPCLINE>        IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>          gv_payment_term_3 = lwa_top_text-line.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF li_top_text IS NOT INITIAL</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc &lt;&gt; 0</FPCLINE>
      <FPCLINE>    CLEAR gv_payment_term_1.</FPCLINE>
      <FPCLINE>    CLEAR gv_payment_term_2.</FPCLINE>
      <FPCLINE>    CLEAR gv_payment_term_3.</FPCLINE>
      <FPCLINE>    CLEAR gv_hdatum.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc &lt;&gt; 0</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect7129(CR301) by NALI</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_payment_terms</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_payment_mode</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Payment Mode</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_ZLSCH                 Payment Method</FPCLINE>
      <FPCLINE>*      --&gt;FP_COMP_LAND1            Country Key</FPCLINE>
      <FPCLINE>*      --&gt;FP_BUKRS                 Company Code</FPCLINE>
      <FPCLINE>*      --&gt;fp_i_emi_constants        EMI Entries</FPCLINE>
      <FPCLINE>*      --&gt;FP_I_VBPA                Parnter Info</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_payment_mode USING fp_zlsch          TYPE schzw_bseg &quot; Payment Method</FPCLINE>
      <FPCLINE>                              fp_comp_land1     TYPE land1      &quot; Country Key</FPCLINE>
      <FPCLINE>                              fp_bukrs          TYPE bukrs      &quot; Company Code</FPCLINE>
      <FPCLINE>                              fp_i_emi_constants TYPE ty_t_emi_constants</FPCLINE>
      <FPCLINE>                              fp_i_vbpa         TYPE ty_t_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_posnr_0         TYPE posnr      VALUE &apos;000000&apos;, &quot; Item number of the SD document</FPCLINE>
      <FPCLINE>    lc_parvw_payer     TYPE parvw      VALUE &apos;RG&apos;,     &quot; Payer Partner Function</FPCLINE>
      <FPCLINE>    lc_criteria_ddebit TYPE z_criteria VALUE &apos;DDEBIT&apos;. &quot; Enh. Criteria</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_zlsch TYPE schzw_bseg, &quot; Payment Method</FPCLINE>
      <FPCLINE>    lv_zwels TYPE dzwels.     &quot; List of the Payment Methods to be Considered</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lwa_vbpa          TYPE ty_vbpa,</FPCLINE>
      <FPCLINE>    lwa_emi_constants TYPE zdev_enh_status. &quot; Enhancement Status</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    li_vbpa TYPE ty_t_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_vbpa[] = fp_i_vbpa[].</FPCLINE>
      <FPCLINE>  SORT li_vbpa BY vbeln posnr parvw.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF fp_zlsch IS INITIAL.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    READ TABLE li_vbpa INTO lwa_vbpa</FPCLINE>
      <FPCLINE>                       WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>                                posnr = lc_posnr_0</FPCLINE>
      <FPCLINE>                                parvw = lc_parvw_payer</FPCLINE>
      <FPCLINE>                       BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>      SELECT SINGLE zwels &quot; List of the Payment Methods to be Considered</FPCLINE>
      <FPCLINE>        FROM knb1         &quot; Customer Master (Company Code)</FPCLINE>
      <FPCLINE>        INTO lv_zwels</FPCLINE>
      <FPCLINE>        WHERE kunnr = lwa_vbpa-kunnr</FPCLINE>
      <FPCLINE>          AND bukrs = fp_bukrs.</FPCLINE>
      <FPCLINE>      IF sy-subrc = 0.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>        READ TABLE fp_i_emi_constants INTO lwa_emi_constants</FPCLINE>
      <FPCLINE>                                      WITH KEY criteria = lc_criteria_ddebit.</FPCLINE>
      <FPCLINE>*       Small table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>        IF sy-subrc = 0.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          lv_zlsch = lwa_emi_constants-sel_low.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>          IF  lv_zlsch CA lv_zwels</FPCLINE>
      <FPCLINE>            AND lv_zlsch IS NOT INITIAL.</FPCLINE>
      <FPCLINE>          ELSE. &quot; ELSE -&gt; IF lv_zlsch CA lv_zwels</FPCLINE>
      <FPCLINE>            CLEAR lv_zlsch.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF lv_zlsch CA lv_zwels</FPCLINE>
      <FPCLINE/>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF fp_zlsch IS INITIAL</FPCLINE>
      <FPCLINE>    lv_zlsch = fp_zlsch.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF fp_zlsch IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF NOT lv_zlsch IS INITIAL.</FPCLINE>
      <FPCLINE>    SELECT SINGLE text2 &quot; Description of Payment Method in Logon Language</FPCLINE>
      <FPCLINE>      FROM t042zt       &quot; Texts of Payment Methods for Automatic Payment</FPCLINE>
      <FPCLINE>      INTO gv_payment_mode</FPCLINE>
      <FPCLINE>      WHERE spras EQ gv_form_lang</FPCLINE>
      <FPCLINE>      AND   land1 EQ fp_comp_land1</FPCLINE>
      <FPCLINE>      AND   zlsch EQ lv_zlsch.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF NOT lv_zlsch IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_payment_mode</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_general_payment_std_text</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       General Payment Text</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_BUKRS   Company Code</FPCLINE>
      <FPCLINE>*      --&gt;FP_RPLNR   Number of payment card plan type</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_general_payment_std_text USING fp_bukrs TYPE bukrs  &quot; Company Code</FPCLINE>
      <FPCLINE>                                          fp_rplnr TYPE rplnr. &quot; Number of payment card plan type</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_std_text_cc      TYPE tdobname VALUE &apos;ZOTC_0014_D3_PAYMENT_CC&apos;,   &quot; Name</FPCLINE>
      <FPCLINE>    lc_std_text_payment TYPE tdobname VALUE &apos;ZOTC_0014_D3_PAYMENT_XXXX&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    lc_unknown_bukrs    TYPE char4    VALUE &apos;XXXX&apos;,                      &quot; Unknown_bukrs of type CHAR4</FPCLINE>
      <FPCLINE>    lc_spras_e          TYPE spras    VALUE &apos;EN&apos;.                        &quot; Language Key</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA:</FPCLINE>
      <FPCLINE>    lv_std_text TYPE tdobname. &quot; Name</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF fp_rplnr IS INITIAL.</FPCLINE>
      <FPCLINE>    lv_std_text = lc_std_text_payment.</FPCLINE>
      <FPCLINE>    REPLACE lc_unknown_bukrs WITH fp_bukrs INTO lv_std_text.</FPCLINE>
      <FPCLINE>    wa_general_pay_text-spras    = lc_spras_e.</FPCLINE>
      <FPCLINE>    wa_general_pay_text-std_text = lv_std_text.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF fp_rplnr IS INITIAL</FPCLINE>
      <FPCLINE>    wa_general_pay_text-spras    = gv_form_lang.</FPCLINE>
      <FPCLINE>    wa_general_pay_text-std_text = lc_std_text_cc.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF fp_rplnr IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_general_payment_std_text</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_ltext_sales</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Footer Legal Text (Sales Org. Informations)</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_BUKRS   Company Code</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_ltext_sales USING fp_bukrs TYPE bukrs. &quot; Company Code</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_ltext_sales   TYPE tdobname VALUE &apos;ZOTC_0014_D3_LTEXT_SALES_XXXX&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    lc_unknown_bukrs TYPE string   VALUE &apos;XXXX&apos;.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  gv_ltext_sales_std_txt = lc_ltext_sales.</FPCLINE>
      <FPCLINE>  REPLACE lc_unknown_bukrs WITH fp_bukrs INTO gv_ltext_sales_std_txt.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_ltext_sales</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_tcsales</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Footer Legal Text (Terms and Conditions)</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_BUKRS   Company Code</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_tcsales USING fp_bukrs TYPE bukrs. &quot; Company Code</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS:</FPCLINE>
      <FPCLINE>    lc_tcsales       TYPE tdobname VALUE &apos;ZOTC_0014_D3_TCSALES_XXXX&apos;, &quot; Name</FPCLINE>
      <FPCLINE>    lc_unknown_bukrs TYPE string   VALUE &apos;XXXX&apos;.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  gv_tcsales_std_txt = lc_tcsales.</FPCLINE>
      <FPCLINE>  REPLACE lc_unknown_bukrs WITH fp_bukrs INTO gv_tcsales_std_txt.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_tcsales</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_format_date</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Format Date based on Form Language</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_DATE_IN   Input Date</FPCLINE>
      <FPCLINE>*      --&gt;FP_DATE_OUT  Output Date</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_format_date USING fp_date_in        TYPE sydatum &quot; Date in System Format</FPCLINE>
      <FPCLINE>                CHANGING fp_date_out       TYPE char15. &quot; Output Date in Required Format</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CALL FUNCTION &apos;ZDEV_DATE_FORMAT&apos;</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      i_date       = fp_date_in</FPCLINE>
      <FPCLINE>      i_format     = gv_date_format</FPCLINE>
      <FPCLINE>      i_langu      = gv_form_lang</FPCLINE>
      <FPCLINE>    IMPORTING</FPCLINE>
      <FPCLINE>      e_date_final = fp_date_out.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_format_date</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_vbrk</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Billing Document Header Data</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_IM_BIL_PRT_COM_HEADER_VBELN  Billing Document</FPCLINE>
      <FPCLINE>*      &lt;--FP_I_VBRK                       Billing Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_vbrk USING fp_im_bil_prt_com_header_vbeln TYPE vbeln &quot; Sales and Distribution Document Number</FPCLINE>
      <FPCLINE>                CHANGING fp_i_vbrk TYPE ty_t_vbrk.</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>  SELECT vbeln &quot; Billing Document</FPCLINE>
      <FPCLINE>         fkart &quot; Billing Type</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>         knumv</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6010(D3R3.08 Changes) by u033876</FPCLINE>
      <FPCLINE>         zzrland &quot; Tax Reporting Country</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>         zzvatnsf &quot;VAT Registration Number</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for Incident#INC0432585 (D3hc.13 Changes) by u033632</FPCLINE>
      <FPCLINE>** Begin of SCTASK0793196 R.1</FPCLINE>
      <FPCLINE>         vkorg</FPCLINE>
      <FPCLINE>** End of SCTASK0793196 R.1</FPCLINE>
      <FPCLINE>    FROM vbrk &quot; Billing Document: Header Data</FPCLINE>
      <FPCLINE>    INTO TABLE fp_i_vbrk</FPCLINE>
      <FPCLINE>    WHERE vbeln = fp_im_bil_prt_com_header_vbeln.</FPCLINE>
      <FPCLINE>  IF sy-subrc IS INITIAL.</FPCLINE>
      <FPCLINE>    SORT fp_i_vbrk BY vbeln fkart.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc IS INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_vbrk</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for Defect#6829(CR):D3_OTC_FDD_0014 by SGHOSH</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_fiscal_rep</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       EHQ/USPA Fiscal representative in the Tax reporting Country</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;FP_VBELN          Billing Document                           *</FPCLINE>
      <FPCLINE>*      --&gt;FP_VKORG          Sales Organization                         *</FPCLINE>
      <FPCLINE>*      --&gt;FP_ZZRLAND        Tax Reporting Country                      *</FPCLINE>
      <FPCLINE>*      --&gt;FP_EMI_CONSTANTS  Emi                                        *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_fiscal_rep  USING fp_vbeln TYPE vbeln   &quot; Sales and Distribution Document Number</FPCLINE>
      <FPCLINE>                             fp_vkorg TYPE vkorg   &quot; Sales Organization</FPCLINE>
      <FPCLINE>                             fp_zzrland TYPE land1 &quot; Country Key</FPCLINE>
      <FPCLINE>                             fp_emi_constants  TYPE ty_t_emi_constants.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS: lc_vkorg_ehq_uspa  TYPE z_criteria VALUE &apos;ZVKORG_EHQ_USPA&apos;,   &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>             lc_zzrland         TYPE z_criteria VALUE &apos;ZZRLAND&apos;,           &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>             lc_frep_st         TYPE char70     VALUE &apos;ZOTC_0014_D3_FREP&apos;, &quot; Frep_st of type CHAR70</FPCLINE>
      <FPCLINE>             lc_undscr          TYPE char01     VALUE &apos;_&apos;.                 &quot; Undscr of type CHAR01</FPCLINE>
      <FPCLINE/>
      <FPCLINE/>
      <FPCLINE>  IF fp_zzrland IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    READ TABLE fp_emi_constants TRANSPORTING NO FIELDS WITH KEY criteria = lc_vkorg_ehq_uspa</FPCLINE>
      <FPCLINE>                                                                       sel_low = fp_vkorg</FPCLINE>
      <FPCLINE>                                                                       active = abap_true.</FPCLINE>
      <FPCLINE>*     Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      READ TABLE fp_emi_constants TRANSPORTING NO FIELDS WITH KEY criteria = lc_zzrland</FPCLINE>
      <FPCLINE>                                                                         sel_low = fp_zzrland</FPCLINE>
      <FPCLINE>                                                                         active = abap_true.</FPCLINE>
      <FPCLINE>      IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>        CONCATENATE lc_frep_st</FPCLINE>
      <FPCLINE>                    fp_vkorg</FPCLINE>
      <FPCLINE>                    fp_zzrland</FPCLINE>
      <FPCLINE>                    INTO gv_frep_text</FPCLINE>
      <FPCLINE>                    SEPARATED BY lc_undscr.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF fp_zzrland IS NOT INITIAL</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot;f_get_fiscal_rep</FPCLINE>
      <FPCLINE>* &lt;--- End of Insert for D3_OTC_FDD_0014_Defect#7129(CR#301) by NALI</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*Begin of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_read_text_del_info</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Read label text for delivery info</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;fp_text_name          Text Name                              *</FPCLINE>
      <FPCLINE>*      --&gt;fp_langu              Language                               *</FPCLINE>
      <FPCLINE>*      &lt;--fp_text               Text Line                              *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_read_text_del_info  USING fp_text_name TYPE tdobname &quot; Text Name</FPCLINE>
      <FPCLINE>                                 fp_langu     TYPE spras    &quot; Language</FPCLINE>
      <FPCLINE>                        CHANGING fp_text      TYPE tdline . &quot; Text Line</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS: lc_id    TYPE tdid     VALUE &apos;ST&apos;,   &quot; Text ID</FPCLINE>
      <FPCLINE>             lc_text  TYPE tdobject VALUE &apos;TEXT&apos;. &quot; Texts: Application Object</FPCLINE>
      <FPCLINE>  DATA:      li_lines TYPE STANDARD TABLE OF  tline . &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  FIELD-SYMBOLS: &lt;lfs_lines&gt; TYPE tline. &quot; SAPscript: Text Lines</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CALL FUNCTION &apos;READ_TEXT&apos;</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      id                      = lc_id</FPCLINE>
      <FPCLINE>      language                = fp_langu</FPCLINE>
      <FPCLINE>      name                    = fp_text_name</FPCLINE>
      <FPCLINE>      object                  = lc_text</FPCLINE>
      <FPCLINE>    TABLES</FPCLINE>
      <FPCLINE>      lines                   = li_lines</FPCLINE>
      <FPCLINE>    EXCEPTIONS</FPCLINE>
      <FPCLINE>      id                      = 1</FPCLINE>
      <FPCLINE>      language                = 2</FPCLINE>
      <FPCLINE>      name                    = 3</FPCLINE>
      <FPCLINE>      not_found               = 4</FPCLINE>
      <FPCLINE>      object                  = 5</FPCLINE>
      <FPCLINE>      reference_check         = 6</FPCLINE>
      <FPCLINE>      wrong_access_to_archive = 7</FPCLINE>
      <FPCLINE>      OTHERS                  = 8.</FPCLINE>
      <FPCLINE>  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>    READ TABLE li_lines ASSIGNING &lt;lfs_lines&gt; INDEX 1.</FPCLINE>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      fp_text = &lt;lfs_lines&gt;-tdline.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  FREE : li_lines.</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_fiscal_rep</FPCLINE>
      <FPCLINE>*End of change for Defect 2619 by U033867</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_brvat</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get Bio-Rad VAT Number for Invoice footer</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt; fp_bukrs              Company Code                          *</FPCLINE>
      <FPCLINE>*      --&gt; fp_i_emi_constants    EMI Entries                           *</FPCLINE>
      <FPCLINE>*      --&gt; fp_zvatnsf            VAT Registration No                   *</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_brvat USING fp_bukrs           TYPE bukrs  &quot; Company Code</FPCLINE>
      <FPCLINE>                       fp_i_emi_constants TYPE ty_t_emi_constants</FPCLINE>
      <FPCLINE>                       fp_zvatnsf         TYPE stceg. &quot; VAT Registration Number</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS: lc_bukrs_ch TYPE z_criteria VALUE &apos;BUKRS_CH&apos;, &quot; Enh. Criteria</FPCLINE>
      <FPCLINE>             lc_suffix   TYPE char5      VALUE &apos;MWST&apos;,     &quot; Suffix MWST</FPCLINE>
      <FPCLINE>             lc_ch       TYPE char2      VALUE &apos;CH&apos;.       &quot; Ch of type CHAR2</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>                       WITH KEY criteria = lc_bukrs_ch</FPCLINE>
      <FPCLINE>                                sel_low  = fp_bukrs.</FPCLINE>
      <FPCLINE>* Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>    SHIFT fp_zvatnsf LEFT DELETING LEADING space.</FPCLINE>
      <FPCLINE>    IF fp_zvatnsf+0(2) = lc_ch.</FPCLINE>
      <FPCLINE>      CONCATENATE fp_zvatnsf lc_suffix INTO gv_zvatnsf SEPARATED BY space.</FPCLINE>
      <FPCLINE>    ELSE. &quot; ELSE -&gt; IF fp_zvatnsf+0(2) = lc_ch</FPCLINE>
      <FPCLINE>      gv_zvatnsf = fp_zvatnsf.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF fp_zvatnsf+0(2) = lc_ch</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>    gv_zvatnsf = fp_zvatnsf.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_brvat</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_gln</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get GLN for Bill-to, Sold-to and Ship-to partners</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;fp_i_vbpa                  Partner Data</FPCLINE>
      <FPCLINE>*      &lt;--fp_x_invoice_header        Invoice Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_gln USING fp_i_vbpa TYPE ty_t_vbpa</FPCLINE>
      <FPCLINE>            CHANGING fp_x_invoice_header TYPE ty_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA: li_vbpa_tmp TYPE ty_t_vbpa,</FPCLINE>
      <FPCLINE>        li_kna1     TYPE ty_t_kna1.</FPCLINE>
      <FPCLINE>  FIELD-SYMBOLS: &lt;lfs_kna1&gt; TYPE ty_kna1.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  li_vbpa_tmp[] = fp_i_vbpa.</FPCLINE>
      <FPCLINE>  SORT li_vbpa_tmp BY kunnr.</FPCLINE>
      <FPCLINE>  DELETE ADJACENT DUPLICATES FROM li_vbpa_tmp COMPARING kunnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF NOT li_vbpa_tmp[] IS INITIAL.</FPCLINE>
      <FPCLINE>    SELECT kunnr bbbnr bbsnr</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>      bubkz &quot;check digit</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>      INTO TABLE li_kna1</FPCLINE>
      <FPCLINE>      FROM kna1 &quot; General Data in Customer Master</FPCLINE>
      <FPCLINE>       FOR ALL ENTRIES IN li_vbpa_tmp</FPCLINE>
      <FPCLINE>     WHERE kunnr = li_vbpa_tmp-kunnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      SORT li_kna1 BY kunnr.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* Bill-to GLN</FPCLINE>
      <FPCLINE>      READ TABLE li_kna1 ASSIGNING &lt;lfs_kna1&gt;</FPCLINE>
      <FPCLINE>        WITH KEY kunnr = fp_x_invoice_header-bill_to_kunnr</FPCLINE>
      <FPCLINE>        BINARY SEARCH.</FPCLINE>
      <FPCLINE>      IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>        IF NOT &lt;lfs_kna1&gt;-bbbnr IS INITIAL.</FPCLINE>
      <FPCLINE>          fp_x_invoice_header-bill_to_gln = &lt;lfs_kna1&gt;-bbbnr.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF NOT &lt;lfs_kna1&gt;-bbbnr IS INITIAL</FPCLINE>
      <FPCLINE>        IF NOT &lt;lfs_kna1&gt;-bbsnr IS INITIAL.</FPCLINE>
      <FPCLINE>          IF fp_x_invoice_header-bill_to_gln IS INITIAL.</FPCLINE>
      <FPCLINE>            fp_x_invoice_header-bill_to_gln = &lt;lfs_kna1&gt;-bbsnr.</FPCLINE>
      <FPCLINE>          ELSE. &quot; ELSE -&gt; IF fp_x_invoice_header-bill_to_gln IS INITIAL</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>*Below statement is commented as new value check point is concatenated in new statement</FPCLINE>
      <FPCLINE>*            CONCATENATE &lt;lfs_kna1&gt;-bbbnr &lt;lfs_kna1&gt;-bbsnr INTO fp_x_invoice_header-bill_to_gln.</FPCLINE>
      <FPCLINE>* ---&gt; End of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>            CONCATENATE &lt;lfs_kna1&gt;-bbbnr &lt;lfs_kna1&gt;-bbsnr &lt;lfs_kna1&gt;-bubkz INTO fp_x_invoice_header-bill_to_gln.</FPCLINE>
      <FPCLINE>* ---&gt; End of Insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF fp_x_invoice_header-bill_to_gln IS INITIAL</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF NOT &lt;lfs_kna1&gt;-bbsnr IS INITIAL</FPCLINE>
      <FPCLINE>        UNASSIGN &lt;lfs_kna1&gt;.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Delete for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>* Sold-To GLN is no longer required</FPCLINE>
      <FPCLINE>** Sold-to GLN</FPCLINE>
      <FPCLINE>*      READ TABLE li_kna1 ASSIGNING &lt;lfs_kna1&gt;</FPCLINE>
      <FPCLINE>*        WITH KEY kunnr = fp_x_invoice_header-sold_to_kunnr</FPCLINE>
      <FPCLINE>*        BINARY SEARCH.</FPCLINE>
      <FPCLINE>*      IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>*        IF NOT &lt;lfs_kna1&gt;-bbbnr IS INITIAL.</FPCLINE>
      <FPCLINE>*          fp_x_invoice_header-sold_to_gln = &lt;lfs_kna1&gt;-bbbnr.</FPCLINE>
      <FPCLINE>*        ENDIF. &quot; IF NOT &lt;lfs_kna1&gt;-bbbnr IS INITIAL</FPCLINE>
      <FPCLINE>*        IF NOT &lt;lfs_kna1&gt;-bbsnr IS INITIAL.</FPCLINE>
      <FPCLINE>*          IF fp_x_invoice_header-sold_to_gln IS INITIAL.</FPCLINE>
      <FPCLINE>*            fp_x_invoice_header-sold_to_gln = &lt;lfs_kna1&gt;-bbsnr.</FPCLINE>
      <FPCLINE>*          ELSE. &quot; ELSE -&gt; IF fp_x_invoice_header-sold_to_gln IS INITIAL</FPCLINE>
      <FPCLINE>*            CONCATENATE &lt;lfs_kna1&gt;-bbbnr &lt;lfs_kna1&gt;-bbsnr INTO fp_x_invoice_header-sold_to_gln.</FPCLINE>
      <FPCLINE>*          ENDIF. &quot; IF fp_x_invoice_header-sold_to_gln IS INITIAL</FPCLINE>
      <FPCLINE>*        ENDIF. &quot; IF NOT &lt;lfs_kna1&gt;-bbsnr IS INITIAL</FPCLINE>
      <FPCLINE>*        UNASSIGN &lt;lfs_kna1&gt;.</FPCLINE>
      <FPCLINE>*      ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* &lt;--- End   of Delete for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>* Print Ship-to GLN only if is it different than Bill-To Gln</FPCLINE>
      <FPCLINE>      IF fp_x_invoice_header-ship_to_kunnr &lt;&gt; fp_x_invoice_header-bill_to_kunnr.</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>* Ship-to GLN</FPCLINE>
      <FPCLINE>        READ TABLE li_kna1 ASSIGNING &lt;lfs_kna1&gt;</FPCLINE>
      <FPCLINE>          WITH KEY kunnr = fp_x_invoice_header-ship_to_kunnr</FPCLINE>
      <FPCLINE>          BINARY SEARCH.</FPCLINE>
      <FPCLINE>        IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>          IF NOT &lt;lfs_kna1&gt;-bbbnr IS INITIAL.</FPCLINE>
      <FPCLINE>            fp_x_invoice_header-ship_to_gln = &lt;lfs_kna1&gt;-bbbnr.</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF NOT &lt;lfs_kna1&gt;-bbbnr IS INITIAL</FPCLINE>
      <FPCLINE>          IF NOT &lt;lfs_kna1&gt;-bbsnr IS INITIAL.</FPCLINE>
      <FPCLINE>            IF fp_x_invoice_header-ship_to_gln IS INITIAL.</FPCLINE>
      <FPCLINE>              fp_x_invoice_header-ship_to_gln = &lt;lfs_kna1&gt;-bbsnr.</FPCLINE>
      <FPCLINE>            ELSE. &quot; ELSE -&gt; IF fp_x_invoice_header-ship_to_gln IS INITIAL</FPCLINE>
      <FPCLINE>* ---&gt; Begin of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>*Below statement is commented as new value check point is concatenated in new statement</FPCLINE>
      <FPCLINE>*              CONCATENATE &lt;lfs_kna1&gt;-bbbnr &lt;lfs_kna1&gt;-bbsnr INTO fp_x_invoice_header-ship_to_gln.</FPCLINE>
      <FPCLINE>* ---&gt; End of delete for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>* ---&gt; Begin of insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>              CONCATENATE &lt;lfs_kna1&gt;-bbbnr &lt;lfs_kna1&gt;-bbsnr &lt;lfs_kna1&gt;-bubkz INTO fp_x_invoice_header-ship_to_gln.</FPCLINE>
      <FPCLINE>* ---&gt; End of insert for D3_OTC_FDD_0014 Def#6737  by U033632</FPCLINE>
      <FPCLINE>            ENDIF. &quot; IF fp_x_invoice_header-ship_to_gln IS INITIAL</FPCLINE>
      <FPCLINE>          ENDIF. &quot; IF NOT &lt;lfs_kna1&gt;-bbsnr IS INITIAL</FPCLINE>
      <FPCLINE>          UNASSIGN &lt;lfs_kna1&gt;.</FPCLINE>
      <FPCLINE>        ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>      ELSE. &quot; ELSE -&gt; IF fp_x_invoice_header-ship_to_kunnr &lt;&gt; fp_x_invoice_header-bill_to_kunnr</FPCLINE>
      <FPCLINE>        CLEAR fp_x_invoice_header-ship_to_gln.</FPCLINE>
      <FPCLINE>      ENDIF. &quot; IF fp_x_invoice_header-ship_to_kunnr &lt;&gt; fp_x_invoice_header-bill_to_kunnr</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF NOT li_vbpa_tmp[] IS INITIAL</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_brvat</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_draft_image</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get the Draft Watermark Image</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;fp_watermark          Draft Image for Watermark</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_draft_image  CHANGING  fp_watermark TYPE xstring.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS: lc_draft_image TYPE tdobname   VALUE &apos;ZOTC_DRAFT&apos;, &quot;Image Name</FPCLINE>
      <FPCLINE>             lc_graphics    TYPE tdobjectgr VALUE &apos;GRAPHICS&apos;,   &quot;Watermark</FPCLINE>
      <FPCLINE>             lc_image_id    TYPE tdidgr     VALUE &apos;BMAP&apos;,       &quot;Watermark: Obj id</FPCLINE>
      <FPCLINE>             lc_image_type  TYPE tdbtype    VALUE &apos;BCOL&apos;.       &quot;Watermark: Obj type</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CALL METHOD cl_ssf_xsf_utilities=&gt;get_bds_graphic_as_bmp</FPCLINE>
      <FPCLINE>    EXPORTING</FPCLINE>
      <FPCLINE>      p_object       = lc_graphics    &quot;value:GRAPHICS</FPCLINE>
      <FPCLINE>      p_name         = lc_draft_image &quot;value:ZOTC_DRAFT</FPCLINE>
      <FPCLINE>      p_id           = lc_image_id    &quot;value:BMAP</FPCLINE>
      <FPCLINE>      p_btype        = lc_image_type  &quot;value:BCOL</FPCLINE>
      <FPCLINE>    RECEIVING</FPCLINE>
      <FPCLINE>      p_bmp          = fp_watermark</FPCLINE>
      <FPCLINE>    EXCEPTIONS</FPCLINE>
      <FPCLINE>      not_found      = 1</FPCLINE>
      <FPCLINE>      internal_error = 2</FPCLINE>
      <FPCLINE>      OTHERS         = 3.</FPCLINE>
      <FPCLINE>  IF sy-subrc NE 0.</FPCLINE>
      <FPCLINE>    CLEAR fp_watermark.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc NE 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>ENDFORM. &quot; F_GET_FORM_IMAGE</FPCLINE>
      <FPCLINE>* ---&gt; End   of Insert for D3_OTC_FDD_0014 D3R2 by U034334</FPCLINE>
      <FPCLINE/>
      <FPCLINE>* ---&gt; Begin of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_contact</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get contact name from Contact partners</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;fp_i_vbpa                  Partner Data</FPCLINE>
      <FPCLINE>*      &lt;--fp_x_invoice_header        Invoice Header</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_contact USING fp_i_vbpa           TYPE ty_t_vbpa</FPCLINE>
      <FPCLINE>                CHANGING fp_x_invoice_header TYPE ty_invoice_header.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  DATA lv_contact_add TYPE adrnr. &quot; Address</FPCLINE>
      <FPCLINE>  CONSTANTS: lc_contact1 TYPE parvw VALUE &apos;AP&apos;, &quot; Partner Function</FPCLINE>
      <FPCLINE>             lc_contact2 TYPE parvw VALUE &apos;ZA&apos;. &quot; Partner Function</FPCLINE>
      <FPCLINE>  FIELD-SYMBOLS &lt;lfs_vbpa&gt; TYPE ty_vbpa.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  READ TABLE fp_i_vbpa ASSIGNING &lt;lfs_vbpa&gt;</FPCLINE>
      <FPCLINE>    WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>             parvw = lc_contact1</FPCLINE>
      <FPCLINE>             BINARY SEARCH.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF sy-subrc EQ 0.</FPCLINE>
      <FPCLINE>    lv_contact_add = &lt;lfs_vbpa&gt;-adrnr.</FPCLINE>
      <FPCLINE>    UNASSIGN &lt;lfs_vbpa&gt;.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE>    READ TABLE fp_i_vbpa ASSIGNING &lt;lfs_vbpa&gt;</FPCLINE>
      <FPCLINE>      WITH KEY vbeln = gv_vbeln</FPCLINE>
      <FPCLINE>               parvw = lc_contact2</FPCLINE>
      <FPCLINE>               BINARY SEARCH.</FPCLINE>
      <FPCLINE>    IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>      lv_contact_add = &lt;lfs_vbpa&gt;-adrnr.</FPCLINE>
      <FPCLINE>      UNASSIGN &lt;lfs_vbpa&gt;.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc EQ 0</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF lv_contact_add IS NOT INITIAL.</FPCLINE>
      <FPCLINE>    SELECT name1 &quot; Name 1</FPCLINE>
      <FPCLINE>      FROM adrc  &quot; Addresses (Business Address Services)</FPCLINE>
      <FPCLINE>        UP TO 1 ROWS</FPCLINE>
      <FPCLINE>      INTO fp_x_invoice_header-contact_name</FPCLINE>
      <FPCLINE>     WHERE addrnumber = lv_contact_add.</FPCLINE>
      <FPCLINE>    ENDSELECT.</FPCLINE>
      <FPCLINE>    IF sy-subrc &lt;&gt; 0.</FPCLINE>
      <FPCLINE>      CLEAR lv_contact_add.</FPCLINE>
      <FPCLINE>    ENDIF. &quot; IF sy-subrc &lt;&gt; 0</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF lv_contact_add IS NOT INITIAL</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_contact</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_cuu_ra</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Determine if we need to print CUU/RA for this invoice</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      --&gt;fp_i_emi_constants         EMI constants table</FPCLINE>
      <FPCLINE>*      --&gt;fp_vkorg                   Sales Organization</FPCLINE>
      <FPCLINE>*      &lt;--fp_cuu_ra_flag             Flag</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_cuu_ra USING fp_i_emi_constants TYPE ty_t_emi_constants</FPCLINE>
      <FPCLINE>                         fp_vkorg          TYPE vkorg &quot; Sales Organization</FPCLINE>
      <FPCLINE>                CHANGING fp_cuu_ra_flag    TYPE flag. &quot; General Flag</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  CONSTANTS lc_vkorg_cuu TYPE z_criteria VALUE &apos;VKORG_CUU_AR&apos;. &quot; Enh. Criteria</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  READ TABLE fp_i_emi_constants TRANSPORTING NO FIELDS</FPCLINE>
      <FPCLINE>    WITH KEY criteria = lc_vkorg_cuu</FPCLINE>
      <FPCLINE>             sel_low  = fp_vkorg.</FPCLINE>
      <FPCLINE>* Small Table therefore Linear Search used instead of Binary Search</FPCLINE>
      <FPCLINE>  IF sy-subrc = 0.</FPCLINE>
      <FPCLINE>    fp_cuu_ra_flag = abap_true.</FPCLINE>
      <FPCLINE>  ELSE. &quot; ELSE -&gt; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>    CLEAR fp_cuu_ra_flag.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc = 0</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_cuu_ra</FPCLINE>
      <FPCLINE/>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*&amp;      Form  f_get_cert_det</FPCLINE>
      <FPCLINE>*&amp;---------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*       Get System Certification Details</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>*      &lt;--fp_sap_rel            SAP Release Version</FPCLINE>
      <FPCLINE>*      &lt;--fp_cert_id            Certificate ID</FPCLINE>
      <FPCLINE>*----------------------------------------------------------------------*</FPCLINE>
      <FPCLINE>FORM f_get_cert_det  CHANGING fp_sap_rel TYPE sipt_prod_version &quot; Signature PT: Certified Product Version</FPCLINE>
      <FPCLINE>                              fp_cert_id TYPE sipt_cert_id.     &quot; Signature PT: Certification ID</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  SELECT prod_version &quot; Signature PT: Certified Product Version</FPCLINE>
      <FPCLINE>         cert_id      &quot; Signature PT: Certification ID</FPCLINE>
      <FPCLINE>    FROM sipt_cert    &quot; Signature PT: Certification Data</FPCLINE>
      <FPCLINE>    UP TO 1 ROWS</FPCLINE>
      <FPCLINE>    INTO (fp_sap_rel,</FPCLINE>
      <FPCLINE>          fp_cert_id)</FPCLINE>
      <FPCLINE>   WHERE cert_todate GE sy-datum.</FPCLINE>
      <FPCLINE>  ENDSELECT.</FPCLINE>
      <FPCLINE/>
      <FPCLINE>  IF sy-subrc &lt;&gt; 0.</FPCLINE>
      <FPCLINE>    CLEAR: fp_sap_rel,</FPCLINE>
      <FPCLINE>           fp_cert_id.</FPCLINE>
      <FPCLINE>  ENDIF. &quot; IF sy-subrc &lt;&gt; 0</FPCLINE>
      <FPCLINE>ENDFORM. &quot;f_get_cert_det</FPCLINE>
      <FPCLINE>* &lt;--- End   of Insert for D3_OTC_FDD_0014 D3R3 by U034334</FPCLINE>
     </FORMS>
    </CL_FP_CODING>
   </cls:CL_FP_CODING>
  </asx:heap>
 </asx:abap>
</abapGit>
